<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ringkasan Presensi Harian 3 Hari Terakhir</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3ff6;
    }
    /* Mengatur tabel di dalam grup agar memiliki scroll horizontal jika terlalu sempit */
    .table-responsive {
        overflow-x: auto;
    }
    .date-header {
        background-color: #e5e7eb; /* Warna abu-abu yang lebih menonjol */
        position: sticky;
        top: 0;
        z-index: 10;
    }
  </style>
  <script>
    // Konfigurasi warna khusus Tailwind
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary-blue': '#1e3a8a', 
            'success-green': '#10b981',
            'error-red': '#ef4444',
          }
        }
      }
    }
  </script>
</head>
<body class="p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl p-6 sm:p-8">

    <div class="flex justify-between items-center mb-6 border-b pb-4">
        <h1 class="text-2xl font-extrabold text-gray-900">Ringkasan Presensi 3 Hari Terakhir</h1>
        <a href="index.html" class="inline-flex items-center text-primary-blue hover:text-blue-700 transition-colors duration-200 font-medium text-sm">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            Kembali ke Beranda
        </a>
    </div>
    
    <!-- Status Penghapusan Otomatis -->
    <div id="deletion-status" class="text-xs text-gray-500 mb-4 p-2 bg-yellow-50 rounded-lg hidden">
        <span class="font-medium text-yellow-700">Pemberitahuan:</span> Log presensi dan foto yang berusia lebih dari 3 hari sedang diperiksa dan dihapus secara otomatis.
        <!-- Baris ini dipertahankan sebagai pengingat -->
        <p class="text-xs mt-1">
            <strong class="text-red-600">Penting:</strong> Fitur foto dinonaktifkan karena kolom 'photo_path' belum ada di tabel 'log_absen'. Harap tambahkan kolom tersebut untuk mengaktifkan tampilan dan penghapusan foto otomatis.
        </p>
    </div>

    <!-- Status Loading -->
    <div id="loading-status" class="flex items-center justify-center p-8 text-primary-blue font-medium">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        Memuat data log presensi (3 hari terakhir)...
    </div>

    <!-- RINGKASAN PRESENSI PER TANGGAL -->
    <h2 class="text-xl font-bold text-gray-800 mb-4 mt-8 border-t pt-4">Ringkasan Harian (Keberhasilan & Kegagalan Tapping)</h2>
    
    <!-- Container utama untuk semua ringkasan harian yang dikelompokkan -->
    <div class="space-y-8" id="grouped-logs-container">
        <!-- Grup harian (Header + Ringkasan) akan dimasukkan di sini oleh JavaScript -->
        <div id="no-data-message" class="text-center p-4 text-gray-500 hidden">
            Tidak ada log presensi ditemukan dalam 3 hari terakhir.
        </div>
    </div>
  </div>

<script>
    // ===================================
    // KONFIGURASI SUPABASE & DOM ELEMENTS
    // ===================================
    const SUPABASE_URL = "https://ymzcvyumplerqccaplxi.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltemN2eXVtcGxlcnFjY2FwbHhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNjk3ODUsImV4cCI6MjA3ODY0NTc4NX0.XtX9NMHp3gINRP3zSA-PnC73tiI4vPVcB4D2A13c1TI";
    const BUCKET_NAME = "presensi_photos"; 

    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);

    // DOM Elements
    const groupedLogsContainer = document.getElementById('grouped-logs-container');
    const loadingStatus = document.getElementById('loading-status');
    const noDataMessage = document.getElementById('no-data-message');
    const deletionStatus = document.getElementById('deletion-status');
    
    // Konfigurasi default diubah: rangeDays ditetapkan 3 hari
    const DEFAULT_RANGE_DAYS = 3;
    const PERIODES = ['pagi', 'siang', 'sore', 'malam'];

    // ===================================
    // UTILITY FUNCTIONS
    // ===================================
    
    /**
     * Mendapatkan string tanggal (YYYY-MM-DD) dari timestamp untuk grouping.
     */
    function getUtcDateString(timestamp) {
        if (!timestamp) return 'Tanggal Tidak Diketahui';
        const date = new Date(timestamp);
        // Menggunakan ISO string dan memisahkannya untuk mendapatkan YYYY-MM-DD
        return date.toISOString().split('T')[0];
    }

    /**
     * Mengubah string tanggal YYYY-MM-DD menjadi format yang mudah dibaca.
     */
    function formatReadableDate(dateString) {
        const date = new Date(dateString + 'T00:00:00Z'); // Anggap sebagai UTC tengah malam
        return date.toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
    }

    // ===================================
    // LOGIC PENGHAPUSAN OTOMATIS (3 HARI)
    // ===================================

    // Logika ini dipertahankan
    async function deleteOldLogsAndPhotos() {
        deletionStatus.classList.remove('hidden');

        const limitDays = 3; 
        const threeDaysAgo = new Date();
        threeDaysAgo.setDate(threeDaysAgo.getDate() - limitDays);
        const cutoffDate = threeDaysAgo.toISOString();
        
        try {
            const { data: oldLogs, error: fetchError } = await db
                .from("log_absen")
                .select("id") 
                .lt("created_at", cutoffDate);

            if (fetchError) throw fetchError;
            
            if (oldLogs.length === 0) {
                // Tidak ada log lama, sembunyikan notifikasi setelah beberapa saat
                setTimeout(() => { deletionStatus.classList.add('hidden'); }, 1000);
                return;
            }

            const logIdsToDelete = oldLogs.map(log => log.id);

            const { error: deleteLogError } = await db
                .from("log_absen")
                .delete()
                .in('id', logIdsToDelete);

            if (deleteLogError) throw deleteLogError;
            
        } catch (e) {
            console.error("Gagal menjalankan penghapusan log (non-critical):", e); 
        } finally {
            // Sembunyikan notifikasi setelah proses selesai
            setTimeout(() => {
                deletionStatus.classList.add('hidden');
            }, 5000);
        }
    }

    // ===================================
    // LOGIC AGGREGASI & RENDER UTAMA
    // ===================================

    /**
     * Memproses data log untuk menghasilkan ringkasan statistik per periode per hari.
     * Dihitung: Sukses, Gagal, dan TotalLog (Sukses + Gagal).
     */
    function aggregateDailyLogs(logs) {
        const summary = {};
        // Inisialisasi Total Harian
        const overallTotal = { Sukses: 0, Gagal: 0, TotalLog: 0 }; 

        PERIODES.forEach(p => {
            // Inisialisasi per periode
            summary[p] = { Sukses: 0, Gagal: 0 }; 
        });

        logs.forEach(log => {
            const periode = log.periode.toLowerCase();
            const status = log.status; 
            
            if (summary[periode]) {
                if (status === 'Sukses') {
                    summary[periode].Sukses += 1;
                    overallTotal.Sukses += 1;
                } else if (status === 'Gagal') {
                    // Penambahan Gagal
                    summary[periode].Gagal += 1;
                    overallTotal.Gagal += 1;
                }
            }
            overallTotal.TotalLog += 1; 
        });

        return { summary, overallTotal };
    }

    /**
     * Merender tabel ringkasan harian (summary) untuk satu tanggal.
     * Sekarang menampilkan Sukses dan Gagal.
     */
    function renderDailySummaryTable(aggregatedData) {
        const { summary, overallTotal } = aggregatedData;
        
        // Membangun body tabel ringkasan harian
        let summaryRows = '';
        PERIODES.forEach(p => {
            const data = summary[p];
            summaryRows += `
                <tr class="hover:bg-gray-50 capitalize">
                    <td class="px-6 py-3 text-left font-semibold text-gray-700">${p}</td>
                    <td class="px-6 py-3 text-center text-lg text-success-green font-bold">${data.Sukses}</td>
                    <td class="px-6 py-3 text-center text-lg text-error-red font-bold">${data.Gagal}</td>
                    <td class="px-6 py-3 text-center text-lg text-primary-blue font-bold">${data.Sukses + data.Gagal}</td>
                </tr>
            `;
        });

        // Membangun footer tabel ringkasan harian
        const footerRow = `
            <tr class="bg-primary-blue/10 font-extrabold border-t-2 border-primary-blue">
                <td class="px-6 py-3 text-left text-sm text-primary-blue uppercase">TOTAL HARIAN</td>
                <td class="px-6 py-3 text-center text-lg text-success-green">${overallTotal.Sukses}</td>
                <td class="px-6 py-3 text-center text-lg text-error-red">${overallTotal.Gagal}</td>
                <td class="px-6 py-3 text-center text-lg text-primary-blue">${overallTotal.Sukses + overallTotal.Gagal}</td>
            </tr>
        `;

        // Menggabungkan menjadi tabel lengkap
        const summaryTableHtml = `
            <div class="table-responsive shadow-md rounded-xl mt-4">
                <table class="min-w-full divide-y divide-gray-200">
                    <thead class="bg-gray-100">
                        <tr>
                            <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                                Periode Presensi
                            </th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-success-green uppercase tracking-wider">
                                Sukses
                            </th>
                            <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-error-red uppercase tracking-wider">
                                Gagal
                            </th>
                             <th scope="col" class="px-6 py-3 text-center text-xs font-medium text-primary-blue uppercase tracking-wider">
                                Total
                            </th>
                        </tr>
                    </thead>
                    <tbody class="bg-white divide-y divide-gray-200">
                        ${summaryRows}
                    </tbody>
                    <tfoot>
                        ${footerRow}
                    </tfoot>
                </table>
                <p class="text-xs text-gray-400 p-2 text-right">*Total Log Tapping (Sukses & Gagal) pada hari ini: ${overallTotal.TotalLog}</p>
            </div>
        `;
        return summaryTableHtml;
    }

    /**
     * Mengelompokkan log berdasarkan tanggal.
     */
    function groupLogsByDate(logs) {
        const groups = {};
        logs.forEach(log => {
            const dateKey = getUtcDateString(log.created_at);
            if (!groups[dateKey]) {
                groups[dateKey] = [];
            }
            groups[dateKey].push(log);
        });
        return groups;
    }

    /**
     * Merender data ringkasan, dengan pengelompokan per tanggal.
     */
    function renderGroupedLogs(groupedLogs) {
        groupedLogsContainer.innerHTML = '';
        // Urutkan tanggal dari yang terbaru ke yang terlama
        const dateKeys = Object.keys(groupedLogs).sort().reverse(); 

        if (dateKeys.length === 0) {
            noDataMessage.textContent = `Tidak ada log presensi ditemukan dalam ${DEFAULT_RANGE_DAYS} hari terakhir.`;
            noDataMessage.classList.remove('hidden');
            return;
        }

        noDataMessage.classList.add('hidden');
        
        // Hanya tampilkan data untuk 3 hari pertama (terbaru)
        dateKeys.slice(0, DEFAULT_RANGE_DAYS).forEach(dateKey => {
            const logs = groupedLogs[dateKey];
            const readableDate = formatReadableDate(dateKey);

            // 1. Agregasi untuk tanggal ini
            const aggregatedData = aggregateDailyLogs(logs);

            // 2. Render Header Tanggal
            let html = `
                <div class="date-group border border-gray-200 rounded-xl shadow-lg">
                    <div class="date-header p-4 rounded-t-xl border-b border-gray-300">
                        <h3 class="text-xl font-extrabold text-primary-blue">${readableDate}</h3>
                    </div>
            `;
            
            // 3. Render Ringkasan Harian
            html += renderDailySummaryTable(aggregatedData);

            html += `</div>`; // Tutup date-group
            groupedLogsContainer.innerHTML += html;
        });
    }

    /**
     * Mengambil semua log dalam rentang 3 hari terakhir.
     */
    async function fetchLogs() {
        loadingStatus.classList.remove('hidden');
        groupedLogsContainer.innerHTML = '';
        noDataMessage.classList.add('hidden');

        // Tentukan batas waktu (3 hari terakhir)
        const dateStart = new Date();
        dateStart.setDate(dateStart.getDate() - DEFAULT_RANGE_DAYS);
        const cutoffDate = dateStart.toISOString(); 

        try {
            // Ambil SEMUA data log dalam rentang waktu yang ditetapkan
            let query = db
                .from("log_absen")
                // Hanya ambil kolom yang diperlukan untuk agregasi
                .select("periode, status, created_at") 
                .order("created_at", { ascending: false }) 
                .gte("created_at", cutoffDate);
                
            const { data: rawLogs, error: rawError } = await query;

            if (rawError) throw rawError;
            
            if (rawLogs.length === 0) {
                loadingStatus.classList.add('hidden');
                noDataMessage.textContent = `Tidak ada log presensi ditemukan dalam ${DEFAULT_RANGE_DAYS} hari terakhir.`;
                noDataMessage.classList.remove('hidden');
                return;
            }

            // Kelompokkan log berdasarkan Tanggal (tidak ada filter tambahan)
            const groupedLogs = groupLogsByDate(rawLogs);

            // Render Log yang Dikelompokkan (Ringkasan Harian 3 hari terbaru)
            renderGroupedLogs(groupedLogs);


        } catch (e) {
            console.error("Gagal mengambil data log:", e);
            noDataMessage.textContent = 'Gagal memuat data dari server.';
            noDataMessage.classList.remove('hidden');
        } finally {
            loadingStatus.classList.add('hidden');
        }
    }

    // ===================================
    // INITIALISASI
    // ===================================
    window.onload = () => {
        // 1. Jalankan penghapusan log dan foto lama
        deleteOldLogsAndPhotos(); 
        
        // 2. Ambil data pertama kali saat halaman dimuat
        fetchLogs(); 

        // Tidak ada event listener karena filter dihapus
    };

</script>
</body>
</html>
