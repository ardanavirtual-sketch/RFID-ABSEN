<!DOCTYPE html>
<html lang="id">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Detail Log Presensi Harian</title>
  
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  
  <style>
    body {
      font-family: 'Inter', sans-serif;
      background-color: #f3f4f6;
    }
    .status-badge {
        padding: 0.25rem 0.75rem;
        border-radius: 9999px;
        font-weight: 600;
        font-size: 0.75rem;
        text-transform: uppercase;
        display: inline-block;
    }
    .table-container {
        max-height: 70vh; /* Batasi tinggi tabel untuk scroll */
        overflow-y: auto;
    }
  </style>
  <script>
    // Konfigurasi warna khusus Tailwind
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            'primary-blue': '#1e3a8a', 
            'success-green': '#10b981',
            'error-red': '#ef4444',
          }
        }
      }
    }
  </script>
</head>
<body class="p-4 sm:p-8">

  <div class="max-w-4xl mx-auto bg-white rounded-3xl shadow-2xl p-6 sm:p-8">

    <div class="flex justify-between items-center mb-6 border-b pb-4">
        <h1 class="text-2xl font-extrabold text-gray-900">Detail Log Presensi</h1>
        <a href="index.html" class="inline-flex items-center text-primary-blue hover:text-blue-700 transition-colors duration-200 font-medium text-sm">
            <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"></path></svg>
            Kembali ke Beranda
        </a>
    </div>

    <!-- Filter dan Kontrol -->
    <div class="flex flex-col sm:flex-row gap-4 mb-6">
        <select id="filter-periode" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue w-full sm:w-1/3 text-sm">
            <option value="">Semua Periode</option>
            <option value="pagi">Pagi</option>
            <option value="siang">Siang</option>
            <option value="sore">Sore</option>
            <option value="malam">Malam</option>
        </select>

        <select id="filter-status" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue w-full sm:w-1/3 text-sm">
            <option value="">Semua Status</option>
            <option value="Sukses">Sukses</option>
            <option value="Gagal">Gagal</option>
        </select>
        
        <!-- Input Tanggal (untuk tujuan demonstrasi, ini diset default ke hari ini) -->
        <input type="date" id="filter-date" class="p-2 border border-gray-300 rounded-lg shadow-sm focus:ring-primary-blue focus:border-primary-blue w-full sm:w-1/3 text-sm">
    </div>

    <!-- Status Loading -->
    <div id="loading-status" class="flex items-center justify-center p-8 text-primary-blue font-medium">
        <svg class="animate-spin -ml-1 mr-3 h-5 w-5" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        Memuat data log presensi...
    </div>

    <!-- Tabel Log Absen -->
    <div class="table-container shadow-md rounded-xl hidden" id="log-table-container">
        <table class="min-w-full divide-y divide-gray-200">
            <thead class="bg-gray-50 sticky top-0">
                <tr>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Waktu
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Nama Karyawan
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Periode
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        Status
                    </th>
                    <th scope="col" class="px-6 py-3 text-left text-xs font-medium text-gray-500 uppercase tracking-wider">
                        ID Kartu
                    </th>
                </tr>
            </thead>
            <tbody id="log-body" class="bg-white divide-y divide-gray-200">
                <!-- Data akan dimasukkan di sini oleh JavaScript -->
            </tbody>
        </table>
        <div id="no-data-message" class="text-center p-4 text-gray-500 hidden">
            Tidak ada log presensi ditemukan untuk filter ini.
        </div>
    </div>
  </div>

<script>
    // ===================================
    // KONFIGURASI SUPABASE & UTILITY
    // ===================================
    const SUPABASE_URL = "https://ymzcvyumplerqccaplxi.supabase.co";
    const SUPABASE_KEY = "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltemN2eXVtcGxlcnFjY2FwbHhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNjk3ODUsImV4cCI6MjA3ODY0NTc4NX0.XtX9NMHp3gINRP3zSA-PnC73tiI4vPVcB4D2A13c1TI";

    const { createClient } = supabase;
    const db = createClient(SUPABASE_URL, SUPABASE_KEY);

    const logBody = document.getElementById('log-body');
    const loadingStatus = document.getElementById('loading-status');
    const logTableContainer = document.getElementById('log-table-container');
    const noDataMessage = document.getElementById('no-data-message');
    const filterPeriode = document.getElementById('filter-periode');
    const filterStatus = document.getElementById('filter-status');
    const filterDate = document.getElementById('filter-date');
    
    /**
     * Mengubah format waktu UTC+0 dari Supabase menjadi waktu lokal yang mudah dibaca.
     */
    function formatSupabaseTime(timestamp) {
        if (!timestamp) return '-';
        const date = new Date(timestamp);
        
        // Opsi format waktu lokal (sesuaikan dengan zona waktu yang diinginkan, misal: WIT)
        const options = {
            year: 'numeric', month: 'short', day: 'numeric',
            hour: '2-digit', minute: '2-digit', second: '2-digit',
            hour12: false,
            timeZoneName: 'short' // Akan menampilkan zona waktu browser lokal
        };
        return date.toLocaleTimeString('id-ID', options);
    }
    
    /**
     * Mendapatkan string tanggal hari ini (YYYY-MM-DD),
     * disesuaikan agar hari baru (untuk tujuan presensi) dimulai pada pukul 01:00.
     * Logika ini harus konsisten dengan app.js
     */
    function getTodayDateString() {
        const now = new Date();
        const currentHour = now.getHours();
        const RESET_HOUR = 1; 

        // Jika jam saat ini kurang dari 01:00 (RESET_HOUR), 
        // secara logis presensi kita masih berada di hari sebelumnya.
        if (currentHour < RESET_HOUR) {
            now.setDate(now.getDate() - 1);
        }
        
        // Format tanggal menjadi YYYY-MM-DD (contoh: 2025-12-09)
        return now.toISOString().split('T')[0];
    }
    
    // Set default tanggal filter ke tanggal logis hari ini
    filterDate.value = getTodayDateString();


    // ===================================
    // LOGIC AMBIL DATA & RENDER
    // ===================================
    
    /**
     * Mengambil data log dari Supabase berdasarkan filter.
     */
    async function fetchLogs() {
        loadingStatus.classList.remove('hidden');
        logTableContainer.classList.add('hidden');
        noDataMessage.classList.add('hidden');
        logBody.innerHTML = ''; 

        const selectedPeriod = filterPeriode.value;
        const selectedStatus = filterStatus.value;
        const selectedDate = filterDate.value;
        
        // Tentukan rentang waktu untuk Supabase
        // Supabase menggunakan UTC, jadi kita gunakan tanggal yang dipilih untuk rentang waktu 00:00:00 - 23:59:59 UTC
        // Untuk mengatasi perbedaan zona waktu, kita akan mengambil log dari tanggal yang dipilih.
        
        const dateStart = `${selectedDate}T00:00:00Z`; // Mulai hari yang dipilih, 00:00:00 UTC
        // Ambil hari berikutnya untuk batas akhir
        const nextDay = new Date(selectedDate);
        nextDay.setDate(nextDay.getDate() + 1);
        const nextDayString = nextDay.toISOString().split('T')[0];
        const dateEnd = `${nextDayString}T00:00:00Z`; // Sampai hari berikutnya, 00:00:00 UTC

        try {
            let query = db
                .from("log_absen")
                .select("nama, card, periode, status, created_at")
                .order("created_at", { ascending: false }) // Log terbaru di atas
                .gte("created_at", dateStart)
                .lt("created_at", dateEnd);
                
            // Terapkan filter periode
            if (selectedPeriod) {
                query = query.eq("periode", selectedPeriod);
            }

            // Terapkan filter status
            if (selectedStatus) {
                query = query.eq("status", selectedStatus);
            }

            const { data: logs, error } = await query;

            if (error) throw error;

            renderLogs(logs);

        } catch (e) {
            console.error("Gagal mengambil data log:", e);
            logTableContainer.classList.add('hidden');
            noDataMessage.textContent = 'Gagal memuat data dari server.';
            noDataMessage.classList.remove('hidden');
        } finally {
            loadingStatus.classList.add('hidden');
        }
    }
    
    /**
     * Merender data log ke dalam tabel.
     */
    function renderLogs(logs) {
        logBody.innerHTML = '';
        
        if (logs.length === 0) {
            logTableContainer.classList.add('hidden');
            noDataMessage.textContent = 'Tidak ada log presensi ditemukan untuk filter ini.';
            noDataMessage.classList.remove('hidden');
            return;
        }

        logs.forEach(log => {
            const isSuccess = log.status === 'Sukses';
            const statusColor = isSuccess ? 'bg-success-green/10 text-success-green' : 'bg-error-red/10 text-error-red';
            
            const row = `
                <tr>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500">
                        ${formatSupabaseTime(log.created_at)}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm font-medium text-gray-900">
                        ${log.nama}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-sm text-gray-500 capitalize">
                        ${log.periode}
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap">
                        <span class="status-badge ${statusColor}">
                            ${log.status}
                        </span>
                    </td>
                    <td class="px-6 py-4 whitespace-nowrap text-xs text-gray-400">
                        ${log.card}
                    </td>
                </tr>
            `;
            logBody.innerHTML += row;
        });
        
        logTableContainer.classList.remove('hidden');
        noDataMessage.classList.add('hidden');
    }

    // ===================================
    // INITIALISASI DAN LISTENER
    // ===================================
    window.onload = () => {
        // Ambil data pertama kali saat halaman dimuat
        fetchLogs(); 

        // Tambahkan event listener untuk filter
        filterPeriode.addEventListener('change', fetchLogs);
        filterStatus.addEventListener('change', fetchLogs);
        filterDate.addEventListener('change', fetchLogs);
    };

</script>
</body>
</html>
