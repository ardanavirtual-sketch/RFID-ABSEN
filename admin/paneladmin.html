<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Sistem Absensi</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Custom styles for Soft Dark Theme */
        body { 
            font-family: 'Inter', sans-serif; 
            background-color: #1f2937; /* Soft Dark Background */
            color: #d1d5db; /* Light Gray Text */
        }
        .container-panel { 
            background-color: #374151; /* Lighter Dark for Panels/Cards */
            border-radius: 0.75rem;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2), 0 4px 6px -2px rgba(0, 0, 0, 0.08);
        }
        .admin-table th, .admin-table td { padding: 10px; text-align: left; border-bottom: 1px solid #4b5563; /* Darker border */ }
        .admin-table th { 
            background-color: #111827; /* Darker header */
            color: white; 
            position: sticky; 
            top: 0; 
        }
        .review-table th, .review-table td { padding: 8px; font-size: 0.8rem; white-space: nowrap; }
        .review-table th { background-color: #374151; }
        .tab-active-menu { 
            background-color: #4f46e5; /* Indigo 600 */
            color: white;
            font-weight: bold;
        }
        .text-success-green { color: #34d399; } /* Lighter Green */
        .text-error-red { color: #f87171; } /* Lighter Red */

        /* Style for Collapsible Log Item (Mirroring the image) */
        .log-date-header {
            background-color: #10b981; /* Green 500/600 */
            color: white;
            padding: 12px 20px;
            cursor: pointer;
            display: flex;
            justify-content: space-between;
            align-items: center;
            font-weight: 600;
            border-radius: 0.5rem;
            margin-bottom: 8px;
            transition: background-color 0.2s;
        }
        .log-date-header:hover {
            background-color: #059669; /* Darker Green on Hover */
        }
        .log-content {
            background-color: #374151;
            padding: 1rem;
            border-radius: 0.5rem;
            margin-top: -8px; 
            margin-bottom: 16px;
        }
    </style>
</head>
<body>

    <div id="admin-app" class="min-h-screen flex">
        
        <nav class="w-64 bg-gray-900 shadow-xl p-4 flex flex-col space-y-4">
            <h1 class="text-2xl font-bold text-indigo-400 mb-6 border-b border-gray-700 pb-4">
                <i class="fas fa-tachometer-alt"></i> ABSENSI PANEL
            </h1>
            
            <button id="menu-dashboard" onclick="switchView('dashboard')" 
                    class="py-3 px-4 text-left text-gray-300 rounded-lg hover:bg-gray-800 transition duration-150 tab-active-menu">
                <i class="fas fa-home mr-3"></i> Dashboard Utama
            </button>
            
            <button id="menu-data-karyawan" onclick="switchView('data-karyawan')" 
                    class="py-3 px-4 text-left text-gray-300 rounded-lg hover:bg-gray-800 transition duration-150">
                <i class="fas fa-users mr-3"></i> Data Karyawan
            </button>

            <button id="menu-laporan-absen" onclick="switchView('laporan-absen')" 
                    class="py-3 px-4 text-left text-gray-300 rounded-lg hover:bg-gray-800 transition duration-150">
                <i class="fas fa-clipboard-list mr-3"></i> Laporan Log Absensi
            </button>
            
            <div class="flex-grow"></div> 

            <button id="logout-button" onclick="handleLogout()" 
                    class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold text-sm hover:bg-red-700 transition duration-300">
                <i class="fas fa-sign-out-alt mr-2"></i> Keluar (Logout)
            </button>
        </nav>

        <div class="flex-1 p-6 space-y-6">
            <header class="flex justify-between items-center pb-4 border-b border-gray-700">
                <h1 id="view-title" class="text-3xl font-extrabold text-gray-100">Dashboard Utama</h1>
                <div id="global-message" class="p-2 rounded-lg text-center font-medium hidden"></div>
            </header>

            <div id="dashboard-view" class="w-full">
                <div class="container-panel p-6 shadow-2xl">
                    <h2 class="text-2xl font-bold mb-4 text-gray-200">Ringkasan Sistem</h2>
                    <p class="text-gray-400">Selamat datang kembali di Panel Administrasi Sistem Absensi.</p>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mt-6">
                        <div class="bg-gray-800 p-5 rounded-lg border-l-4 border-indigo-500 shadow-md">
                            <p class="text-sm font-medium text-indigo-400">Total Karyawan Terdaftar</p>
                            <p id="total-karyawan" class="text-3xl font-bold mt-1 text-white">...</p>
                        </div>
                        <div class="bg-gray-800 p-5 rounded-lg border-l-4 border-green-500 shadow-md">
                            <p class="text-sm font-medium text-green-400">Total Log Absensi (Arsip)</p>
                            <p id="total-logs" class="text-3xl font-bold mt-1 text-white">...</p>
                        </div>
                        <div class="bg-gray-800 p-5 rounded-lg border-l-4 border-yellow-500 shadow-md">
                            <p class="text-sm font-medium text-yellow-400">Log Absensi Terbaru</p>
                            <p id="latest-log" class="text-lg font-semibold mt-1 text-white">Memuat...</p>
                        </div>
                    </div>
                </div>
            </div>

            <div id="data-karyawan-view" class="w-full hidden">
                <div class="container-panel p-6 shadow-2xl">
                    <div class="flex flex-col sm:flex-row justify-between items-center mb-6 space-y-4 sm:space-y-0">
                        <h2 class="text-3xl font-extrabold text-gray-200"> DATA VENDOR </h2>
                        <div class="flex space-x-3">
                            <button onclick="openImportModal()" class="bg-blue-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-blue-700 transition duration-300">
                                Import Data Absensi
                            </button>
                            <button onclick="openFormModal('create')" class="bg-green-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-green-700 transition duration-300">
                                + Tambah Karyawan Baru
                            </button>
                        </div>
                    </div>

                    <div class="flex space-x-2 mb-4">
                        <input type="text" id="search-card" placeholder="Cari Card ID..." 
                               class="p-2 border border-gray-600 bg-gray-600 text-gray-200 rounded-lg flex-1 focus:ring-indigo-500 focus:border-indigo-500"
                               onkeypress="if(event.key === 'Enter') applySearchFilter()">
                        <input type="text" id="search-nama" placeholder="Cari Nama..." 
                               class="p-2 border border-gray-600 bg-gray-600 text-gray-200 rounded-lg flex-1 focus:ring-indigo-500 focus:border-indigo-500"
                               onkeypress="if(event.key === 'Enter') applySearchFilter()">
                        <button onclick="applySearchFilter()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-300">
                            Cari
                        </button>
                        <button onclick="clearSearchFilter()" class="bg-gray-500 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-600 transition duration-300">
                            Reset
                        </button>
                    </div>
                    
                    <div class="overflow-x-auto relative shadow-md sm:rounded-lg mt-4 max-h-[70vh]">
                        <table class="w-full text-sm text-left text-gray-300 admin-table">
                            <thead class="text-xs uppercase text-white">
                                <tr>
                                    <th>Card ID</th>
                                    <th>NIK</th>
                                    <th>Nama</th>
                                    <th>Departemen</th>
                                    <th>Pagi</th>
                                    <th>Siang</th>
                                    <th>Sore</th>
                                    <th>Malam</th>
                                    <th>Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body" class="divide-y divide-gray-600 bg-gray-700">
                            </tbody>
                        </table>
                    </div>

                    <div id="no-data-message" class="text-center py-10 text-gray-400 hidden">
                        Belum ada data karyawan yang tersimpan.
                    </div>
                </div>
            </div>
            
            <div id="laporan-absen-view" class="w-full hidden">
                <div class="container-panel p-6 shadow-2xl">
                    <div class="flex justify-between items-center mb-6 border-b border-gray-600 pb-2">
                        <h2 class="text-3xl font-extrabold text-gray-200">Laporan Log Absensi (Arsip Harian)</h2>
                        <button id="refresh-log-button" onclick="loadArchivedAbsensiLog()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-300">
                            Refresh Data
                        </button>
                    </div>

                    <p class="text-sm text-gray-400 mb-4">Log tap kartu dikelompokkan berdasarkan tanggal. Klik tanggal untuk melihat detail.</p>

                    <div id="log-group-container" class="space-y-4">
                        <p class="py-4 text-center text-gray-400">Memuat log absensi...</p>
                    </div>

                </div>
            </div>

        </div>
    </div>

    <div id="import-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="container-panel rounded-xl p-6 w-11/12 max-w-4xl transform transition-all duration-300 scale-95 opacity-0" id="import-content">
            <h3 class="text-2xl font-bold text-gray-200 mb-4">Import Data Absensi Harian (Sinkronisasi Penuh)</h3>
            
            <form id="import-form">
                <div id="step-upload">
                    <p class="text-sm text-gray-400 mb-4">Unggah file Excel (.xlsx atau .xls) yang berisi **SEMUA** data karyawan yang saat ini aktif.</p>
                    <p class="text-xs text-red-400 mb-4 font-semibold p-2 bg-gray-800 rounded-lg">
                        **PENTING: Data di database akan disinkronkan dengan file ini.**
                        <br>Kolom: <code class="font-mono text-xs bg-gray-700 p-1 rounded">Card ID, NIK, Nama, Departemen, Pagi, Siang, Sore, Malam</code>.
                        <br>Karyawan di database yang tidak ada di file Excel ini akan **dihapus/dinonaktifkan**.
                    </p>
                    <div class="mb-4">
                        <label for="excel-file-input" class="block text-sm font-medium text-gray-300">Pilih File Excel:</label>
                        <input type="file" id="excel-file-input" accept=".xlsx, .xls" required 
                            class="mt-1 p-3 w-full border border-gray-600 bg-gray-600 text-gray-200 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                    </div>
                </div>

                <div id="step-review" class="hidden">
                    <h4 class="text-xl font-bold text-gray-200 mb-3">Review Data yang Akan Diproses</h4>
                    <div class="overflow-x-auto max-h-80 border border-gray-600 rounded-lg p-2 bg-gray-800">
                        <table class="w-full text-left review-table text-gray-300">
                            <thead class="sticky top-0 bg-gray-700">
                                <tr>
                                    <th class="w-1/12">Card ID</th>
                                    <th class="w-1/12">NIK</th>
                                    <th class="w-2/12">Nama</th>
                                    <th class="w-2/12">Departemen</th>
                                    <th class="w-1/12 text-blue-400">Pagi</th>
                                    <th class="w-1/12 text-blue-400">Siang</th>
                                    <th class="w-1/12 text-blue-400">Sore</th>
                                    <th class="w-1/12 text-blue-400">Malam</th>
                                    <th class="w-1/12">Status</th>
                                </tr>
                            </thead>
                            <tbody id="review-table-body" class="divide-y divide-gray-600">
                                </tbody>
                        </table>
                    </div>
                    <p id="review-summary" class="text-sm mt-3 text-gray-300 font-medium"></p>
                    <p id="deletion-warning" class="text-sm text-red-400 font-semibold mt-2 hidden">⚠️ Peringatan: Proses ini akan menghapus data karyawan yang tidak ada di file Excel ini.</p>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeImportModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-150">Batal</button>
                    <button type="button" id="review-button" onclick="parseExcelFile()" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150">Review Data</button>
                    <button type="submit" id="import-submit-button" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150 hidden" disabled>Sinkronisasi & Hapus Inaktif</button>
                </div>
            </form>
        </div>
    </div>

    <div id="form-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="container-panel rounded-xl p-6 w-11/12 max-w-lg transform transition-all duration-300 scale-95 opacity-0" id="form-content">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-200 mb-4">Tambah Karyawan Baru</h3>
            <form id="crud-form">
                <div class="mb-4">
                    <label for="form-card" class="block text-sm font-medium text-gray-300">Card ID</label>
                    <input type="text" id="form-card" required class="mt-1 p-3 w-full border border-gray-600 bg-gray-600 text-gray-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-4">
                    <label for="form-nik" class="block text-sm font-medium text-gray-300">NIK</label>
                    <input type="text" id="form-nik" required class="mt-1 p-3 w-full border border-gray-600 bg-gray-600 text-gray-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-4">
                    <label for="form-nama" class="block text-sm font-medium text-gray-300">Nama</label>
                    <input type="text" id="form-nama" required class="mt-1 p-3 w-full border border-gray-600 bg-gray-600 text-gray-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
                <div class="mb-6">
                    <label for="form-departemen" class="block text-sm font-medium text-gray-300">Departemen</label>
                    <input type="text" id="form-departemen" required class="mt-1 p-3 w-full border border-gray-600 bg-gray-600 text-gray-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>

                <div class="border-t border-gray-600 my-6"></div>
                <h4 class="text-xl font-bold text-gray-200 mb-4">Data Absensi/Makan</h4>
                
                <div class="mb-4">
                    <label for="form-pagi" class="block text-sm font-medium text-gray-300">Pagi</label>
                    <input type="text" id="form-pagi" class="mt-1 p-3 w-full border border-gray-600 bg-gray-600 text-gray-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Contoh: Kantin atau kosong">
                </div>
                <div class="mb-4">
                    <label for="form-siang" class="block text-sm font-medium text-gray-300">Siang</label>
                    <input type="text" id="form-siang" class="mt-1 p-3 w-full border border-gray-600 bg-gray-600 text-gray-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Contoh: Kantin atau kosong">
                </div>
                <div class="mb-4">
                    <label for="form-sore" class="block text-sm font-medium text-gray-300">Sore</label>
                    <input type="text" id="form-sore" class="mt-1 p-3 w-full border border-gray-600 bg-gray-600 text-gray-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Contoh: Kantin atau kosong">
                </div>
                <div class="mb-6">
                    <label for="form-malam" class="block text-sm font-medium text-gray-300">Malam</label>
                    <input type="text" id="form-malam" class="mt-1 p-3 w-full border border-gray-600 bg-gray-600 text-gray-200 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Contoh: Kantin atau kosong">
                </div>
                
                <div class="flex justify-end space-x-3">
                    <button type="button" onclick="closeFormModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-150">Batal</button>
                    <button type="submit" id="submit-button" class="px-4 py-2 bg-indigo-600 text-white rounded-lg hover:bg-indigo-700 transition duration-150">Simpan</button>
                </div>
            </form>
        </div>
    </div>

    <div id="delete-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="container-panel rounded-xl p-6 w-11/12 max-w-md transform transition-all duration-300 scale-95 opacity-0" id="delete-content">
            <h3 class="text-2xl font-bold text-red-500 mb-4">Konfirmasi Penghapusan</h3>
            <p class="text-gray-300 mb-6">Anda yakin ingin menghapus data karyawan dengan Card ID: <span id="delete-card-id" class="font-bold"></span>?</p>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-500 text-white rounded-lg hover:bg-gray-600 transition duration-150">Batal</button>
                <button type="button" onclick="executeDelete()" class="px-4 py-2 bg-red-600 text-white rounded-lg hover:bg-red-700 transition duration-150">Hapus</button>
            </div>
        </div>
    </div>


    <script>
        // --- 1. KONFIGURASI SUPABASE ---
        const SUPABASE_URL = 'https://ymzcvyumplerqccaplxi.supabase.co'; 
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltemN2eXVtcGxlcnFjY2FwbHhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNjk3ODUsImV4cCI6MjA3ODY0NTc4NX0.XtX9NMHp3gINRP3zSA-PnC73tiI4vPVcB4D2A13c1TI'; 
        const TABLE_NAME = 'data_master';
        const LOG_TABLE_NAME = 'log_absen'; 
        const REQUIRED_HEADERS = ['Card ID', 'NIK', 'Nama', 'Departemen', 'Pagi', 'Siang', 'Sore', 'Malam']; 
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        let parsedImportData = []; 
        let activeCardIds = [];    
        let currentMode = 'create';
        let cardIdToDelete = null;
        let allAbsensiLogs = []; // Untuk menyimpan data log yang akan diexport

        document.addEventListener('DOMContentLoaded', () => {
            // Memuat Font Awesome untuk ikon
            const link = document.createElement('link');
            link.rel = 'stylesheet';
            link.href = 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/5.15.4/css/all.min.css';
            document.head.appendChild(link);

            checkAdminSession(); // PANGGIL FUNGSI CEK SESI UNTUK AUTENTIKASI
            document.getElementById('crud-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('import-form').addEventListener('submit', handleImportSubmit);
        });

        // --- FUNGSI AUTENTIKASI & LOGOUT ---
        async function checkAdminSession() {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            
            if (error || !session) {
                window.location.href = './admin_login.html'; 
                return;
            }
            
            switchView('dashboard'); 
        }

        async function handleLogout() {
            const logoutBtn = document.getElementById('logout-button');
            logoutBtn.disabled = true;
            logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i> Keluar...';
            
            const { error } = await supabaseClient.auth.signOut();

            if (error) {
                console.error("Logout Error:", error);
                showGlobalMessage(`Gagal keluar: ${error.message}`, 'error');
                logoutBtn.disabled = false;
                logoutBtn.innerHTML = '<i class="fas fa-sign-out-alt mr-2"></i> Keluar (Logout)';
            } else {
                window.location.href = './admin_login.html';
            }
        }

        // --- Navigasi View & Dashboard Summary ---
        function switchView(viewId) {
            // Reset visibility
            document.getElementById('dashboard-view').classList.add('hidden');
            document.getElementById('data-karyawan-view').classList.add('hidden');
            document.getElementById('laporan-absen-view').classList.add('hidden');

            // Reset menu active state
            document.getElementById('menu-dashboard').classList.remove('tab-active-menu');
            document.getElementById('menu-data-karyawan').classList.remove('tab-active-menu');
            document.getElementById('menu-laporan-absen').classList.remove('tab-active-menu');

            // Set active view and menu
            if (viewId === 'dashboard') {
                document.getElementById('view-title').textContent = 'Dashboard Utama';
                document.getElementById('dashboard-view').classList.remove('hidden');
                document.getElementById('menu-dashboard').classList.add('tab-active-menu');
                loadDashboardSummary(); // Panggil fungsi ringkasan
            } else if (viewId === 'data-karyawan') {
                document.getElementById('view-title').textContent = 'Data Karyawan';
                document.getElementById('data-karyawan-view').classList.remove('hidden');
                document.getElementById('menu-data-karyawan').classList.add('tab-active-menu');
                fetchData();
            } else if (viewId === 'laporan-absen') {
                document.getElementById('view-title').textContent = 'Laporan Log Absensi';
                document.getElementById('laporan-absen-view').classList.remove('hidden');
                document.getElementById('menu-laporan-absen').classList.add('tab-active-menu');
                loadArchivedAbsensiLog(); 
            }
        }

        async function loadDashboardSummary() {
            // Ambil Total Karyawan
            const { count: karyawanCount, error: errKaryawan } = await supabaseClient
                .from(TABLE_NAME)
                .select('*', { count: 'exact', head: true });
            
            // Ambil Total Log Absensi & Log Terbaru
            const { data: logs, error: errLogs } = await supabaseClient
                .from(LOG_TABLE_NAME)
                .select('created_at, status, nama', { count: 'exact' })
                .order('created_at', { ascending: false })
                .limit(1);

            document.getElementById('total-karyawan').textContent = errKaryawan ? 'Error' : (karyawanCount || 0).toLocaleString('id-ID');
            document.getElementById('total-logs').textContent = errLogs ? 'Error' : (logs.count || 0).toLocaleString('id-ID');

            if (logs && logs.data.length > 0) {
                const latest = logs.data[0];
                const dateObj = new Date(latest.created_at);
                const timeString = dateObj.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit' });
                const statusText = latest.status === 'Sukses' ? '✅ Sukses' : '❌ Gagal';
                document.getElementById('latest-log').innerHTML = 
                    `${statusText} oleh ${latest.nama || 'Tidak Terdaftar'} pada ${timeString}`;
            } else {
                document.getElementById('latest-log').textContent = 'Belum ada log absensi.';
            }
        }


        // --- FUNGSI LOG ABSENSI ARSIP BARU (GROUPING & RENDER) ---

        /**
         * Mengambil semua log dan mengelompokkannya berdasarkan tanggal.
         */
        async function loadArchivedAbsensiLog() {
            const container = document.getElementById('log-group-container');
            container.innerHTML = '<p class="py-4 text-center text-gray-400"><i class="fas fa-spinner fa-spin mr-2"></i> Memuat detail log absensi...</p>';

            const { data: logs, error } = await supabaseClient
                .from(LOG_TABLE_NAME)
                .select('card, status, periode, created_at, nama, departemen') 
                .order('created_at', { ascending: false });
            
            if (error) {
                console.error("Error fetching logs:", error);
                showGlobalMessage(`Gagal memuat log absensi: ${error.message}`, 'error');
                container.innerHTML = '<p class="py-4 text-center text-red-400">Gagal memuat data log.</p>';
                return;
            }

            allAbsensiLogs = logs; 
            const groupedLogs = groupLogsByDate(logs);
            renderGroupedLogs(groupedLogs);
        }

        /**
         * Mengelompokkan log menjadi objek berdasarkan format tanggal "DD Month YYYY".
         */
        function groupLogsByDate(logs) {
            const grouped = {};
            const formatter = new Intl.DateTimeFormat('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });

            logs.forEach(log => {
                const date = new Date(log.created_at);
                const dateKey = formatter.format(date); // Contoh: "17 November 2025"

                if (!grouped[dateKey]) {
                    grouped[dateKey] = [];
                }
                grouped[dateKey].push(log);
            });
            return grouped;
        }

        /**
         * Merender log yang sudah dikelompokkan ke dalam struktur collapsible.
         */
        function renderGroupedLogs(groupedLogs) {
            const container = document.getElementById('log-group-container');
            container.innerHTML = '';

            const dates = Object.keys(groupedLogs).sort((a, b) => new Date(b) - new Date(a));

            if (dates.length === 0) {
                container.innerHTML = '<p class="py-4 text-center text-gray-400">Tidak ada data absensi yang terarsip.</p>';
                return;
            }

            dates.forEach(dateKey => {
                const logs = groupedLogs[dateKey];
                
                const details = document.createElement('details');
                details.className = 'w-full';
                
                // Header (Summary) - Mirip dengan gambar
                const summary = document.createElement('summary');
                summary.className = 'log-date-header';
                summary.innerHTML = `
                    <span><i class="fas fa-calendar-alt mr-3"></i> ${dateKey} (${logs.length} Log)</span>
                    <div class="flex space-x-3 items-center">
                        <span class="text-xs font-normal text-gray-200">Klik untuk melihat detail</span>
                        <button onclick="event.stopPropagation(); exportDailyAbsensiToExcel('${dateKey}')" 
                                class="bg-indigo-700 hover:bg-indigo-800 text-white p-2 rounded-full transition duration-150" 
                                title="Export Log Tanggal ${dateKey} ke Excel">
                            <i class="fas fa-file-excel text-sm"></i>
                        </button>
                    </div>
                `;
                details.appendChild(summary);

                // Content (Log Table)
                const contentDiv = document.createElement('div');
                contentDiv.className = 'log-content overflow-x-auto';
                
                const table = document.createElement('table');
                table.className = 'min-w-full divide-y divide-gray-600 text-gray-300 review-table';
                table.innerHTML = `
                    <thead class="bg-gray-800 sticky top-0">
                        <tr>
                            <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider">Waktu</th>
                            <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider">Card ID</th>
                            <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider">Nama</th>
                            <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider">Departemen</th>
                            <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider">Periode</th>
                            <th class="px-3 py-2 text-left text-xs font-medium uppercase tracking-wider">Status</th>
                        </tr>
                    </thead>
                    <tbody class="divide-y divide-gray-700"></tbody>
                `;
                
                const tbody = table.querySelector('tbody');
                logs.forEach(log => {
                    const statusColor = log.status === 'Sukses' ? 'text-success-green font-semibold' : 'text-error-red';
                    
                    const dateObj = new Date(log.created_at);
                    const logTime = dateObj.toLocaleTimeString('id-ID', {
                        hour: '2-digit', minute: '2-digit', second: '2-digit'
                    });

                    const row = document.createElement('tr');
                    row.className = 'hover:bg-gray-600';
                    row.innerHTML = `
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-400">${logTime}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-400">${log.card}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm font-medium text-gray-200">${log.nama || 'Tidak Terdaftar'}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-400">${log.departemen || '-'}</td> 
                        <td class="px-3 py-2 whitespace-nowrap text-sm text-gray-400 capitalize">${log.periode || '-'}</td>
                        <td class="px-3 py-2 whitespace-nowrap text-sm ${statusColor}">${log.status}</td>
                    `;
                    tbody.appendChild(row);
                });

                contentDiv.appendChild(table);
                details.appendChild(contentDiv);
                container.appendChild(details);
            });
        }

        /**
         * Mengekspor log absensi untuk TANGGAL tertentu ke file Excel.
         */
        function exportDailyAbsensiToExcel(dateString) {
            const formatter = new Intl.DateTimeFormat('id-ID', { day: 'numeric', month: 'long', year: 'numeric' });
            
            // Filter log berdasarkan tanggal yang dipilih
            const dailyLogs = allAbsensiLogs.filter(log => {
                const date = new Date(log.created_at);
                return formatter.format(date) === dateString;
            });
            
            if (dailyLogs.length === 0) {
                showGlobalMessage(`Tidak ada data log pada ${dateString} yang bisa diexport.`, 'error');
                return;
            }
            
            const wsData = [
                ["Tanggal & Waktu", "Card ID", "Nama Karyawan", "Departemen", "Periode", "Status Tap", "created_at (Raw)"] 
            ];

            dailyLogs.forEach(log => {
                const dateObj = new Date(log.created_at);
                const logDateTime = dateObj.toLocaleDateString('id-ID', {
                    year: 'numeric', month: 'long', day: 'numeric',
                    hour: '2-digit', minute: '2-digit', second: '2-digit'
                });
                
                wsData.push([
                    logDateTime,
                    log.card,
                    log.nama || 'Tidak Terdaftar',
                    log.departemen || '-',
                    log.periode || '-',
                    log.status,
                    log.created_at 
                ]);
            });

            const ws = XLSX.utils.aoa_to_sheet(wsData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "LogHarian");

            const safeDateString = dateString.replace(/ /g, '_').replace(/,/g, '');
            XLSX.writeFile(wb, `Log_Absensi_${safeDateString}.xlsx`);
            
            showGlobalMessage(`Berhasil mengekspor ${dailyLogs.length} baris data untuk ${dateString} ke Excel.`, 'success');
        }

        // --- FUNGSI LAMA (CRUD, FETCH DATA, DLL) TETAP DI SINI ---
        
        function showGlobalMessage(message, type = 'success') {
            const msgEl = document.getElementById('global-message');
            msgEl.textContent = message;
            msgEl.className = 'p-3 rounded-lg text-center font-medium';
            
            // Dark Theme Colors for Message Box
            if (type === 'success') { msgEl.classList.add('bg-green-700', 'text-white'); } 
            else if (type === 'error') { msgEl.classList.add('bg-red-700', 'text-white'); } 
            else { msgEl.classList.add('bg-blue-700', 'text-white'); }
            
            msgEl.classList.remove('hidden');
            setTimeout(() => { msgEl.classList.add('hidden'); }, 8000); 
        }
        
        function formatTime(textValue) {
            if (!textValue) return '-';
            return String(textValue).trim() || '-';
        }
        
        async function fetchData(cardFilter = '', nameFilter = '') {
            let query = supabaseClient
                .from(TABLE_NAME)
                .select('*');

            if (cardFilter) {
                query = query.ilike('card', `%${cardFilter}%`);
            }
            if (nameFilter) {
                query = query.ilike('nama', `%${nameFilter}%`);
            }
            
            const { data, error } = await query
                .order('nama', { ascending: true });

            const tbody = document.getElementById('data-table-body');
            const noDataMsg = document.getElementById('no-data-message');
            tbody.innerHTML = '';

            if (error) {
                console.error("Error fetching data:", error);
                showGlobalMessage(`Gagal memuat data: ${error.message}.`, 'error');
                noDataMsg.textContent = 'Gagal memuat data.';
                noDataMsg.classList.remove('hidden');
                return;
            }

            if (data.length === 0) {
                noDataMsg.textContent = (cardFilter || nameFilter) ? 'Tidak ada data yang cocok dengan kriteria pencarian.' : 'Belum ada data karyawan yang tersimpan.';
                noDataMsg.classList.remove('hidden');
            } else {
                noDataMsg.classList.add('hidden');
                data.forEach(item => {
                    const row = tbody.insertRow(); 
                    row.className = 'hover:bg-gray-600'; // Dark theme hover

                    row.insertCell().textContent = item.card;
                    row.insertCell().textContent = item.nik;
                    row.insertCell().textContent = item.nama;
                    row.insertCell().textContent = item.departemen;
                    
                    row.insertCell().textContent = formatTime(item.pagi);
                    row.insertCell().textContent = formatTime(item.siang);
                    row.insertCell().textContent = formatTime(item.sore);
                    row.insertCell().textContent = formatTime(item.malam);

                    const actionCell = row.insertCell();
                    actionCell.innerHTML = `<div class="flex space-x-2"><button onclick="openFormModal('edit', '${item.card}')" class="text-blue-400 hover:text-blue-500 font-medium">Edit</button><button onclick="openDeleteModal('${item.card}')" class="text-red-400 hover:text-red-500 font-medium">Hapus</button></div>`;
                });
            }
        }
        
        function applySearchFilter() {
            const card = document.getElementById('search-card').value.trim();
            const nama = document.getElementById('search-nama').value.trim();
            fetchData(card, nama);
        }

        function clearSearchFilter() {
            document.getElementById('search-card').value = '';
            document.getElementById('search-nama').value = '';
            fetchData(); 
        }
        
        // (Semua fungsi Modal dan CRUD lainnya tetap sama, hanya tampilan yang disesuaikan di HTML/CSS di atas)
        // ... (openFormModal, closeFormModal, handleFormSubmit, openDeleteModal, closeDeleteModal, executeDelete, openImportModal, closeImportModal, parseExcelFile, processExcelData, handleImportSubmit) ...
        
        // ... (Pastikan semua fungsi lama yang tidak ditampilkan di sini juga ada di file Anda) ...
        
        // [Fungsi parseExcelFile, processExcelData, dan handleImportSubmit di bawah ini harus disertakan di kode Anda]
        // [Karena fungsi-fungsi ini kompleks, saya asumsikan mereka ada, dan hanya menyalin kode yang berubah secara signifikan]

    </script>
    </body>
</html>
