<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Panel Admin Sistem Modern</title>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700;800&display=swap" rel="stylesheet">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        /* Custom styles dari kode lama */
        body { font-family: 'Inter', sans-serif; }
        .container { max-width: 1300px; }
        .modal-overlay { background-color: rgba(30, 41, 59, 0.7); backdrop-filter: blur(2px); }
        
        /* Gaya Tabel Admin (Dipertahankan) */
        .admin-table th, .admin-table td { padding: 12px 16px; text-align: left; }
        .admin-table th { 
            background-color: #374151; /* Dark Gray */
            color: white; 
            font-weight: 600;
            font-size: 0.8rem;
            letter-spacing: 0.05em;
            position: sticky; top: 0; z-index: 10;
            border-top: 1px solid #4b5563;
        }
        .admin-table tbody tr:nth-child(even) { background-color: #f9fafb; } /* Zebra striping */

        /* Gaya Tabel Review (Dipertahankan) */
        .review-table th, .review-table td { padding: 8px; font-size: 0.75rem; white-space: nowrap; }
        .review-table th { background-color: #e5e7eb; font-weight: 600; }
        
        /* Transisi dan Tombol (Dipertahankan) */
        .btn-primary { 
            transition: all 0.2s ease-in-out;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1); 
        }
        .btn-primary:hover { 
            transform: translateY(-2px);
            box-shadow: 0 6px 10px rgba(0, 0, 0, 0.15); 
        }
        
        /* Warna Teks (Dipertahankan) */
        .text-success-green { color: #059669; } /* Emerald Green */
        .text-error-red { color: #dc2626; } /* Red-600 */
        
        /* Sticky header log absensi (Dipertahankan) */
        .log-table-header { 
            position: sticky; top: 0; z-index: 10; 
            background-color: #f3f4f6; 
            box-shadow: 0 1px 2px rgba(0, 0, 0, 0.05);
        }
        
        /* Penyesuaian Scrollbar (Dipertahankan) */
        .custom-scroll::-webkit-scrollbar { width: 8px; height: 8px; }
        .custom-scroll::-webkit-scrollbar-thumb { background-color: #d1d5db; border-radius: 4px; }
        .custom-scroll::-webkit-scrollbar-track { background-color: #f3f4f6; }

        /* --- STYLES BARU UNTUK SIDEBAR & LAYOUT --- */
        /* Mengganti body background-color lama dengan class di div utama */
    </style>
</head>
<body>

    <div id="admin-app" class="flex h-screen bg-gray-100">
        
        <div id="sidebar" class="w-64 bg-gray-800 text-white flex flex-col flex-shrink-0 shadow-2xl overflow-y-auto">
            
            <div class="p-6 text-2xl font-extrabold text-white border-b border-gray-700/50">
                <span class="text-indigo-400">Admin</span>Panel
            </div>
            
            <nav class="flex-1 px-4 py-6 space-y-2">
                
                <p class="text-xs uppercase text-gray-400 font-semibold tracking-wider mb-2 px-3">Menu Utama</p>

                <a id="sidebar-link-dashboard-analitik" onclick="switchView('dashboard-analitik')" 
                   class="sidebar-link flex items-center px-3 py-2.5 rounded-lg text-gray-200 hover:bg-gray-700 transition duration-200 cursor-pointer bg-indigo-700 font-semibold">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M11 3.055A9.957 9.957 0 0112 3c3.929 0 7.465 2.129 9.223 5.385M11 3v2.857A9.957 9.957 0 0112 5c.427 0 .848.026 1.265.074M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                    Dashboard Analitik
                </a>

                <a id="sidebar-link-data-karyawan" onclick="switchView('data-karyawan')" 
                   class="sidebar-link flex items-center px-3 py-2.5 rounded-lg text-gray-200 hover:bg-gray-700 transition duration-200 cursor-pointer">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 20h5v-2a3 3 0 00-5.356-1.857M17 20v-2c0-.523-.086-1.05-.282-1.528m-2.973-7.579A3 3 0 0115 11h1a3 3 0 013 3v2m0 0h3m-7 4H7a4 4 0 01-4-4v-2a4 4 0 014-4h7m-8-2a4 4 0 00-4 4v2a4 4 0 004 4m6-10a2 2 0 11-4 0 2 2 0 014 0z"></path></svg>
                    Data Karyawan
                </a>

                <a id="sidebar-link-laporan-absen" onclick="switchView('laporan-absen')" 
                   class="sidebar-link flex items-center px-3 py-2.5 rounded-lg text-gray-200 hover:bg-gray-700 transition duration-200 cursor-pointer">
                    <svg class="w-5 h-5 mr-3" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-6 9l2 2 4-4"></path></svg>
                    Log Absensi Arsip
                </a>
            </nav>
            
            <div class="p-6 border-t border-gray-700/50">
                <p class="text-xs text-gray-500">Sistem Manajemen Absensi & Data</p>
            </div>
        </div>

        <div class="flex-grow flex flex-col overflow-x-hidden overflow-y-auto">
            
            <header class="w-full bg-white shadow-md p-4 flex justify-between items-center flex-shrink-0">
                <h1 id="main-title" class="text-2xl font-extrabold text-gray-900 leading-tight">
                    Dashboard Analitik
                </h1>
                <button id="logout-button" onclick="handleLogout()" class="bg-red-600 text-white px-4 py-2 rounded-lg font-semibold text-sm hover:bg-red-700 transition duration-300 btn-primary flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M17 16l4-4m0 0l-4-4m4 4H7m6 4v1a3 3 0 01-3 3H5a3 3 0 01-3-3v-10a3 3 0 013-3h1a3 3 0 013 3v1"></path></svg>
                    Keluar
                </button>
            </header>
            
            <div id="global-message" class="w-full container mx-auto p-4 rounded-xl text-center font-medium hidden"></div>

            <main class="flex-1 p-4 lg:p-8 space-y-8">
                
                <div id="dashboard-analitik-view" class="w-full container mx-auto">
                    <h2 class="text-3xl font-extrabold text-gray-800 mb-6">Analitik Ringkasan üìä</h2>
                    
                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
                        
                        <div class="bg-white p-6 rounded-xl shadow-xl border-l-4 border-indigo-500">
                            <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Total Karyawan Terdaftar</p>
                            <div class="flex items-end justify-between mt-1">
                                <span id="dashboard-total-karyawan" class="text-4xl font-extrabold text-gray-900">0</span>
                                <svg class="w-8 h-8 text-indigo-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 4.354a4 4 0 110 5.292M12 20.575v-2.261A9.003 9.003 0 0015 18H9a9.003 9.003 0 00-3.326-1.571M12 20.575a.997.997 0 01-.437.16l-.382.179m0 0h-.249m-.14 0l-1.63-2.06c-1.391-.84-2.887-1.464-4.524-1.895M12 20.575l.1.189A9.018 9.018 0 0019 18h2M12 20.575l.1.189A9.018 9.018 0 0019 18h2"></path></svg>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl shadow-xl border-l-4 border-emerald-500">
                            <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Log Sukses Hari Ini</p>
                            <div class="flex items-end justify-between mt-1">
                                <span id="dashboard-log-sukses-hari-ini" class="text-4xl font-extrabold text-gray-900">0</span>
                                <svg class="w-8 h-8 text-emerald-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 12l2 2 4-4m5.618-4.016A11.955 11.955 0 0112 2.944a11.955 11.955 0 01-8.58 3.593m17.16 0A20.02 20.02 0 0112 8.086a20.02 20.02 0 01-8.58-3.593"></path></svg>
                            </div>
                        </div>
                        
                        <div class="bg-white p-6 rounded-xl shadow-xl border-l-4 border-red-500">
                            <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Log Gagal Hari Ini</p>
                            <div class="flex items-end justify-between mt-1">
                                <span id="dashboard-log-gagal-hari-ini" class="text-4xl font-extrabold text-gray-900">0</span>
                                <svg class="w-8 h-8 text-red-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 8v4m0 4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path></svg>
                            </div>
                        </div>

                        <div class="bg-white p-6 rounded-xl shadow-xl border-l-4 border-yellow-500">
                            <p class="text-sm font-medium text-gray-500 uppercase tracking-wider">Total Departemen Unik</p>
                            <div class="flex items-end justify-between mt-1">
                                <span id="dashboard-total-departemen" class="text-4xl font-extrabold text-gray-900">0</span>
                                <svg class="w-8 h-8 text-yellow-500" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 14v3m4-3v3m4-3v3M3 21h18M5 5h14a2 2 0 012 2v3a2 2 0 01-2 2H5a2 2 0 01-2-2V7a2 2 0 012-2zm2 0h10v3H7V5z"></path></svg>
                            </div>
                        </div>
                        
                    </div>
                    
                    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl mt-8">
                        <h3 class="text-xl font-bold text-gray-800 mb-4">Aktivitas Terbaru</h3>
                        <p class="text-gray-500">Anda dapat menambahkan grafik atau tabel ringkasan aktivitas log absensi di area ini menggunakan library grafik seperti Chart.js atau ApexCharts.</p>
                        <div class="h-40 bg-gray-50 border border-dashed border-gray-300 rounded-lg flex items-center justify-center mt-4 text-gray-400">
                            [Placeholder untuk Grafik Analitik]
                        </div>
                    </div>
                </div>
                
                <div id="data-karyawan-view" class="w-full container mx-auto hidden">
                    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl">
                        
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-8 space-y-4 sm:space-y-0">
                            <h2 class="text-3xl font-extrabold text-gray-800">
                                Employee Data Management
                            </h2>
                            <div class="flex flex-col sm:flex-row space-y-2 sm:space-y-0 sm:space-x-3 w-full sm:w-auto">
                                <button onclick="openImportModal()" class="bg-blue-600 text-white px-4 py-2 rounded-xl font-semibold text-sm hover:bg-blue-700 transition duration-300 btn-primary flex items-center justify-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-8l-4-4m0 0L8 8m4-4v12"></path></svg>
                                    Import Data (Ganti Total)
                                </button>
                                <button onclick="openFormModal('create')" class="bg-green-600 text-white px-4 py-2 rounded-xl font-semibold text-sm hover:bg-green-700 transition duration-300 btn-primary flex items-center justify-center">
                                    <svg class="w-4 h-4 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 6v6m0 0v6m0-6h6m-6 0H6"></path></svg>
                                    Tambah Karyawan Baru
                                </button>
                            </div>
                        </div>

                        <div class="grid grid-cols-2 md:grid-cols-5 gap-3 mb-6 p-4 bg-gray-50 rounded-lg border">
                            <input type="text" id="search-card" placeholder="Cari Card ID..." 
                                class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 col-span-2 md:col-span-1"
                                onkeypress="if(event.key === 'Enter') applySearchFilter()">
                            <input type="text" id="search-nama" placeholder="Cari Nama..." 
                                class="p-2 border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 col-span-2 md:col-span-2"
                                onkeypress="if(event.key === 'Enter') applySearchFilter()">
                            <button onclick="applySearchFilter()" class="bg-indigo-600 text-white px-4 py-2 rounded-lg font-semibold hover:bg-indigo-700 transition duration-300 btn-primary flex items-center justify-center text-sm">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"></path></svg>
                                Cari
                            </button>
                            <button onclick="clearSearchFilter()" class="bg-gray-400 text-white px-4 py-2 rounded-lg font-semibold hover:bg-gray-500 transition duration-300 flex items-center justify-center text-sm">
                                <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 4v5h.582m15.356 2A8.001 8.001 0 004.582 9m0 0H9m11 11v-5h-.581m-15.356-2a8.001 8.001 0 0115.357-2m0 0H15"></path></svg>
                                Reset
                            </button>
                        </div>
                        
                        <div class="overflow-x-auto relative shadow-xl rounded-xl custom-scroll max-h-[70vh]">
                            <table class="w-full text-sm text-left text-gray-500 admin-table">
                                <thead class="text-xs uppercase">
                                    <tr>
                                        <th>Card ID</th>
                                        <th>NIK</th>
                                        <th>Nama</th>
                                        <th>Departemen</th>
                                        <th class="text-blue-400">Pagi</th>
                                        <th class="text-blue-400">Siang</th>
                                        <th class="text-blue-400">Sore</th>
                                        <th class="text-blue-400">Malam</th>
                                        <th>Aksi</th>
                                    </tr>
                                </thead>
                                <tbody id="data-table-body" class="bg-white divide-y divide-gray-100">
                                </tbody>
                            </table>
                        </div>

                        <div id="no-data-message" class="text-center py-10 text-gray-500 font-medium hidden">
                            Belum ada data karyawan yang tersimpan.
                        </div>
                    </div>
                </div>
                
                <div id="laporan-absen-view" class="w-full container mx-auto hidden">
                    <div class="bg-white p-6 md:p-8 rounded-2xl shadow-xl">
                        
                        <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center mb-6 border-b pb-4">
                            <h2 class="text-3xl font-extrabold text-gray-800">Log Absensi (Arsip 7 Hari)</h2>
                            <p id="deletion-status" class="text-sm text-gray-500 font-medium mt-2 sm:mt-0"></p>
                        </div>

                        <p class="text-sm text-gray-600 mb-6 border-l-4 border-indigo-400 pl-3 py-1 bg-indigo-50 rounded-md">
                            Menampilkan log tap kartu (sukses dan gagal) yang tersimpan untuk **7 hari terakhir**.
                            Data log di luar periode ini otomatis dihapus.
                        </p>
                        
                        <div id="log-per-tanggal-container" class="space-y-6">
                        </div>
                        
                        <div id="loading-log-message" class="py-6 text-center text-gray-500 font-medium">Memuat detail log absensi...</div>
                        <div id="no-log-message" class="py-6 text-center text-gray-500 font-medium hidden">Tidak ada data absensi yang terarsip dalam 7 hari terakhir.</div>

                    </div>
                </div>
                
            </main>
        </div>
    </div>
    
    <div id="import-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-5xl transform transition-all duration-300 scale-95 opacity-0" id="import-content">
            <h3 class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Import Data Karyawan (Ganti Total)</h3>
            
            <form id="import-form">
                <div id="step-upload" class="bg-gray-50 p-6 rounded-lg border border-gray-200">
                    <p class="text-sm text-gray-600 mb-4">Unggah file Excel (.xlsx atau .xls) yang berisi **SEMUA** data karyawan aktif.</p>
                    
                    <div class="p-3 bg-red-50 border border-red-300 rounded-lg mb-4">
                        <p class="text-xs text-red-600 font-bold">‚ö†Ô∏è PENTING: Proses ini adalah **PENGGANTIAN TOTAL**.</p>
                        <p class="text-xs text-red-600 mt-1">Kolom Wajib: <code class="font-mono text-xs bg-red-100 p-1 rounded font-semibold">Card ID, NIK, Nama, Departemen, Pagi, Siang, Sore, Malam</code>.</p>
                        <p class="text-xs text-red-600 mt-1">Semua data karyawan lama di database akan **DIHAPUS** dan digantikan dengan data dari file Excel ini.</p>
                    </div>
                    
                    <div class="mb-4">
                        <label for="excel-file-input" class="block text-sm font-medium text-gray-700 mb-2">Pilih File Excel:</label>
                        <input type="file" id="excel-file-input" accept=".xlsx, .xls" required 
                            class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 
                            file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100 cursor-pointer">
                    </div>
                </div>

                <div id="step-review" class="hidden mt-6">
                    <h4 class="text-xl font-bold text-gray-800 mb-4">Review Data yang Akan Diproses</h4>
                    
                    <div class="overflow-x-auto max-h-96 border rounded-lg p-2 custom-scroll">
                        <table class="w-full text-left review-table">
                            <thead class="sticky top-0">
                                <tr>
                                    <th class="w-1/12">Card ID</th>
                                    <th class="w-1/12">NIK</th>
                                    <th class="w-2/12">Nama</th>
                                    <th class="w-2/12">Departemen</th>
                                    <th class="w-1/12 text-blue-600">Pagi</th>
                                    <th class="w-1/12 text-blue-600">Siang</th>
                                    <th class="w-1/12 text-blue-600">Sore</th>
                                    <th class="w-1/12 text-blue-600">Malam</th>
                                    <th class="w-1/12">Status</th>
                                </tr>
                            </thead>
                            <tbody id="review-table-body">
                            </tbody>
                        </table>
                    </div>
                    <p id="review-summary" class="text-sm mt-4 text-gray-700 font-medium"></p>
                    <p id="deletion-warning" class="text-sm text-red-600 font-semibold mt-2 hidden p-2 bg-red-100 rounded-md">‚ö†Ô∏è Peringatan Akhir: Proses ini akan **MENGHAPUS SEMUA DATA LAMA** dan menggantinya dengan data yang di-review di atas.</p>
                </div>

                <div class="flex justify-end space-x-3 mt-6">
                    <button type="button" onclick="closeImportModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition duration-150">Batal</button>
                    <button type="button" id="review-button" onclick="parseExcelFile()" class="px-4 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition duration-150 btn-primary flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg>
                        Review Data
                    </button>
                    <button type="submit" id="import-submit-button" class="px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 transition duration-150 btn-primary hidden flex items-center" disabled>
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg>
                        Hapus Lama & Ganti Baru
                    </button>
                </div>
            </form>
        </div>
    </div>

    <div id="form-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-lg transform transition-all duration-300 scale-95 opacity-0" 
            id="form-content">
            <h3 id="modal-title" class="text-2xl font-bold text-gray-800 mb-6 border-b pb-2">Tambah Karyawan Baru</h3>
            <form id="crud-form">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="form-card" class="block text-sm font-medium text-gray-700">Card ID</label>
                        <input type="text" id="form-card" required class="mt-1 p-3 w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500 disabled:bg-gray-100" autocomplete="off">
                    </div>
                    <div class="mb-4">
                        <label for="form-nik" class="block text-sm font-medium text-gray-700">NIK</label>
                        <input type="text" id="form-nik" required class="mt-1 p-3 w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
                    </div>
                </div>
                
                <div class="mb-4">
                    <label for="form-nama" class="block text-sm font-medium text-gray-700">Nama</label>
                    <input type="text" id="form-nama" required class="mt-1 p-3 w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
                </div>
                
                <div class="mb-6">
                    <label for="form-departemen" class="block text-sm font-medium text-gray-700">Departemen</label>
                    <input type="text" id="form-departemen" required class="mt-1 p-3 w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" autocomplete="off">
                </div>

                <div class="border-t border-gray-200 my-6"></div>
                
                <h4 class="text-xl font-bold text-gray-800 mb-4 flex items-center">
                    Absensi/Makan Periode üçΩÔ∏è
                </h4>
                
                <div class="grid grid-cols-2 gap-4">
                    <div class="mb-4">
                        <label for="form-pagi" class="block text-sm font-medium text-gray-700">Pagi</label>
                        <input type="text" id="form-pagi" class="mt-1 p-3 w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Contoh: Kantin atau kosong">
                    </div>
                    <div class="mb-4">
                        <label for="form-siang" class="block text-sm font-medium text-gray-700">Siang</label>
                        <input type="text" id="form-siang" class="mt-1 p-3 w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Contoh: Kantin atau kosong">
                    </div>
                    <div class="mb-4">
                        <label for="form-sore" class="block text-sm font-medium text-gray-700">Sore</label>
                        <input type="text" id="form-sore" class="mt-1 p-3 w-full border border-gray-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Contoh: Kantin atau kosong">
                    </div>
                    <div class="mb-6">
                        <label for="form-malam" class="block text-sm font-medium text-gray-700">Malam</label>
                        <input type="text" id="form-malam" class="mt-1 p-3 w-full border border-gray-300 
                        rounded-lg focus:ring-indigo-500 focus:border-indigo-500" placeholder="Contoh: Kantin atau kosong">
                    </div>
                </div>
                
                <div class="flex justify-end space-x-3 mt-4">
                    <button type="button" 
                        onclick="closeFormModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition duration-150">Batal</button>
                    <button type="submit" id="submit-button" class="px-4 py-2 bg-indigo-600 text-white rounded-xl hover:bg-indigo-700 transition duration-150 btn-primary flex items-center">
                        <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M5 13l4 4L19 7"></path></svg>
                        Simpan
                    </button>
                </div>
            </form>
        </div>
    </div>
    
    <div id="delete-modal" class="modal-overlay fixed inset-0 z-50 flex items-center justify-center hidden">
        <div class="bg-white rounded-xl shadow-2xl p-6 w-11/12 max-w-md transform transition-all 
            duration-300 scale-95 opacity-0" id="delete-content">
            <h3 class="text-2xl font-bold text-red-600 mb-4 flex items-center">
                <svg class="w-6 h-6 mr-2" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16"></path></svg>
                Konfirmasi Penghapusan
            </h3>
            <p class="text-gray-700 mb-6">Anda yakin ingin menghapus data karyawan dengan Card ID: <span id="delete-card-id" class="font-bold text-red-700"></span>?
                **Aksi ini tidak dapat dibatalkan.**</p>
            <div class="flex justify-end space-x-3">
                <button type="button" onclick="closeDeleteModal()" class="px-4 py-2 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 transition duration-150">Batal</button>
                <button type="button" onclick="executeDelete()" class="px-4 py-2 bg-red-600 text-white rounded-xl hover:bg-red-700 transition duration-150 btn-primary flex items-center">
                    <svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" 
                        viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3"></path></svg>
                    Hapus Permanen
                </button>
            </div>
        </div>
    </div>

    <script>
        // --- 1. KONFIGURASI SUPABASE (PASTIKAN INI SESUAI) ---
        const SUPABASE_URL = 'https://ymzcvyumplerqccaplxi.supabase.co'; [cite_start]// [cite: 1]
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltemN2eXVtcGxlcnFjY2FwbHhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNjk3ODUsImV4cCI6MjA3ODY0NTc4NX0.XtX9NMHp3gINRP3zSA-PnC73tiI4vPVcB4D2A13c1TI'; [cite_start]// [cite: 1]
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzVBVy8euCWjr7xDCc91mko5p_mskGoH1pr-aI7hjd_4ou66-MCXVR73PNwXlIsbmqO8g/exec'; [cite_start]// [cite: 1]
        const TABLE_NAME = 'data_master'; [cite_start]// [cite: 1]
        const LOG_TABLE_NAME = 'log_absen'; [cite_start]// [cite: 1]
        const REQUIRED_HEADERS = ['Card ID', 'NIK', 'Nama', 'Departemen', 'Pagi', 'Siang', 'Sore', 'Malam']; [cite_start]// [cite: 1]
        
        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY); [cite_start]// [cite: 1]
        let parsedImportData = []; [cite_start]// [cite: 1]
        let activeCardIds = []; [cite_start]// [cite: 1]
        let currentMode = 'create'; [cite_start]// [cite: 1]
        let cardIdToDelete = null; [cite_start]// [cite: 1]
        let allAbsensiLogs = []; [cite_start]// [cite: 1]

        [cite_start]document.addEventListener('DOMContentLoaded', () => { // [cite: 1]
            checkAdminSession(); [cite_start]// [cite: 1]
            document.getElementById('crud-form').addEventListener('submit', handleFormSubmit); [cite_start]// [cite: 1]
            document.getElementById('import-form').addEventListener('submit', handleImportSubmit); [cite_start]// [cite: 1]
        });

        // FUNGSI BARU: Untuk menampilkan data placeholder di Dashboard
        async function displayDashboardAnalytics() {
            const today = new Date().toISOString().split('T')[0];
            
            // 1. Fetch Total Karyawan & Total Departemen
            const { data: employees, count: totalKaryawan, error: employeeError } = await supabaseClient
                .from(TABLE_NAME)
                .select('departemen', { count: 'exact' });

            if (employeeError) {
                console.error("Error fetching employee data for dashboard:", employeeError);
            } else {
                document.getElementById('dashboard-total-karyawan').textContent = totalKaryawan || 0;
                
                // Hitung departemen unik
                const uniqueDepartements = [...new Set(employees.map(e => e.departemen).filter(d => d && d.trim() !== ''))].length;
                document.getElementById('dashboard-total-departemen').textContent = uniqueDepartements;
            }

            // 2. Fetch Log Hari Ini
            const { data: logs, error: logError } = await supabaseClient
                .from(LOG_TABLE_NAME)
                .select('status')
                .gte('created_at', `${today}T00:00:00.000Z`)
                .lt('created_at', `${today}T23:59:59.999Z`);

            if (logError) {
                console.error("Error fetching log data for dashboard:", logError);
            } else if (logs) {
                const totalLogs = logs.length;
                const suksesLogs = logs.filter(log => log.status === 'Sukses').length;
                const gagalLogs = totalLogs - suksesLogs;
                
                document.getElementById('dashboard-log-sukses-hari-ini').textContent = suksesLogs;
                document.getElementById('dashboard-log-gagal-hari-ini').textContent = gagalLogs;
            }
            
            // Perbarui judul utama
            document.getElementById('main-title').textContent = 'Dashboard Analitik';
        }

        // --- Navigasi View (MODIFIKASI) ---
        function switchView(viewId) {
            // Sembunyikan semua view
            document.getElementById('dashboard-analitik-view').classList.add('hidden'); // NEW
            document.getElementById('data-karyawan-view').classList.add('hidden'); [cite_start]// [cite: 1]
            document.getElementById('laporan-absen-view').classList.add('hidden'); [cite_start]// [cite: 1]
            
            // Hapus status aktif dari semua link sidebar (kelas 'sidebar-link' baru)
            document.querySelectorAll('.sidebar-link').forEach(link => {
                link.classList.remove('bg-indigo-700', 'font-semibold');
                link.classList.add('hover:bg-gray-700');
            });

            // Tentukan view dan link yang aktif
            const activeViewElement = document.getElementById(`${viewId}-view`);
            const activeLinkElement = document.getElementById(`sidebar-link-${viewId}`);
            
            if (activeViewElement) {
                activeViewElement.classList.remove('hidden');
            }

            if (activeLinkElement) {
                activeLinkElement.classList.remove('hover:bg-gray-700');
                activeLinkElement.classList.add('bg-indigo-700', 'font-semibold');
            }
            
            // Perbarui Judul Utama Halaman
            const titleMap = {
                'dashboard-analitik': 'Dashboard Analitik',
                'data-karyawan': 'Manajemen Data Karyawan',
                'laporan-absen': 'Laporan Log Absensi'
            };
            document.getElementById('main-title').textContent = titleMap[viewId] || 'Panel Admin Sistem';


            // Eksekusi fungsi spesifik
            if (viewId === 'dashboard-analitik') {
                displayDashboardAnalytics(); // NEW FUNCTION CALL
            } else if (viewId === 'data-karyawan') {
                fetchData(); [cite_start]// [cite: 1]
            } else if (viewId === 'laporan-absen') {
                autoDeleteOldLogs(); [cite_start]// [cite: 1]
                fetchLogData(); [cite_start]// [cite: 1]
            }
        }

        // FUNGSI LAMA (Dipertahankan dan Dimodifikasi Sedikit)
        
        /**
         * FUNGSI LAMA: Mengecek sesi admin.
         */
        [cite_start]async function checkAdminSession() { // [cite: 1]
            const { data: { session }, error } = await supabaseClient.auth.getSession(); [cite_start]// [cite: 1]
            [cite_start]if (error || !session) { // [cite: 1]
                window.location.href = './admin_login.html'; [cite_start]// [cite: 1]
                return; [cite_start]// [cite: 1]
            }
            
            // MEMULAI DENGAN DASHBOARD ANALITIK SEBAGAI DEFAULT (Perubahan)
            switchView('dashboard-analitik'); [cite_start]// [cite: 1] (Diubah dari 'data-karyawan')
        }

        /**
         * FUNGSI LAMA: Menangani proses Logout.
         */
        [cite_start]async function handleLogout() { // [cite: 1]
            const logoutBtn = document.getElementById('logout-button'); [cite_start]// [cite: 1]
            logoutBtn.disabled = true; [cite_start]// [cite: 1]
            logoutBtn.textContent = 'Keluar...'; [cite_start]// [cite: 1]
            
            const { error } = await supabaseClient.auth.signOut(); [cite_start]// [cite: 1]
            [cite_start]if (error) { // [cite: 1]
                console.error("Logout Error:", error); [cite_start]// [cite: 1]
                showGlobalMessage(`Gagal keluar: ${error.message}`, 'error'); [cite_start]// [cite: 1]
                logoutBtn.disabled = false; [cite_start]// [cite: 1]
                logoutBtn.textContent = 'Keluar';
            [cite_start]} else { // [cite: 1]
                window.location.href = './admin_login.html'; [cite_start]// [cite: 1]
            }
        }
        
        // --- Semua fungsi JavaScript lainnya (getDateNDaysAgo, autoDeleteOldLogs, fetchData, renderTable, applySearchFilter, clearSearchFilter, formatTime, showGlobalMessage, openFormModal, closeFormModal, handleFormSubmit, openDeleteModal, closeDeleteModal, executeDelete, openImportModal, closeImportModal, parseExcelFile, processExcelData, renderReviewTable, handleImportSubmit, fetchLogData, groupLogsByDate, renderGroupedLogDetails, toggleLogDetails, exportSingleDayLogToExcel) dipertahankan tanpa perubahan fungsionalitas. ---
        
        // [SISA KODE JAVASCRIPT LAMA DIMASUKKAN DI SINI]
        function getDateNDaysAgo(n) {
            const date = new Date(); [cite_start]// [cite: 1]
            date.setDate(date.getDate() - n); [cite_start]// [cite: 1]
            // Format YYYY-MM-DD HH:MM:SS (Supabase timestamp format)
            return date.toISOString(); [cite_start]// [cite: 1]
        }

        [cite_start]async function autoDeleteOldLogs() { // [cite: 1]
            const sevenDaysAgo = getDateNDaysAgo(7); [cite_start]// [cite: 1]
            const deletionStatusEl = document.getElementById('deletion-status'); [cite_start]// [cite: 1]
            deletionStatusEl.textContent = 'Memeriksa dan menghapus log lama...'; [cite_start]// [cite: 1]

            [cite_start]const { count, error } = await supabaseClient // [cite: 1]
                [cite_start].from(LOG_TABLE_NAME) // [cite: 1]
                [cite_start].delete({ count: 'exact' }) // [cite: 1]
                .lt('created_at', sevenDaysAgo); [cite_start]// [cite: 1]
            [cite_start]if (error) { // [cite: 1]
                console.error("Auto Delete Log Error:", error); [cite_start]// [cite: 1]
                deletionStatusEl.textContent = `‚ö†Ô∏è Gagal menghapus log lama: ${error.message}`; [cite_start]// [cite: 1]
            [cite_start]} else { // [cite: 1]
                deletionStatusEl.textContent = `‚úÖ Log lama (${count} baris sebelum ${new Date(sevenDaysAgo).toLocaleDateString('id-ID')}) berhasil dihapus.`; [cite_start]// [cite: 1]
            }
        }
        
        async function fetchData(card = '', nama = '') {
            const tableBody = document.getElementById('data-table-body');
            const noDataMessage = document.getElementById('no-data-message');
            tableBody.innerHTML = '<tr><td colspan="9" class="text-center py-6 text-gray-500 font-medium">Memuat data karyawan...</td></tr>';
            noDataMessage.classList.add('hidden');
            activeCardIds = []; // Reset active Card IDs

            let query = supabaseClient.from(TABLE_NAME).select('*').order('nama', { ascending: true });

            if (card) {
                query = query.like('card', `%${card}%`);
            }
            if (nama) {
                query = query.ilike('nama', `%${nama}%`);
            }

            const { data, error } = await query;
            
            if (error) {
                console.error("Error fetching data:", error);
                tableBody.innerHTML = `<tr><td colspan="9" class="text-center py-6 text-red-500">Gagal memuat data: ${error.message}</td></tr>`;
                return;
            }

            if (data.length > 0) {
                activeCardIds = data.map(item => item.card);
                renderTable(data);
            } else {
                tableBody.innerHTML = '';
                noDataMessage.classList.remove('hidden');
            }
        }
        
        function renderTable(data) {
            const tableBody = document.getElementById('data-table-body');
            tableBody.innerHTML = '';
            
            data.forEach(item => {
                const row = tableBody.insertRow();
                row.classList.add('hover:bg-indigo-50/50', 'transition', 'duration-100'); // Efek hover yang lebih halus
                [cite_start]row.insertCell().textContent = item.card; // [cite: 1]
                row.insertCell().textContent = item.nik; [cite_start]// [cite: 1]
                row.insertCell().textContent = item.nama; [cite_start]// [cite: 1]
                row.insertCell().textContent = item.departemen; [cite_start]// [cite: 1]
                row.insertCell().textContent = formatTime(item.pagi); [cite_start]// [cite: 1]
                row.insertCell().textContent = formatTime(item.siang); [cite_start]// [cite: 1]
                row.insertCell().textContent = formatTime(item.sore); [cite_start]// [cite: 1]
                row.insertCell().textContent = formatTime(item.malam); [cite_start]// [cite: 1]
                const actionCell = row.insertCell(); [cite_start]// [cite: 1]
                [cite_start]actionCell.innerHTML = ` // [cite: 1]
                    <div class="flex space-x-2">
                        <button onclick="openFormModal('edit', '${item.card}')" class="text-blue-600 hover:text-blue-800 font-medium p-1 rounded-lg hover:bg-blue-100 transition duration-150">Edit</button>
                        <button onclick="openDeleteModal('${item.card}')" class="text-red-600 hover:text-red-800 font-medium p-1 rounded-lg hover:bg-red-100 transition duration-150">Hapus</button>
                    </div>
                `;
            });
        }
        
        function applySearchFilter() {
            const card = document.getElementById('search-card').value.trim(); [cite_start]// [cite: 1]
            const nama = document.getElementById('search-nama').value.trim(); [cite_start]// [cite: 1]
            fetchData(card, nama); [cite_start]// [cite: 1]
        }
        
        [cite_start]function clearSearchFilter() { // [cite: 1]
            document.getElementById('search-card').value = ''; [cite_start]// [cite: 1]
            document.getElementById('search-nama').value = ''; [cite_start]// [cite: 1]
            fetchData(); [cite_start]// [cite: 1]
        }

        [cite_start]function formatTime(text) { // [cite: 1]
            if (!text) return '-'; [cite_start]// [cite: 1]
            // Format waktu (misal: "08:00") atau teks (misal: "Kantin")
            const timeRegex = /^([01]?[0-9]|2[0-3]):?([0-5][0-9])$/; [cite_start]// [cite: 1]
            [cite_start]if (timeRegex.test(text.trim())) { // [cite: 1]
                return text.trim().replace(':', ':'); [cite_start]// [cite: 1]
            }
            return text; [cite_start]// [cite: 1]
        }
        
        [cite_start]function showGlobalMessage(message, type = 'success') { // [cite: 1]
            const msgEl = document.getElementById('global-message'); [cite_start]// [cite: 1]
            msgEl.textContent = message; [cite_start]// [cite: 1]
            msgEl.className = 'w-full container mx-auto p-4 rounded-xl text-center font-medium'; [cite_start]// [cite: 1]
            
            [cite_start]if (type === 'success') { // [cite: 1]
                msgEl.classList.add('bg-emerald-100', 'text-emerald-800', 'border', 'border-emerald-300'); [cite_start]// [cite: 1]
            [cite_start]} else if (type === 'error') { // [cite: 1]
                msgEl.classList.add('bg-red-100', 'text-red-800', 'border', 'border-red-300'); [cite_start]// [cite: 1]
            [cite_start]} else { // [cite: 1]
                msgEl.classList.add('bg-blue-100', 'text-blue-800', 'border', 'border-blue-300'); [cite_start]// [cite: 1]
            }
            msgEl.classList.remove('hidden'); [cite_start]// [cite: 1]
            
            [cite_start]setTimeout(() => { // [cite: 1]
                msgEl.classList.add('hidden'); [cite_start]// [cite: 1]
            }, 8000); [cite_start]// [cite: 1]
        }

        [cite_start]async function openFormModal(mode, cardId = null) { // [cite: 1]
            currentMode = mode; [cite_start]// [cite: 1]
            const modal = document.getElementById('form-modal'); [cite_start]// [cite: 1]
            const content = document.getElementById('form-content'); [cite_start]// [cite: 1]
            const formCard = document.getElementById('form-card'); [cite_start]// [cite: 1]
            const formNik = document.getElementById('form-nik'); [cite_start]// [cite: 1]
            const formNama = document.getElementById('form-nama'); [cite_start]// [cite: 1]
            const formDepartemen = document.getElementById('form-departemen'); [cite_start]// [cite: 1]
            const formPagi = document.getElementById('form-pagi'); [cite_start]// [cite: 1]
            const formSiang = document.getElementById('form-siang'); [cite_start]// [cite: 1]
            const formSore = document.getElementById('form-sore'); [cite_start]// [cite: 1]
            const formMalam = document.getElementById('form-malam'); [cite_start]// [cite: 1]
            document.getElementById('crud-form').reset(); [cite_start]// [cite: 1]
            formCard.readOnly = false; [cite_start]// [cite: 1]
            formCard.classList.remove('disabled:bg-gray-100'); [cite_start]// [cite: 1]

            [cite_start]if (mode === 'create') { // [cite: 1]
                document.getElementById('modal-title').textContent = 'Tambah Karyawan Baru'; [cite_start]// [cite: 1]
                document.getElementById('submit-button').textContent = 'Simpan Data'; [cite_start]// [cite: 1]
            [cite_start]} else { // [cite: 1]
                document.getElementById('modal-title').textContent = 'Edit Data Karyawan & Absensi'; [cite_start]// [cite: 1]
                document.getElementById('submit-button').textContent = 'Update Data'; [cite_start]// [cite: 1]
                
                formCard.value = cardId; [cite_start]// [cite: 1]
                formCard.readOnly = true; [cite_start]// [cite: 1]
                formCard.classList.add('disabled:bg-gray-100'); [cite_start]// [cite: 1]

                [cite_start]const { data, error } = await supabaseClient // [cite: 1]
                    [cite_start].from(TABLE_NAME) // [cite: 1]
                    [cite_start].select('*') // [cite: 1]
                    [cite_start].eq('card', cardId) // [cite: 1]
                    .single(); [cite_start]// [cite: 1]

                [cite_start]if (error || !data) { // [cite: 1]
                    showGlobalMessage('Gagal memuat data untuk diedit.', 'error'); [cite_start]// [cite: 1]
                    closeFormModal(); [cite_start]// [cite: 1]
                    return; [cite_start]// [cite: 1]
                }
                formNik.value = data.nik; [cite_start]// [cite: 1]
                formNama.value = data.nama; [cite_start]// [cite: 1]
                formDepartemen.value = data.departemen; [cite_start]// [cite: 1]
                formPagi.value = data.pagi || ''; [cite_start]// [cite: 1]
                formSiang.value = data.siang || ''; [cite_start]// [cite: 1]
                formSore.value = data.sore || ''; [cite_start]// [cite: 1]
                formMalam.value = data.malam || ''; [cite_start]// [cite: 1]
            }

            modal.classList.remove('hidden'); [cite_start]// [cite: 1]
            [cite_start]setTimeout(() => { // [cite: 1]
                content.classList.remove('scale-95', 'opacity-0'); [cite_start]// [cite: 1]
                content.classList.add('scale-100', 'opacity-100'); [cite_start]// [cite: 1]
            }, 50); [cite_start]// [cite: 1]
        }

        [cite_start]function closeFormModal() { // [cite: 1]
            const modal = document.getElementById('form-modal'); [cite_start]// [cite: 1]
            const content = document.getElementById('form-content'); [cite_start]// [cite: 1]
            content.classList.remove('scale-100', 'opacity-100'); [cite_start]// [cite: 1]
            content.classList.add('scale-95', 'opacity-0'); [cite_start]// [cite: 1]
            [cite_start]setTimeout(() => { // [cite: 1]
                modal.classList.add('hidden'); [cite_start]// [cite: 1]
            }, 300); [cite_start]// [cite: 1]
        }

        [cite_start]async function handleFormSubmit(event) { // [cite: 1]
            event.preventDefault(); [cite_start]// [cite: 1]
            
            const card = document.getElementById('form-card').value.trim(); [cite_start]// [cite: 1]
            const nik = document.getElementById('form-nik').value.trim(); [cite_start]// [cite: 1]
            const nama = document.getElementById('form-nama').value.trim(); [cite_start]// [cite: 1]
            const departemen = document.getElementById('form-departemen').value.trim(); [cite_start]// [cite: 1]
            const pagi = document.getElementById('form-pagi').value.trim(); [cite_start]// [cite: 1]
            const siang = document.getElementById('form-siang').value.trim(); [cite_start]// [cite: 1]
            const sore = document.getElementById('form-sore').value.trim(); [cite_start]// [cite: 1]
            const malam = document.getElementById('form-malam').value.trim(); [cite_start]// [cite: 1]
            
            let error = null; [cite_start]// [cite: 1]
            let message = ''; [cite_start]// [cite: 1]

            [cite_start]if (currentMode === 'create') { // [cite: 1]
                [cite_start]const newData = { // [cite: 1]
                    [cite_start]card: card, // [cite: 1]
                    [cite_start]nik: nik, // [cite: 1]
                    [cite_start]nama: nama, // [cite: 1]
                    [cite_start]departemen: departemen, // [cite: 1]
                    [cite_start]pagi: pagi, // [cite: 1]
                    [cite_start]siang: siang, // [cite: 1]
                    [cite_start]sore: sore, // [cite: 1]
                    [cite_start]malam: malam // [cite: 1]
                }; [cite_start]// [cite: 1]
                [cite_start]const result = await supabaseClient // [cite: 1]
                    [cite_start].from(TABLE_NAME) // [cite: 1]
                    .insert([newData]); [cite_start]// [cite: 1]
                error = result.error; [cite_start]// [cite: 1]
                message = 'Data karyawan berhasil ditambahkan.'; [cite_start]// [cite: 1]
            [cite_start]} else { // [cite: 1]
                [cite_start]const updateData = { // [cite: 1]
                    [cite_start]nik: nik, // [cite: 1]
                    [cite_start]nama: nama, // [cite: 1]
                    [cite_start]departemen: departemen, // [cite: 1]
                    [cite_start]pagi: pagi, // [cite: 1]
                    [cite_start]siang: siang, // [cite: 1]
                    [cite_start]sore: sore, // [cite: 1]
                    [cite_start]malam: malam // [cite: 1]
                }; [cite_start]// [cite: 1]
                [cite_start]const result = await supabaseClient // [cite: 1]
                    [cite_start].from(TABLE_NAME) // [cite: 1]
                    [cite_start].update(updateData) // [cite: 1]
                    .eq('card', card); [cite_start]// [cite: 1]
                error = result.error; [cite_start]// [cite: 1]
                message = 'Data karyawan berhasil diupdate.'; [cite_start]// [cite: 1]
            }

            [cite_start]if (error) { // [cite: 1]
                console.error("CRUD Error:", error); [cite_start]// [cite: 1]
                const errorMessage = error.code === '23505' ? 'Gagal: Card ID sudah terdaftar.' : error.message; [cite_start]// [cite: 1]
                showGlobalMessage(`Gagal ${currentMode === 'create' ? 'menambah' : 'mengupdate'} data: ${errorMessage}`, 'error'); [cite_start]// [cite: 1]
            [cite_start]} else { // [cite: 1]
                showGlobalMessage(message, 'success'); [cite_start]// [cite: 1]
                closeFormModal(); [cite_start]// [cite: 1]
                fetchData(); [cite_start]// [cite: 1]
            }
        }
        
        [cite_start]function openDeleteModal(cardId) { // [cite: 1]
            cardIdToDelete = cardId; [cite_start]// [cite: 1]
            document.getElementById('delete-card-id').textContent = cardId; [cite_start]// [cite: 1]
            const modal = document.getElementById('delete-modal'); [cite_start]// [cite: 1]
            const content = document.getElementById('delete-content'); [cite_start]// [cite: 1]
            modal.classList.remove('hidden'); [cite_start]// [cite: 1]
            [cite_start]setTimeout(() => { // [cite: 1]
                content.classList.remove('scale-95', 'opacity-0'); [cite_start]// [cite: 1]
                content.classList.add('scale-100', 'opacity-100'); [cite_start]// [cite: 1]
            }, 50); [cite_start]// [cite: 1]
        }
        
        [cite_start]function closeDeleteModal() { // [cite: 1]
            const modal = document.getElementById('delete-modal'); [cite_start]// [cite: 1]
            const content = document.getElementById('delete-content'); [cite_start]// [cite: 1]
            content.classList.remove('scale-100', 'opacity-100'); [cite_start]// [cite: 1]
            content.classList.add('scale-95', 'opacity-0'); [cite_start]// [cite: 1]
            [cite_start]setTimeout(() => { // [cite: 1]
                modal.classList.add('hidden'); [cite_start]// [cite: 1]
                cardIdToDelete = null; [cite_start]// [cite: 1]
            }, 300); [cite_start]// [cite: 1]
        }
        
        [cite_start]async function executeDelete() { // [cite: 1]
            if (!cardIdToDelete) return; [cite_start]// [cite: 1]
            const { error } = await supabaseClient.from(TABLE_NAME).delete().eq('card', cardIdToDelete); [cite_start]// [cite: 1]
            
            [cite_start]if (error) { // [cite: 1]
                console.error("Delete Error:", error); [cite_start]// [cite: 1]
                showGlobalMessage('Gagal menghapus data karyawan.', 'error'); [cite_start]// [cite: 1]
            [cite_start]} else { // [cite: 1]
                showGlobalMessage('Data karyawan berhasil dihapus.', 'success'); [cite_start]// [cite: 1]
                fetchData(); [cite_start]// [cite: 1]
            }
            closeDeleteModal(); [cite_start]// [cite: 1]
        }

        [cite_start]function openImportModal() { // [cite: 1]
            document.getElementById('excel-file-input').value = ''; [cite_start]// [cite: 1]
            document.getElementById('step-upload').classList.remove('hidden'); [cite_start]// [cite: 1]
            document.getElementById('step-review').classList.add('hidden'); [cite_start]// [cite: 1]
            document.getElementById('review-button').classList.remove('hidden'); [cite_start]// [cite: 1]
            document.getElementById('import-submit-button').classList.add('hidden'); [cite_start]// [cite: 1]
            document.getElementById('deletion-warning').classList.add('hidden'); [cite_start]// [cite: 1]
            parsedImportData = []; [cite_start]// [cite: 1]
            activeCardIds = []; [cite_start]// [cite: 1]
            const modal = document.getElementById('import-modal'); [cite_start]// [cite: 1]
            const content = document.getElementById('import-content'); [cite_start]// [cite: 1]
            modal.classList.remove('hidden'); [cite_start]// [cite: 1]
            [cite_start]setTimeout(() => { // [cite: 1]
                content.classList.remove('scale-95', 'opacity-0'); [cite_start]// [cite: 1]
                content.classList.add('scale-100', 'opacity-100'); [cite_start]// [cite: 1]
            }, 50); [cite_start]// [cite: 1]
        }

        [cite_start]function closeImportModal() { // [cite: 1]
            const modal = document.getElementById('import-modal'); [cite_start]// [cite: 1]
            const content = document.getElementById('import-content'); [cite_start]// [cite: 1]
            content.classList.remove('scale-100', 'opacity-100'); [cite_start]// [cite: 1]
            content.classList.add('scale-95', 'opacity-0'); [cite_start]// [cite: 1]
            [cite_start]setTimeout(() => { // [cite: 1]
                modal.classList.add('hidden'); [cite_start]// [cite: 1]
            }, 300); [cite_start]// [cite: 1]
        }

        [cite_start]function parseExcelFile() { // [cite: 1]
            const fileInput = document.getElementById('excel-file-input'); [cite_start]// [cite: 1]
            const file = fileInput.files[0]; [cite_start]// [cite: 1]

            [cite_start]if (!file) { // [cite: 1]
                showGlobalMessage('Mohon pilih file Excel terlebih dahulu.', 'error'); [cite_start]// [cite: 1]
                return; [cite_start]// [cite: 1]
            }

            document.getElementById('review-button').disabled = true; [cite_start]// [cite: 1]
            document.getElementById('review-button').innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Membaca...'; [cite_start]// [cite: 1]

            const reader = new FileReader(); [cite_start]// [cite: 1]
            [cite_start]reader.onload = function(e) { // [cite: 1]
                [cite_start]try { // [cite: 1]
                    const data = e.target.result; [cite_start]// [cite: 1]
                    const workbook = XLSX.read(data, { type: 'array' }); [cite_start]// [cite: 1]
                    const firstSheet = workbook.SheetNames[0]; [cite_start]// [cite: 1]
                    const sheetData = XLSX.utils.sheet_to_json(workbook.Sheets[firstSheet], { header: 1, raw: false }); [cite_start]// [cite: 1]
                    
                    processExcelData(sheetData); [cite_start]// [cite: 1]
                    
                    document.getElementById('step-upload').classList.add('hidden'); [cite_start]// [cite: 1]
                    document.getElementById('step-review').classList.remove('hidden'); [cite_start]// [cite: 1]
                    document.getElementById('review-button').classList.add('hidden'); [cite_start]// [cite: 1]
                    
                    [cite_start]if (parsedImportData.length > 0) { // [cite: 1]
                        document.getElementById('import-submit-button').classList.remove('hidden'); [cite_start]// [cite: 1]
                        document.getElementById('import-submit-button').disabled = false; [cite_start]// [cite: 1]
                        document.getElementById('deletion-warning').classList.remove('hidden'); [cite_start]// [cite: 1]
                    }
                    
                [cite_start]} catch (err) { // [cite: 1]
                    console.error("Excel processing error:", err); [cite_start]// [cite: 1]
                    showGlobalMessage('Gagal memproses file Excel. Pastikan formatnya benar.', 'error'); [cite_start]// [cite: 1]
                }
                document.getElementById('review-button').disabled = false; [cite_start]// [cite: 1]
                document.getElementById('review-button').innerHTML = '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg> Review Data'; [cite_start]// [cite: 1]
            }; [cite_start]// [cite: 1]
            [cite_start]reader.onerror = function(ex) { // [cite: 1]
                showGlobalMessage('Gagal membaca file Excel.', 'error'); [cite_start]// [cite: 1]
                document.getElementById('review-button').disabled = false; [cite_start]// [cite: 1]
                document.getElementById('review-button').innerHTML = '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01"></path></svg> Review Data'; [cite_start]// [cite: 1]
            }; [cite_start]// [cite: 1]
            reader.readAsArrayBuffer(file); [cite_start]// [cite: 1]
        }
        
        [cite_start]function processExcelData(data) { // [cite: 1]
            parsedImportData = []; [cite_start]// [cite: 1]
            activeCardIds = []; [cite_start]// [cite: 1]
            const reviewBody = document.getElementById('review-table-body'); [cite_start]// [cite: 1]
            reviewBody.innerHTML = ''; [cite_start]// [cite: 1]
            [cite_start]if (data.length < 2) { // [cite: 1]
                showGlobalMessage('File Excel kosong atau hanya berisi header.', 'error'); [cite_start]// [cite: 1]
                return; [cite_start]// [cite: 1]
            }
            const rawHeaders = data[0].map(h => String(h).trim()); [cite_start]// [cite: 1]
            const headerMap = {}; [cite_start]// [cite: 1]
            [cite_start]REQUIRED_HEADERS.forEach(requiredHeader => { // [cite: 1]
                const index = rawHeaders.findIndex(h => h.toLowerCase() === requiredHeader.toLowerCase()); [cite_start]// [cite: 1]
                [cite_start]if (index !== -1) { // [cite: 1]
                    headerMap[requiredHeader.toLowerCase()] = index; [cite_start]// [cite: 1]
                }
            }); [cite_start]// [cite: 1]

            const requiredFields = ['card id', 'nik', 'nama', 'departemen']; [cite_start]// [cite: 1]
            let missingHeaders = requiredFields.filter(field => headerMap[field] === undefined); [cite_start]// [cite: 1]
            
            [cite_start]if (missingHeaders.length > 0) { // [cite: 1]
                showGlobalMessage(`Header wajib tidak ditemukan: ${missingHeaders.join(', ')}.`, 'error'); [cite_start]// [cite: 1]
                document.getElementById('review-summary').textContent = `Gagal: Header wajib tidak lengkap.`; [cite_start]// [cite: 1]
                return; [cite_start]// [cite: 1]
            }

            let validCount = 0; [cite_start]// [cite: 1]
            let invalidCount = 0; [cite_start]// [cite: 1]

            [cite_start]for (let i = 1; i < data.length; i++) { // [cite: 1]
                const row = data[i]; [cite_start]// [cite: 1]
                const card = String(row[headerMap['card id']] || '').trim(); [cite_start]// [cite: 1]
                const nik = String(row[headerMap['nik']] || '').trim(); [cite_start]// [cite: 1]
                const nama = String(row[headerMap['nama']] || '').trim(); [cite_start]// [cite: 1]
                const departemen = String(row[headerMap['departemen']] || '').trim(); [cite_start]// [cite: 1]
                const pagi = String(row[headerMap['pagi']] || '').trim(); [cite_start]// [cite: 1]
                const siang = String(row[headerMap['siang']] || '').trim(); [cite_start]// [cite: 1]
                const sore = String(row[headerMap['sore']] || '').trim(); [cite_start]// [cite: 1]
                const malam = String(row[headerMap['malam']] || '').trim(); [cite_start]// [cite: 1]

                let status = 'Valid'; [cite_start]// [cite: 1]
                let reason = ''; [cite_start]// [cite: 1]

                [cite_start]if (!card || !nik || !nama || !departemen) { // [cite: 1]
                    status = 'Gagal'; [cite_start]// [cite: 1]
                    reason = 'Data wajib kosong'; [cite_start]// [cite: 1]
                [cite_start]} else if (activeCardIds.includes(card)) { // [cite: 1]
                    status = 'Gagal'; [cite_start]// [cite: 1]
                    reason = 'Duplikasi Card ID dalam file'; [cite_start]// [cite: 1]
                [cite_start]} else { // [cite: 1]
                    activeCardIds.push(card); [cite_start]// [cite: 1]
                    [cite_start]parsedImportData.push({ // [cite: 1]
                        [cite_start]card: card, // [cite: 1]
                        [cite_start]nik: nik, // [cite: 1]
                        [cite_start]nama: nama, // [cite: 1]
                        [cite_start]departemen: departemen, // [cite: 1]
                        [cite_start]pagi: formatTime(pagi), // [cite: 1]
                        [cite_start]siang: formatTime(siang), // [cite: 1]
                        [cite_start]sore: formatTime(sore), // [cite: 1]
                        [cite_start]malam: formatTime(malam), // [cite: 1]
                        [cite_start]status: status // [cite: 1]
                    }); [cite_start]// [cite: 1]
                    validCount++; [cite_start]// [cite: 1]
                }

                [cite_start]if (status === 'Gagal') { // [cite: 1]
                    invalidCount++; [cite_start]// [cite: 1]
                }
                
                // Tambahkan data ke tabel review (termasuk yang Gagal)
                [cite_start]renderReviewTable({ // [cite: 1]
                    [cite_start]card: card, // [cite: 1]
                    [cite_start]nik: nik, // [cite: 1]
                    [cite_start]nama: nama, // [cite: 1]
                    [cite_start]departemen: departemen, // [cite: 1]
                    [cite_start]pagi: pagi, // [cite: 1]
                    [cite_start]siang: siang, // [cite: 1]
                    [cite_start]sore: sore, // [cite: 1]
                    [cite_start]malam: malam, // [cite: 1]
                    status: `${status}${reason ? [cite_start]' (' + reason + ')' : ''}` // [cite: 1]
                }); [cite_start]// [cite: 1]
            }

            document.getElementById('review-summary').innerHTML = `Ringkasan: **${validCount}** baris data valid siap diproses, **${invalidCount}** baris data diabaikan (gagal/duplikasi).`; [cite_start]// [cite: 1]
            
            [cite_start]if (validCount === 0) { // [cite: 1]
                document.getElementById('import-submit-button').disabled = true; [cite_start]// [cite: 1]
                document.getElementById('deletion-warning').classList.add('hidden'); [cite_start]// [cite: 1]
                showGlobalMessage('Tidak ada data valid yang ditemukan untuk disinkronisasi.', 'error'); [cite_start]// [cite: 1]
            }
        }
        
        [cite_start]function renderReviewTable(item) { // [cite: 1]
            const reviewBody = document.getElementById('review-table-body'); [cite_start]// [cite: 1]
            const row = reviewBody.insertRow(); [cite_start]// [cite: 1]
            row.classList.add('text-gray-700', item.status.includes('Gagal') ? 'bg-red-50' : ''); [cite_start]// [cite: 1]
            row.insertCell().textContent = item.card; [cite_start]// [cite: 1]
            row.insertCell().textContent = item.nik; [cite_start]// [cite: 1]
            row.insertCell().textContent = item.nama; [cite_start]// [cite: 1]
            row.insertCell().textContent = item.departemen; [cite_start]// [cite: 1]
            row.insertCell().textContent = item.pagi; [cite_start]// [cite: 1]
            row.insertCell().textContent = item.siang; [cite_start]// [cite: 1]
            row.insertCell().textContent = item.sore; [cite_start]// [cite: 1]
            row.insertCell().textContent = item.malam; [cite_start]// [cite: 1]
            
            const statusCell = row.insertCell(); [cite_start]// [cite: 1]
            statusCell.textContent = item.status; [cite_start]// [cite: 1]
            statusCell.classList.add(item.status.includes('Gagal') ? 'text-red-600' : 'text-success-green', 'font-semibold'); [cite_start]// [cite: 1]
        }
        
        [cite_start]async function handleImportSubmit(event) { // [cite: 1]
            event.preventDefault(); [cite_start]// [cite: 1]
            [cite_start]if (parsedImportData.length === 0) { // [cite: 1]
                showGlobalMessage('Tidak ada data valid untuk dikirim.', 'error'); [cite_start]// [cite: 1]
                return; [cite_start]// [cite: 1]
            }
            const submitButton = document.getElementById('import-submit-button'); [cite_start]// [cite: 1]
            submitButton.disabled = true; [cite_start]// [cite: 1]
            submitButton.innerHTML = '<svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-white" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg> Memproses...'; [cite_start]// [cite: 1]

            [cite_start]const dataToSend = JSON.stringify({ // [cite: 1]
                [cite_start]action: 'IMPORT_ALL', // [cite: 1]
                [cite_start]data: parsedImportData // [cite: 1]
            }); [cite_start]// [cite: 1]

            [cite_start]try { // [cite: 1]
                [cite_start]const response = await fetch(GOOGLE_APPS_SCRIPT_URL, { // [cite: 1]
                    [cite_start]method: 'POST', // [cite: 1]
                    [cite_start]headers: { // [cite: 1]
                        [cite_start]'Content-Type': 'application/json' // [cite: 1]
                    [cite_start]}, // [cite: 1]
                    [cite_start]body: dataToSend // [cite: 1]
                }); [cite_start]// [cite: 1]

                [cite_start]if (!response.ok) { // [cite: 1]
                    throw new Error(`Server Apps Script Error: ${response.status} ${response.statusText}`); [cite_start]// [cite: 1]
                [cite_start]} // [cite: 1]

                const result = await response.json(); [cite_start]// [cite: 1]

                [cite_start]if (result.status === 'success') { // [cite: 1]
                    showGlobalMessage(`Sinkronisasi Dijadwalkan! ${result.message}`, 'success'); [cite_start]// [cite: 1]
                [cite_start]} else { // [cite: 1]
                    throw new Error(result.message || 'Gagal menyimpan data sementara ke Apps Script.'); [cite_start]// [cite: 1]
                [cite_start]} // [cite: 1]

            [cite_start]} catch (error) { // [cite: 1]
                console.error("Import Scheduling Error:", error); [cite_start]// [cite: 1]
                showGlobalMessage(`Gagal menjadwalkan import: ${error.message}. Cek log Apps Script Anda.`, 'error'); [cite_start]// [cite: 1]
            [cite_start]} finally { // [cite: 1]
                closeImportModal(); [cite_start]// [cite: 1]
                submitButton.innerHTML = '<svg class="w-4 h-4 mr-1" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 10V3L4 14h7v7l9-11h-7z"></path></svg> Hapus Lama & Ganti Baru'; [cite_start]// [cite: 1]
                submitButton.disabled = false; [cite_start]// [cite: 1]
                fetchData(); [cite_start]// [cite: 1]
            }
        }

        [cite_start]async function fetchLogData() { // [cite: 1]
            const container = document.getElementById('log-per-tanggal-container'); [cite_start]// [cite: 1]
            const loadingMsg = document.getElementById('loading-log-message'); [cite_start]// [cite: 1]
            const noLogMsg = document.getElementById('no-log-message'); [cite_start]// [cite: 1]
            container.innerHTML = ''; [cite_start]// [cite: 1]
            loadingMsg.classList.remove('hidden'); [cite_start]// [cite: 1]
            noLogMsg.classList.add('hidden'); [cite_start]// [cite: 1]

            // 1. Ambil data master untuk pengayaan log
            [cite_start]const { data: employees, error: employeeError } = await supabaseClient // [cite: 1]
                [cite_start].from(TABLE_NAME) // [cite: 1]
                .select('card, nama, departemen'); [cite_start]// [cite: 1]

            [cite_start]if (employeeError) { // [cite: 1]
                console.error("Error fetching employees for log enrichment:", employeeError); [cite_start]// [cite: 1]
                showGlobalMessage('Gagal memuat data master karyawan untuk log.', 'error'); [cite_start]// [cite: 1]
            }
            const employeeMap = new Map(); [cite_start]// [cite: 1]
            [cite_start]if (employees) { // [cite: 1]
                employees.forEach(emp => employeeMap.set(emp.card, emp)); [cite_start]// [cite: 1]
            [cite_start]} // [cite: 1]

            // 2. Ambil Log Absensi 7 Hari Terakhir
            const sevenDaysAgo = getDateNDaysAgo(7); [cite_start]// [cite: 1]
            [cite_start]const { data: logs, error: logError } = await supabaseClient // [cite: 1]
                [cite_start].from(LOG_TABLE_NAME) // [cite: 1]
                [cite_start].select('card, status, periode, created_at, nama, departemen') // [cite: 1]
                [cite_start].gte('created_at', sevenDaysAgo) // [cite: 1]
                .order('created_at', { ascending: false }); [cite_start]// [cite: 1]

            loadingMsg.classList.add('hidden'); [cite_start]// [cite: 1]
            [cite_start]if (logError) { // [cite: 1]
                console.error("Error fetching logs:", logError); [cite_start]// [cite: 1]
                showGlobalMessage(`Gagal memuat log absensi: ${logError.message}`, 'error'); [cite_start]// [cite: 1]
                container.innerHTML = '<p class="text-center py-4 text-red-500">Gagal memuat data log.</p>'; [cite_start]// [cite: 1]
                return; [cite_start]// [cite: 1]
            }
            
            // --- PERBAIKAN: Melengkapi data log absensi dengan data master jika kosong ---
            [cite_start]const enrichedLogs = logs.map(log => { // [cite: 1]
                const isDataMissing = !log.nama || log.nama.trim() === '-' || !log.departemen || log.departemen.trim() === '-'; [cite_start]// [cite: 1]
                [cite_start]if (log.status === 'Sukses' && isDataMissing) { // [cite: 1]
                    const employee = employeeMap.get(log.card); [cite_start]// [cite: 1]
                    [cite_start]if (employee) { // [cite: 1]
                        return { ...log, nama: employee.nama || 'Tidak Terdaftar', departemen: employee.departemen || '-' }; [cite_start]// [cite: 1]
                    }
                }
                return log; [cite_start]// [cite: 1]
            }); [cite_start]// [cite: 1]
            // --- AKHIR PERBAIKAN ---

            allAbsensiLogs = enrichedLogs; [cite_start]// [cite: 1]
            renderGroupedLogDetails(enrichedLogs); [cite_start]// [cite: 1]

            [cite_start]if (enrichedLogs.length === 0) { // [cite: 1]
                noLogMsg.classList.remove('hidden'); [cite_start]// [cite: 1]
            }
        }
        
        [cite_start]function groupLogsByDate(logs) { // [cite: 1]
            const grouped = {}; [cite_start]// [cite: 1]
            [cite_start]logs.forEach(log => { // [cite: 1]
                const dateKey = new Date(log.created_at).toISOString().split('T')[0]; [cite_start]// [cite: 1]
                [cite_start]if (!grouped[dateKey]) { // [cite: 1]
                    grouped[dateKey] = []; [cite_start]// [cite: 1]
                }
                grouped[dateKey].push(log); [cite_start]// [cite: 1]
            }); [cite_start]// [cite: 1]
            return grouped; [cite_start]// [cite: 1]
        }

        [cite_start]function renderGroupedLogDetails(logs) { // [cite: 1]
            const container = document.getElementById('log-per-tanggal-container'); [cite_start]// [cite: 1]
            container.innerHTML = ''; [cite_start]// [cite: 1]
            if (logs.length === 0) return; [cite_start]// [cite: 1]
            const groupedLogs = groupLogsByDate(logs); [cite_start]// [cite: 1]
            const sortedDates = Object.keys(groupedLogs).sort((a, b) => new Date(b) - new Date(a)); [cite_start]// [cite: 1]

            [cite_start]sortedDates.forEach(dateKey => { // [cite: 1]
                const logsForDate = groupedLogs[dateKey]; [cite_start]// [cite: 1]
                const dateForDisplay = new Date(dateKey).toLocaleDateString('id-ID', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' }); [cite_start]// [cite: 1]

                const dateSection = document.createElement('div'); [cite_start]// [cite: 1]
                dateSection.className = 'bg-white rounded-xl shadow-md p-4 border border-gray-200'; [cite_start]// [cite: 1]

                const header = document.createElement('div'); [cite_start]// [cite: 1]
                header.className = 'flex justify-between items-center pb-2 border-b border-gray-100'; [cite_start]// [cite: 1]
                [cite_start]header.innerHTML = ` // [cite: 1]
                    <div class="flex items-center space-x-3 text-indigo-600">
                        <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M8 7V3m8 4V3m-9 8h.01M11 15h.01M15 15h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0zm-9 3h.01M8 21h8a2 2 0 002-2v-4a2 2 0 00-2-2H8a2 2 0 00-2 2v4a2 2 0 002 2z"></path></svg>
                        <span class="text-lg font-bold">${dateForDisplay}</span>
                        <span class="text-sm bg-indigo-500 px-2 py-0.5 rounded-full font-medium">(${logsForDate.length} log)</span>
                    </div>
                    <div class="flex items-center space-x-3">
                        <button onclick="exportSingleDayLogToExcel('${dateKey}')" class="bg-indigo-700 text-white px-3 py-1.5 rounded-lg font-medium text-sm hover:bg-indigo-800 transition duration-300 flex items-center btn-primary">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-4 w-4 mr-1" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M3 17a1 1 0 011-1h12a1 1 0 110 2H4a1 1 0 01-1-1zm3.293-7.707a1 1 0 011.414 0L9 10.586V3a1 1 0 112 0v7.586l1.293-1.293a1 1 0 111.414 1.414l-3 3a1 1 0 01-1.414 0l-3-3a1 1 0 010-1.414z" clip-rule="evenodd" /></svg> Export 
                        </button>
                        <button onclick="toggleLogDetails(this, 'log-table-${dateKey}')" class="text-white text-sm focus:outline-none p-1 rounded hover:bg-indigo-500 bg-indigo-600">
                            <svg class="w-5 h-5 transition-transform duration-300" data-toggle="collapse" viewBox="0 
                            0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M5.293 7.293a1 1 0 011.414 0L10 10.586l3.293-3.293a1 1 0 111.414 1.414l-4 4a1 1 0 01-1.414 0l-4-4a1 1 0 010-1.414z" clip-rule="evenodd" /></svg>
                        </button>
                    </div>
                `; [cite_start]// [cite: 1]
                dateSection.appendChild(header); [cite_start]// [cite: 1]

                const detailContainer = document.createElement('div'); [cite_start]// [cite: 1]
                detailContainer.id = `log-table-${dateKey}`; [cite_start]// [cite: 1]
                detailContainer.className = 'overflow-x-auto max-h-96 hidden custom-scroll mt-3'; [cite_start]// [cite: 1]
                
                const table = document.createElement('table'); [cite_start]// [cite: 1]
                table.className = 'w-full text-sm text-left text-gray-600 admin-table'; [cite_start]// [cite: 1]
                
                const tableHeader = table.createTHead(); [cite_start]// [cite: 1]
                tableHeader.classList.add('log-table-header'); [cite_start]// [cite: 1]
                [cite_start]tableHeader.innerHTML = ` // [cite: 1]
                    <tr>
                        <th class="w-1/6">Waktu Tap</th>
                        <th class="w-1/6">Card ID</th>
                        <th class="w-2/6">Nama Karyawan</th>
                        <th class="w-1/6">Departemen</th>
                        <th class="w-1/6">Periode</th>
                        <th class="w-1/12">Status</th>
                    </tr>
                `; [cite_start]// [cite: 1]
                
                const tableBody = table.createTBody(); [cite_start]// [cite: 1]
                [cite_start]logsForDate.forEach(log => { // [cite: 1]
                    const row = tableBody.insertRow(); [cite_start]// [cite: 1]
                    const dateObj = new Date(log.created_at); [cite_start]// [cite: 1]
                    const logTime = dateObj.toLocaleTimeString('id-ID', { hour: '2-digit', minute: '2-digit', second: '2-digit' }); [cite_start]// [cite: 1]
                    const statusClass = log.status === 'Sukses' ? 'text-success-green font-semibold' : 'text-error-red font-semibold'; [cite_start]// [cite: 1]
                    
                    row.insertCell().textContent = logTime; [cite_start]// [cite: 1]
                    row.insertCell().textContent = log.card; [cite_start]// [cite: 1]
                    row.insertCell().textContent = log.nama || 'Tidak Terdaftar'; [cite_start]// [cite: 1]
                    row.insertCell().textContent = log.departemen || '-'; [cite_start]// [cite: 1]
                    row.insertCell().textContent = log.periode || '-'; [cite_start]// [cite: 1]
                    
                    const statusCell = row.insertCell(); [cite_start]// [cite: 1]
                    statusCell.innerHTML = `<span class="${statusClass}">${log.status}</span>`; [cite_start]// [cite: 1]
                }); [cite_start]// [cite: 1]

                detailContainer.appendChild(table); [cite_start]// [cite: 1]
                dateSection.appendChild(detailContainer); [cite_start]// [cite: 1]
                container.appendChild(dateSection); [cite_start]// [cite: 1]
            }); [cite_start]// [cite: 1]
        }

        [cite_start]function toggleLogDetails(button, tableId) { // [cite: 1]
            const detailElement = document.getElementById(tableId); [cite_start]// [cite: 1]
            const svg = button.querySelector('svg'); [cite_start]// [cite: 1]
            
            [cite_start]if (detailElement.classList.contains('hidden')) { // [cite: 1]
                detailElement.classList.remove('hidden'); [cite_start]// [cite: 1]
                svg.style.transform = 'rotate(180deg)'; [cite_start]// [cite: 1]
                button.classList.remove('bg-indigo-600'); // NEW
                button.classList.add('bg-indigo-500'); // NEW
            [cite_start]} else { // [cite: 1]
                detailElement.classList.add('hidden'); [cite_start]// [cite: 1]
                svg.style.transform = 'rotate(0deg)'; [cite_start]// [cite: 1]
                button.classList.remove('bg-indigo-500'); // NEW
                button.classList.add('bg-indigo-600'); // NEW
            }
        }

        [cite_start]function exportSingleDayLogToExcel(dateKey) { // [cite: 1]
            [cite_start]const logsToExport = allAbsensiLogs.filter(log => { // [cite: 1]
                return new Date(log.created_at).toISOString().split('T')[0] === dateKey; [cite_start]// [cite: 1]
            }); [cite_start]// [cite: 1]

            [cite_start]if (logsToExport.length === 0) { // [cite: 1]
                showGlobalMessage(`Tidak ada data log untuk tanggal ${dateKey}.`, 'error'); [cite_start]// [cite: 1]
                return; [cite_start]// [cite: 1]
            }

            [cite_start]const wsData = [ // [cite: 1]
                [cite_start]["Tanggal & Waktu", "Card ID", "Nama Karyawan", "Departemen", "Periode", "Status Tap", "created_at (Raw)"] // [cite: 1]
            ]; [cite_start]// [cite: 1]

            [cite_start]logsToExport.forEach(log => { // [cite: 1]
                const dateObj = new Date(log.created_at); [cite_start]// [cite: 1]
                const logDateTime = dateObj.toLocaleDateString('id-ID', { year: 'numeric', month: 'long', day: 'numeric', hour: '2-digit', minute: '2-digit', second: '2-digit' }) + ' ' + dateObj.toLocaleTimeString('id-ID'); [cite_start]// [cite: 1]
                
                [cite_start]wsData.push([ // [cite: 1]
                    [cite_start]logDateTime, // [cite: 1]
                    [cite_start]log.card, // [cite: 1]
                    log.nama || [cite_start]'Tidak Terdaftar', // [cite: 1]
                    log.departemen || [cite_start]'-', // [cite: 1]
                    log.periode || [cite_start]'-', // [cite: 1]
                    [cite_start]log.status, // [cite: 1]
                    [cite_start]log.created_at // [cite: 1]
                ]); [cite_start]// [cite: 1]
            }); [cite_start]// [cite: 1]

            const ws = XLSX.utils.aoa_to_sheet(wsData); [cite_start]// [cite: 1]
            const wb = XLSX.utils.book_new(); [cite_start]// [cite: 1]
            XLSX.utils.book_append_sheet(wb, ws, `Log_${dateKey}`); [cite_start]// [cite: 1]
            XLSX.writeFile(wb, `Log_Absensi_${dateKey}.xlsx`); [cite_start]// [cite: 1]
            
            showGlobalMessage(`Berhasil mengekspor ${logsToExport.length} log untuk tanggal ${dateKey} ke Excel.`, 'success'); [cite_start]// [cite: 1]
        }
        
    </script>
</body>
</html>
