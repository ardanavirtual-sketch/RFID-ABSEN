<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Admin - Sistem Absensi Modern</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            /* WPOcean Color Palette */
            --wp-primary: #0073aa;
            --wp-primary-dark: #005a87;
            --wp-secondary: #23282d;
            --wp-secondary-light: #32373c;
            --wp-accent: #00a0d2;
            --wp-success: #46b450;
            --wp-warning: #ffb900;
            --wp-error: #dc3232;
            --wp-text: #23282d;
            --wp-text-light: #72777c;
            --wp-border: #ccd0d4;
            --wp-bg: #f1f1f1;
            --wp-card: #ffffff;
            
            /* Dark mode colors */
            --dark-bg: #1a1d21;
            --dark-card: #2c3138;
            --dark-text: #e4e6eb;
            --dark-border: #3e444c;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Poppins', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e4e6eb 100%);
            color: var(--wp-text);
            transition: all 0.3s ease;
        }

        body.dark-mode {
            background: linear-gradient(135deg, var(--dark-bg) 0%, #23272f 100%);
            color: var(--dark-text);
        }

        /* Glassmorphism Effect */
        .glass-card {
            background: rgba(255, 255, 255, 0.85);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.2);
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }

        .dark-mode .glass-card {
            background: rgba(44, 49, 56, 0.85);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        /* Sidebar */
        #sidebar {
            background: linear-gradient(180deg, var(--wp-secondary) 0%, #1a1d21 100%);
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
            box-shadow: 5px 0 15px rgba(0, 0, 0, 0.1);
        }

        #sidebar.collapsed {
            width: 70px;
        }

        #sidebar.collapsed .sidebar-text {
            display: none;
        }

        #sidebar.collapsed .logo-text {
            display: none;
        }

        #sidebar.collapsed .user-info {
            display: none;
        }

        #sidebar.collapsed .toggle-btn {
            transform: rotate(180deg);
        }

        /* Sidebar Navigation */
        .nav-item {
            position: relative;
            transition: all 0.3s ease;
            border-radius: 10px;
            overflow: hidden;
        }

        .nav-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            height: 100%;
            width: 3px;
            background: var(--wp-accent);
            transform: scaleY(0);
            transition: transform 0.3s ease;
        }

        .nav-item.active::before {
            transform: scaleY(1);
        }

        .nav-item:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateX(5px);
        }

        .nav-item.active {
            background: rgba(0, 115, 170, 0.2);
        }

        /* Main Content */
        .content-wrapper {
            transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }

        .sidebar-expanded .content-wrapper {
            margin-left: 250px;
        }

        .sidebar-collapsed .content-wrapper {
            margin-left: 70px;
        }

        /* Stats Cards */
        .stat-card {
            position: relative;
            overflow: hidden;
            transition: transform 0.3s ease, box-shadow 0.3s ease;
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--wp-primary), var(--wp-accent));
        }

        .stat-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.15);
        }

        .dark-mode .stat-card:hover {
            box-shadow: 0 15px 30px rgba(0, 0, 0, 0.3);
        }

        /* Button Styles */
        .btn-primary {
            background: linear-gradient(135deg, var(--wp-primary), var(--wp-accent));
            transition: all 0.3s ease;
        }

        .btn-primary:hover {
            background: linear-gradient(135deg, var(--wp-primary-dark), var(--wp-primary));
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(0, 115, 170, 0.3);
        }

        .btn-success {
            background: linear-gradient(135deg, var(--wp-success), #3aa355);
        }

        .btn-danger {
            background: linear-gradient(135deg, var(--wp-error), #c92c2c);
        }

        .btn-warning {
            background: linear-gradient(135deg, var(--wp-warning), #e6a400);
        }

        /* Table Styles */
        .data-table {
            border-collapse: separate;
            border-spacing: 0;
        }

        .data-table thead {
            background: linear-gradient(135deg, var(--wp-primary), var(--wp-accent));
            color: white;
        }

        .data-table th {
            padding: 15px;
            font-weight: 600;
            text-transform: uppercase;
            font-size: 0.85rem;
            letter-spacing: 0.5px;
        }

        .data-table tbody tr {
            transition: all 0.2s ease;
            border-bottom: 1px solid var(--wp-border);
        }

        .dark-mode .data-table tbody tr {
            border-bottom-color: var(--dark-border);
        }

        .data-table tbody tr:hover {
            background: rgba(0, 115, 170, 0.05);
            transform: scale(1.002);
        }

        .dark-mode .data-table tbody tr:hover {
            background: rgba(0, 115, 170, 0.1);
        }

        .data-table td {
            padding: 15px;
            vertical-align: middle;
        }

        /* Badge Styles */
        .badge {
            display: inline-block;
            padding: 4px 12px;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }

        .badge-success {
            background: rgba(70, 180, 80, 0.1);
            color: var(--wp-success);
            border: 1px solid rgba(70, 180, 80, 0.3);
        }

        .badge-error {
            background: rgba(220, 50, 50, 0.1);
            color: var(--wp-error);
            border: 1px solid rgba(220, 50, 50, 0.3);
        }

        .badge-warning {
            background: rgba(255, 185, 0, 0.1);
            color: var(--wp-warning);
            border: 1px solid rgba(255, 185, 0, 0.3);
        }

        .badge-info {
            background: rgba(0, 160, 210, 0.1);
            color: var(--wp-accent);
            border: 1px solid rgba(0, 160, 210, 0.3);
        }

        /* Modal Styles */
        .modal-overlay {
            background: rgba(0, 0, 0, 0.7);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            animation: modalSlideIn 0.3s ease-out;
            background: linear-gradient(135deg, var(--wp-card) 0%, #f8f9fa 100%);
        }

        .dark-mode .modal-content {
            background: linear-gradient(135deg, var(--dark-card) 0%, #252a32 100%);
        }

        @keyframes modalSlideIn {
            from {
                opacity: 0;
                transform: translateY(-20px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Progress Bar */
        .progress-bar {
            height: 8px;
            border-radius: 4px;
            background: var(--wp-border);
            overflow: hidden;
        }

        .dark-mode .progress-bar {
            background: var(--dark-border);
        }

        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--wp-primary), var(--wp-accent));
            border-radius: 4px;
            transition: width 0.6s ease;
        }

        /* Custom Scrollbar */
        .custom-scrollbar::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .custom-scrollbar::-webkit-scrollbar-track {
            background: rgba(0, 0, 0, 0.05);
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb {
            background: var(--wp-primary);
            border-radius: 3px;
        }

        .custom-scrollbar::-webkit-scrollbar-thumb:hover {
            background: var(--wp-primary-dark);
        }

        /* Toggle Switch */
        .toggle-switch {
            position: relative;
            display: inline-block;
            width: 60px;
            height: 30px;
        }

        .toggle-switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .toggle-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: var(--wp-border);
            transition: .4s;
            border-radius: 34px;
        }

        .toggle-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 4px;
            bottom: 4px;
            background: white;
            transition: .4s;
            border-radius: 50%;
        }

        input:checked + .toggle-slider {
            background: linear-gradient(135deg, var(--wp-primary), var(--wp-accent));
        }

        input:checked + .toggle-slider:before {
            transform: translateX(30px);
        }

        /* Loading Animation */
        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid rgba(0, 115, 170, 0.2);
            border-top-color: var(--wp-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Floating Action Button */
        .fab {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, var(--wp-primary), var(--wp-accent));
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            box-shadow: 0 5px 20px rgba(0, 115, 170, 0.3);
            cursor: pointer;
            transition: all 0.3s ease;
            z-index: 1000;
        }

        .fab:hover {
            transform: scale(1.1) rotate(90deg);
            box-shadow: 0 8px 25px rgba(0, 115, 170, 0.4);
        }

        /* Breadcrumb */
        .breadcrumb {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .breadcrumb-item {
            color: var(--wp-text-light);
            font-size: 0.9rem;
        }

        .breadcrumb-item.active {
            color: var(--wp-primary);
            font-weight: 600;
        }

        .breadcrumb-separator {
            color: var(--wp-text-light);
        }

        /* Empty State */
        .empty-state {
            text-align: center;
            padding: 60px 20px;
        }

        .empty-state i {
            font-size: 64px;
            color: var(--wp-text-light);
            margin-bottom: 20px;
        }

        .dark-mode .empty-state i {
            color: var(--dark-border);
        }

        /* Chart Container */
        .chart-container {
            position: relative;
            height: 300px;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            #sidebar {
                position: fixed;
                left: -250px;
                z-index: 1000;
            }
            
            #sidebar.show {
                left: 0;
            }
            
            .content-wrapper {
                margin-left: 0 !important;
            }
            
            .mobile-menu-btn {
                display: block;
            }
            
            .stat-card {
                margin-bottom: 20px;
            }
        }

        /* Animation Classes */
        .fade-in {
            animation: fadeIn 0.5s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }

        .slide-in {
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from { transform: translateX(-20px); opacity: 0; }
            to { transform: translateX(0); opacity: 1; }
        }

        /* Notification Badge */
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: var(--wp-error);
            color: white;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 0.7rem;
            font-weight: bold;
        }
    </style>
</head>
<body class="light-mode">
    
    <!-- Floating Action Button -->
    <div class="fab" id="fab" onclick="toggleSidebar()">
        <i class="fas fa-bars"></i>
    </div>

    <!-- Sidebar -->
    <div id="sidebar" class="fixed left-0 top-0 h-screen w-64 z-50">
        <div class="h-full flex flex-col">
            <!-- Logo -->
            <div class="p-6 border-b border-gray-800 flex items-center justify-between">
                <div class="flex items-center space-x-3">
                    <div class="w-10 h-10 rounded-xl bg-gradient-to-br from-[#0073aa] to-[#00a0d2] flex items-center justify-center shadow-lg">
                        <i class="fas fa-tachometer-alt text-white text-lg"></i>
                    </div>
                    <div class="logo-text">
                        <h1 class="text-xl font-bold text-white">Portal<span class="text-[#00a0d2]">Admin GAS</span></h1>
                        <p class="text-xs text-gray-400">Sistem Tapping Vendor</p>
                    </div>
                </div>
                <button id="sidebar-toggle" onclick="toggleSidebar()" class="toggle-btn w-8 h-8 rounded-lg bg-gray-800 hover:bg-gray-700 flex items-center justify-center text-white transition-transform">
                    <i class="fas fa-chevron-left"></i>
                </button>
            </div>

            <!-- User Profile -->
            <div class="p-4 border-b border-gray-800 user-info">
                <div class="flex items-center space-x-3">
                    <div class="w-12 h-12 rounded-full bg-gradient-to-br from-[#0073aa] to-[#00a0d2] flex items-center justify-center relative">
                        <i class="fas fa-user text-white text-lg"></i>
                        <div class="absolute -bottom-1 -right-1 w-5 h-5 bg-[#46b450] rounded-full border-2 border-gray-900"></div>
                    </div>
                    <div class="flex-1">
                        <h3 class="text-sm font-semibold text-white" id="admin-name">Administrator</h3>
                        <p class="text-xs text-gray-400">Super Admin</p>
                    </div>
                </div>
            </div>

            <!-- Navigation -->
            <nav class="flex-1 p-4 space-y-2 overflow-y-auto custom-scrollbar">
                <div class="nav-item active" onclick="switchView('dashboard')">
                    <div class="flex items-center p-3 text-gray-300 hover:text-white cursor-pointer">
                        <div class="w-8 h-8 rounded-lg bg-[#0073aa]/20 flex items-center justify-center mr-3">
                            <i class="fas fa-home text-[#00a0d2]"></i>
                        </div>
                        <span class="sidebar-text text-sm font-medium">Dashboard</span>
                    </div>
                </div>

                <div class="nav-item" onclick="switchView('karyawan')">
                    <div class="flex items-center p-3 text-gray-300 hover:text-white cursor-pointer">
                        <div class="w-8 h-8 rounded-lg bg-[#0073aa]/20 flex items-center justify-center mr-3">
                            <i class="fas fa-users text-[#00a0d2]"></i>
                        </div>
                        <span class="sidebar-text text-sm font-medium">Data Karyawan</span>
                    </div>
                </div>

                <div class="nav-item" onclick="switchView('absensi')">
                    <div class="flex items-center p-3 text-gray-300 hover:text-white cursor-pointer">
                        <div class="w-8 h-8 rounded-lg bg-[#0073aa]/20 flex items-center justify-center mr-3">
                            <i class="fas fa-clipboard-list text-[#00a0d2]"></i>
                        </div>
                        <span class="sidebar-text text-sm font-medium">Log Absensi</span>
                        <span class="ml-auto notification-badge">5</span>
                    </div>
                </div>

                <div class="nav-item" onclick="switchView('laporan')">
                    <div class="flex items-center p-3 text-gray-300 hover:text-white cursor-pointer">
                        <div class="w-8 h-8 rounded-lg bg-[#0073aa]/20 flex items-center justify-center mr-3">
                            <i class="fas fa-chart-bar text-[#00a0d2]"></i>
                        </div>
                        <span class="sidebar-text text-sm font-medium">Laporan</span>
                    </div>
                </div>

                <div class="nav-item" onclick="switchView('pengaturan')">
                    <div class="flex items-center p-3 text-gray-300 hover:text-white cursor-pointer">
                        <div class="w-8 h-8 rounded-lg bg-[#0073aa]/20 flex items-center justify-center mr-3">
                            <i class="fas fa-cog text-[#00a0d2]"></i>
                        </div>
                        <span class="sidebar-text text-sm font-medium">Pengaturan</span>
                    </div>
                </div>

                <!-- Theme Toggle -->
                <div class="mt-8 p-4 border-t border-gray-800">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center space-x-3">
                            <div class="w-8 h-8 rounded-lg bg-[#0073aa]/20 flex items-center justify-center">
                                <i class="fas fa-moon text-[#00a0d2]"></i>
                            </div>
                            <span class="sidebar-text text-sm text-gray-300">Dark Mode</span>
                        </div>
                        <label class="toggle-switch">
                            <input type="checkbox" id="theme-toggle" onchange="toggleTheme()">
                            <span class="toggle-slider"></span>
                        </label>
                    </div>
                </div>
            </nav>

            <!-- Footer -->
            <div class="p-4 border-t border-gray-800">
                <button onclick="handleLogout()" class="w-full flex items-center justify-center p-3 bg-gradient-to-r from-[#dc3232] to-[#c92c2c] text-white rounded-lg hover:from-[#c92c2c] hover:to-[#b52727] transition-all shadow-lg">
                    <i class="fas fa-sign-out-alt mr-2"></i>
                    <span class="sidebar-text text-sm font-medium">Keluar</span>
                </button>
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div class="content-wrapper min-h-screen transition-all duration-300">
        <!-- Top Bar -->
        <header class="glass-card sticky top-0 z-40">
            <div class="px-6 py-4">
                <div class="flex items-center justify-between">
                    <!-- Breadcrumb -->
                    <div class="breadcrumb">
                        <span class="breadcrumb-item">Admin</span>
                        <span class="breadcrumb-separator">/</span>
                        <span class="breadcrumb-item active" id="breadcrumb-current">Dashboard</span>
                    </div>

                    <!-- Right Actions -->
                    <div class="flex items-center space-x-4">
                        <!-- Search -->
                        <div class="relative hidden md:block">
                            <input type="text" placeholder="Cari..." 
                                   class="pl-10 pr-4 py-2 w-64 rounded-lg border border-gray-300 bg-white/50 focus:outline-none focus:ring-2 focus:ring-[#0073aa]/30 focus:border-[#0073aa] dark:bg-gray-800/50 dark:border-gray-600 dark:text-white">
                            <i class="fas fa-search absolute left-3 top-2.5 text-gray-400"></i>
                        </div>

                        <!-- Notifications -->
                        <div class="relative">
                            <button class="w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 dark:bg-gray-800 dark:hover:bg-gray-700 flex items-center justify-center relative">
                                <i class="fas fa-bell text-gray-600 dark:text-gray-300"></i>
                                <span class="notification-badge">3</span>
                            </button>
                        </div>

                        <!-- Mobile Menu Button -->
                        <button class="mobile-menu-btn w-10 h-10 rounded-lg bg-[#0073aa] text-white flex items-center justify-center md:hidden" onclick="toggleMobileMenu()">
                            <i class="fas fa-bars"></i>
                        </button>
                    </div>
                </div>
            </div>
        </header>

        <!-- Content Area -->
        <main class="p-6">
            <!-- Global Message -->
            <div id="global-message" class="mb-6 hidden">
                <div class="p-4 rounded-lg shadow-lg">
                    <div class="flex items-center justify-between">
                        <div class="flex items-center">
                            <i class="fas fa-check-circle mr-3 text-[#46b450]"></i>
                            <span id="message-text"></span>
                        </div>
                        <button onclick="hideMessage()" class="text-gray-400 hover:text-gray-600">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                </div>
            </div>

            <!-- Dashboard View -->
            <div id="dashboard-view" class="space-y-6">
                <!-- Welcome Banner -->
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex flex-col md:flex-row items-start md:items-center justify-between">
                        <div>
                            <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-2">
                                Selamat Datang, <span id="greeting-name">Admin</span>! ðŸ‘‹
                            </h1>
                            <p class="text-gray-600 dark:text-gray-300">
                                Kelola sistem absensi karyawan dengan mudah dan efisien.
                            </p>
                        </div>
                        <div class="mt-4 md:mt-0">
                            <div class="text-sm text-gray-500 dark:text-gray-400">
                                <i class="fas fa-calendar-alt mr-2"></i>
                                <span id="current-date"></span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Stats Grid -->
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6" id="dashboard-stats">
                    <!-- Stats will be loaded here -->
                </div>

                <!-- Quick Actions -->
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <!-- Recent Activity -->
                    <div class="glass-card rounded-2xl p-6 lg:col-span-2">
                        <div class="flex items-center justify-between mb-6">
                            <h2 class="text-xl font-bold text-gray-800 dark:text-white">
                                <i class="fas fa-history mr-2 text-[#0073aa]"></i>
                                Aktivitas Terbaru
                            </h2>
                            <button class="text-sm text-[#0073aa] hover:text-[#005a87] font-medium">
                                Lihat Semua â†’
                            </button>
                        </div>
                        <div class="space-y-4" id="recent-activity">
                            <!-- Activity items will be loaded here -->
                        </div>
                    </div>

                    <!-- System Status -->
                    <div class="glass-card rounded-2xl p-6">
                        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-6">
                            <i class="fas fa-server mr-2 text-[#0073aa]"></i>
                            Status Sistem
                        </h2>
                        <div class="space-y-4" id="system-status">
                            <!-- Status items will be loaded here -->
                        </div>
                    </div>
                </div>

                <!-- Charts Section -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
                    <!-- Attendance Chart -->
                    <div class="glass-card rounded-2xl p-6">
                        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-6">
                            <i class="fas fa-chart-line mr-2 text-[#0073aa]"></i>
                            Statistik Absensi
                        </h2>
                        <div class="chart-container">
                            <canvas id="attendanceChart"></canvas>
                        </div>
                    </div>

                    <!-- Department Distribution -->
                    <div class="glass-card rounded-2xl p-6">
                        <h2 class="text-xl font-bold text-gray-800 dark:text-white mb-6">
                            <i class="fas fa-pie-chart mr-2 text-[#0073aa]"></i>
                            Distribusi Departemen
                        </h2>
                        <div class="chart-container">
                            <canvas id="departmentChart"></canvas>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Data Karyawan View -->
            <div id="karyawan-view" class="space-y-6 hidden">
                <!-- Header -->
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-2">
                            <i class="fas fa-users mr-3 text-[#0073aa]"></i>
                            Data Karyawan
                        </h1>
                        <p class="text-gray-600 dark:text-gray-300">
                            Kelola informasi dan data karyawan
                        </p>
                    </div>
                    <div class="flex space-x-3 mt-4 md:mt-0">
                        <button onclick="openImportModal()" class="btn-primary px-5 py-2.5 rounded-lg font-semibold flex items-center">
                            <i class="fas fa-file-import mr-2"></i>
                            Import Excel
                        </button>
                        <button onclick="openFormModal('create')" class="btn-success px-5 py-2.5 rounded-lg font-semibold flex items-center">
                            <i class="fas fa-user-plus mr-2"></i>
                            Tambah Baru
                        </button>
                    </div>
                </div>

                <!-- Search and Filter -->
                <div class="glass-card rounded-2xl p-6">
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-4 mb-6">
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-id-card mr-2"></i>Cari Card ID
                            </label>
                            <input type="text" id="search-card" placeholder="Masukkan Card ID..." 
                                   class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-gray-800/50 focus:outline-none focus:ring-2 focus:ring-[#0073aa]/30 focus:border-[#0073aa]">
                        </div>
                        <div>
                            <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                <i class="fas fa-user mr-2"></i>Cari Nama
                            </label>
                            <input type="text" id="search-nama" placeholder="Masukkan nama..." 
                                   class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-gray-800/50 focus:outline-none focus:ring-2 focus:ring-[#0073aa]/30 focus:border-[#0073aa]">
                        </div>
                        <div class="flex items-end space-x-3">
                            <button onclick="applySearchFilter()" class="btn-primary px-5 py-2.5 rounded-lg font-semibold flex-1">
                                <i class="fas fa-search mr-2"></i>Cari
                            </button>
                            <button onclick="clearSearchFilter()" class="px-5 py-2.5 rounded-lg font-semibold bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600">
                                <i class="fas fa-redo"></i>
                            </button>
                        </div>
                    </div>

                    <!-- Stats -->
                    <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="employee-stats">
                        <!-- Stats will be loaded here -->
                    </div>

                    <!-- Data Table -->
                    <div class="overflow-x-auto rounded-xl border border-gray-200 dark:border-gray-700">
                        <table class="data-table w-full">
                            <thead>
                                <tr>
                                    <th>Card ID</th>
                                    <th>NIK</th>
                                    <th>Nama</th>
                                    <th>Departemen</th>
                                    <th class="text-center">Pagi</th>
                                    <th class="text-center">Siang</th>
                                    <th class="text-center">Sore</th>
                                    <th class="text-center">Malam</th>
                                    <th class="text-center">Aksi</th>
                                </tr>
                            </thead>
                            <tbody id="data-table-body">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>

                    <!-- Empty State -->
                    <div id="no-data-message" class="empty-state hidden">
                        <i class="fas fa-users"></i>
                        <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">Belum ada data karyawan</h3>
                        <p class="text-gray-500 dark:text-gray-400 mb-4">Mulai dengan menambahkan karyawan baru atau mengimpor data dari Excel</p>
                        <button onclick="openFormModal('create')" class="btn-primary px-5 py-2.5 rounded-lg font-semibold">
                            <i class="fas fa-user-plus mr-2"></i>Tambah Karyawan Pertama
                        </button>
                    </div>
                </div>
            </div>

            <!-- Log Absensi View -->
            <div id="absensi-view" class="space-y-6 hidden">
                <!-- Header -->
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-2">
                            <i class="fas fa-clipboard-list mr-3 text-[#0073aa]"></i>
                            Log Absensi
                        </h1>
                        <p class="text-gray-600 dark:text-gray-300">
                            Arsip 7 hari terakhir dengan analisis lengkap
                        </p>
                    </div>
                    <div class="flex items-center space-x-3 mt-4 md:mt-0">
                        <span class="text-sm text-gray-500 dark:text-gray-400" id="deletion-status"></span>
                        <button onclick="exportAllLogsToExcel()" class="btn-success px-5 py-2.5 rounded-lg font-semibold flex items-center">
                            <i class="fas fa-file-excel mr-2"></i>
                            Export Semua
                        </button>
                    </div>
                </div>

                <!-- Stats -->
                <div class="grid grid-cols-2 md:grid-cols-5 gap-4 mb-6" id="attendance-stats">
                    <!-- Stats will be loaded here -->
                </div>

                <!-- Period Tabs -->
                <div class="glass-card rounded-2xl p-6">
                    <div class="flex flex-wrap gap-2 mb-6">
                        <button onclick="filterLogsByPeriod('all')" class="period-tab period-tab-active px-4 py-2 rounded-lg font-medium">
                            Semua Periode
                        </button>
                        <button onclick="filterLogsByPeriod('pagi')" class="period-tab px-4 py-2 rounded-lg font-medium">
                            <i class="fas fa-sun mr-2"></i>Pagi
                        </button>
                        <button onclick="filterLogsByPeriod('siang')" class="period-tab px-4 py-2 rounded-lg font-medium">
                            <i class="fas fa-sun mr-2"></i>Siang
                        </button>
                        <button onclick="filterLogsByPeriod('sore')" class="period-tab px-4 py-2 rounded-lg font-medium">
                            <i class="fas fa-moon mr-2"></i>Sore
                        </button>
                        <button onclick="filterLogsByPeriod('malam')" class="period-tab px-4 py-2 rounded-lg font-medium">
                            <i class="fas fa-star mr-2"></i>Malam
                        </button>
                    </div>

                    <!-- Log Container -->
                    <div id="log-per-tanggal-container" class="space-y-4">
                        <!-- Logs will be loaded here -->
                    </div>

                    <!-- Loading State -->
                    <div id="loading-log-message" class="text-center py-12">
                        <div class="loading-spinner mx-auto"></div>
                        <p class="mt-4 text-gray-600 dark:text-gray-400">Memuat data absensi...</p>
                    </div>

                    <!-- Empty State -->
                    <div id="no-log-message" class="empty-state hidden">
                        <i class="fas fa-inbox"></i>
                        <h3 class="text-xl font-semibold text-gray-700 dark:text-gray-300 mb-2">Tidak ada data absensi</h3>
                        <p class="text-gray-500 dark:text-gray-400">Belum ada aktivitas absensi dalam 7 hari terakhir</p>
                    </div>
                </div>
            </div>

            <!-- Laporan View -->
            <div id="laporan-view" class="space-y-6 hidden">
                <!-- Header -->
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-2">
                            <i class="fas fa-chart-bar mr-3 text-[#0073aa]"></i>
                            Analisis & Laporan
                        </h1>
                        <p class="text-gray-600 dark:text-gray-300">
                            Insight mendalam dan statistik absensi
                        </p>
                    </div>
                    <div class="flex items-center space-x-3 mt-4 md:mt-0">
                        <select id="report-period" onchange="loadReport()" class="px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-gray-800/50 focus:outline-none focus:ring-2 focus:ring-[#0073aa]/30 focus:border-[#0073aa]">
                            <option value="7">7 Hari Terakhir</option>
                            <option value="30">30 Hari Terakhir</option>
                            <option value="90">90 Hari Terakhir</option>
                        </select>
                        <button onclick="generateReport()" class="btn-primary px-5 py-2.5 rounded-lg font-semibold flex items-center">
                            <i class="fas fa-download mr-2"></i>
                            Generate Report
                        </button>
                    </div>
                </div>

                <!-- Analytics Stats -->
                <div class="grid grid-cols-2 md:grid-cols-4 gap-4 mb-6" id="analytics-stats">
                    <!-- Stats will be loaded here -->
                </div>

                <!-- Charts -->
                <div class="grid grid-cols-1 lg:grid-cols-2 gap-6 mb-6">
                    <div class="glass-card rounded-2xl p-6">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-6">
                            <i class="fas fa-chart-line mr-2 text-[#0073aa]"></i>
                            Trend Absensi Harian
                        </h3>
                        <div class="chart-container">
                            <canvas id="attendanceTrendChart"></canvas>
                        </div>
                    </div>
                    <div class="glass-card rounded-2xl p-6">
                        <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-6">
                            <i class="fas fa-pie-chart mr-2 text-[#0073aa]"></i>
                            Distribusi Status
                        </h3>
                        <div class="chart-container">
                            <canvas id="statusDistributionChart"></canvas>
                        </div>
                    </div>
                </div>

                <!-- Department Analytics -->
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-6">
                        <i class="fas fa-building mr-2 text-[#0073aa]"></i>
                        Analisis per Departemen
                    </h3>
                    <div class="overflow-x-auto">
                        <table class="w-full">
                            <thead>
                                <tr class="border-b border-gray-200 dark:border-gray-700">
                                    <th class="pb-3 text-left font-semibold">Departemen</th>
                                    <th class="pb-3 text-left font-semibold">Total Karyawan</th>
                                    <th class="pb-3 text-left font-semibold">Total Absensi</th>
                                    <th class="pb-3 text-left font-semibold">Rata-rata/Hari</th>
                                    <th class="pb-3 text-left font-semibold">% Kehadiran</th>
                                </tr>
                            </thead>
                            <tbody id="department-analytics-body">
                                <!-- Data will be loaded here -->
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Insights -->
                <div class="glass-card rounded-2xl p-6">
                    <h3 class="text-lg font-semibold text-gray-800 dark:text-white mb-6">
                        <i class="fas fa-lightbulb mr-2 text-[#ffb900]"></i>
                        Insight & Rekomendasi
                    </h3>
                    <div id="insights-container" class="space-y-4">
                        <!-- Insights will be loaded here -->
                    </div>
                </div>
            </div>

            <!-- Pengaturan View -->
            <div id="pengaturan-view" class="space-y-6 hidden">
                <!-- Header -->
                <div class="flex flex-col md:flex-row items-start md:items-center justify-between">
                    <div>
                        <h1 class="text-2xl md:text-3xl font-bold text-gray-800 dark:text-white mb-2">
                            <i class="fas fa-cog mr-3 text-[#0073aa]"></i>
                            Pengaturan Sistem
                        </h1>
                        <p class="text-gray-600 dark:text-gray-300">
                            Konfigurasi dan preferensi sistem
                        </p>
                    </div>
                </div>

                <!-- Settings Tabs -->
                <div class="glass-card rounded-2xl">
                    <div class="border-b border-gray-200 dark:border-gray-700">
                        <nav class="flex space-x-4 px-6">
                            <button onclick="switchSettingsTab('umum')" class="settings-tab settings-tab-active py-4 font-medium">
                                <i class="fas fa-cog mr-2"></i>Umum
                            </button>
                            <button onclick="switchSettingsTab('absensi')" class="settings-tab py-4 font-medium">
                                <i class="fas fa-clock mr-2"></i>Absensi
                            </button>
                            <button onclick="switchSettingsTab('notifikasi')" class="settings-tab py-4 font-medium">
                                <i class="fas fa-bell mr-2"></i>Notifikasi
                            </button>
                            <button onclick="switchSettingsTab('backup')" class="settings-tab py-4 font-medium">
                                <i class="fas fa-database mr-2"></i>Backup
                            </button>
                        </nav>
                    </div>

                    <!-- Settings Content -->
                    <div class="p-6">
                        <!-- Umum Settings -->
                        <div id="umum-settings" class="space-y-6">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Nama Perusahaan
                                    </label>
                                    <input type="text" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-gray-800/50" value="PT. Contoh Perusahaan">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Zona Waktu
                                    </label>
                                    <select class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-gray-800/50">
                                        <option>Asia/Jakarta (WIB)</option>
                                        <option>Asia/Jayapura (WIT)</option>
                                        <option>Asia/Makassar (WITA)</option>
                                    </select>
                                </div>
                            </div>

                            <div>
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Deskripsi Sistem
                                </label>
                                <textarea class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-gray-800/50" rows="3"></textarea>
                            </div>

                            <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                                <div>
                                    <p class="font-medium text-gray-800 dark:text-white">Mode Maintenance</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400">Nonaktifkan akses pengguna selama maintenance</p>
                                </div>
                                <label class="toggle-switch">
                                    <input type="checkbox">
                                    <span class="toggle-slider"></span>
                                </label>
                            </div>
                        </div>

                        <!-- Absensi Settings -->
                        <div id="absensi-settings" class="space-y-6 hidden">
                            <div class="grid grid-cols-1 md:grid-cols-2 gap-6">
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Jam Mulai Kerja
                                    </label>
                                    <input type="time" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-gray-800/50" value="08:00">
                                </div>
                                <div>
                                    <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Jam Selesai Kerja
                                    </label>
                                    <input type="time" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-gray-800/50" value="17:00">
                                </div>
                            </div>

                            <div class="space-y-4">
                                <h4 class="font-medium text-gray-800 dark:text-white">Periode Makan</h4>
                                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                                        <span>Pagi</span>
                                        <input type="time" class="px-2 py-1 rounded border" value="07:00">
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                                        <span>Siang</span>
                                        <input type="time" class="px-2 py-1 rounded border" value="12:00">
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                                        <span>Sore</span>
                                        <input type="time" class="px-2 py-1 rounded border" value="17:00">
                                    </div>
                                    <div class="flex items-center justify-between p-3 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                                        <span>Malam</span>
                                        <input type="time" class="px-2 py-1 rounded border" value="20:00">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Notifikasi Settings -->
                        <div id="notifikasi-settings" class="space-y-6 hidden">
                            <div class="space-y-4">
                                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                                    <div>
                                        <p class="font-medium text-gray-800 dark:text-white">Email Notifikasi</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Kirim notifikasi via email</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>

                                <div class="flex items-center justify-between p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                                    <div>
                                        <p class="font-medium text-gray-800 dark:text-white">Push Notifikasi</p>
                                        <p class="text-sm text-gray-600 dark:text-gray-400">Notifikasi real-time di browser</p>
                                    </div>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>
                            </div>
                        </div>

                        <!-- Backup Settings -->
                        <div id="backup-settings" class="space-y-6 hidden">
                            <div class="space-y-4">
                                <div class="p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                                    <p class="font-medium text-gray-800 dark:text-white mb-2">Backup Otomatis</p>
                                    <p class="text-sm text-gray-600 dark:text-gray-400 mb-4">Cadangkan data secara otomatis setiap hari</p>
                                    <label class="toggle-switch">
                                        <input type="checkbox" checked>
                                        <span class="toggle-slider"></span>
                                    </label>
                                </div>

                                <div class="p-4 bg-gray-50 dark:bg-gray-800/50 rounded-lg">
                                    <p class="font-medium text-gray-800 dark:text-white mb-2">Waktu Backup</p>
                                    <input type="time" class="w-full px-4 py-2 rounded-lg border" value="02:00">
                                </div>

                                <button class="w-full btn-primary py-3 rounded-lg font-semibold">
                                    <i class="fas fa-download mr-2"></i>Backup Sekarang
                                </button>
                            </div>
                        </div>

                        <!-- Save Button -->
                        <div class="pt-6 border-t border-gray-200 dark:border-gray-700">
                            <button class="btn-primary px-6 py-3 rounded-lg font-semibold">
                                <i class="fas fa-save mr-2"></i>Simpan Perubahan
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </main>

        <!-- Footer -->
        <footer class="p-6 border-t border-gray-200 dark:border-gray-700">
            <div class="text-center text-gray-600 dark:text-gray-400 text-sm">
                <p>Â© 2024 AdminGAS Sistem Portal Vendor. Versi 2.0.0</p>
                <p class="mt-1">Dikembangkan dengan <i class="fas fa-heart text-red-500 mx-1"></i>By AmantaArdana</p>
            </div>
        </footer>
    </div>

    <!-- Modals -->
    <!-- Import Modal -->
    <div id="import-modal" class="modal-overlay fixed inset-0 z-50 hidden">
        <div class="modal-content max-w-4xl w-11/12 mx-auto mt-10">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 class="text-2xl font-bold text-gray-800 dark:text-white">
                        <i class="fas fa-file-import mr-2 text-[#0073aa]"></i>
                        Import Data Karyawan
                    </h3>
                    <button onclick="closeImportModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <form id="import-form">
                    <div id="step-upload" class="space-y-6">
                        <div class="p-6 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl border border-blue-200 dark:border-blue-800">
                            <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-3">
                                <i class="fas fa-upload mr-2 text-blue-500"></i>
                                Unggah File Excel
                            </h4>
                            <div class="mb-4">
                                <label class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Pilih File Excel (.xlsx, .xls)
                                </label>
                                <div class="mt-1 flex justify-center px-6 pt-5 pb-6 border-2 border-dashed border-gray-300 dark:border-gray-600 rounded-lg hover:border-[#0073aa] dark:hover:border-[#0073aa] transition cursor-pointer" onclick="document.getElementById('excel-file-input').click()">
                                    <div class="space-y-1 text-center">
                                        <i class="fas fa-file-excel text-4xl text-[#46b450]"></i>
                                        <div class="flex text-sm text-gray-600 dark:text-gray-400">
                                            <span class="relative cursor-pointer rounded-md font-medium text-[#0073aa] dark:text-[#00a0d2] hover:text-[#005a87] dark:hover:text-[#0073aa]">
                                                <span>Upload file</span>
                                                <input id="excel-file-input" type="file" class="sr-only" accept=".xlsx, .xls">
                                            </span>
                                            <p class="pl-1">atau drag & drop</p>
                                        </div>
                                        <p class="text-xs text-gray-500 dark:text-gray-400">.xlsx, .xls (maks 5MB)</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <div id="step-review" class="hidden space-y-6">
                        <!-- Review content will be loaded here -->
                    </div>

                    <div class="flex justify-between pt-6 border-t border-gray-200 dark:border-gray-700">
                        <button type="button" onclick="closeImportModal()" class="px-5 py-2.5 rounded-lg font-medium bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                            Batal
                        </button>
                        <div class="flex space-x-3">
                            <button type="button" id="review-button" onclick="parseExcelFile()" class="btn-primary px-5 py-2.5 rounded-lg font-medium flex items-center">
                                <i class="fas fa-eye mr-2"></i>
                                Review Data
                            </button>
                            <button type="submit" id="import-submit-button" class="btn-success px-5 py-2.5 rounded-lg font-medium flex items-center hidden">
                                <i class="fas fa-check mr-2"></i>
                                Proses Import
                            </button>
                        </div>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Form Modal -->
    <div id="form-modal" class="modal-overlay fixed inset-0 z-50 hidden">
        <div class="modal-content max-w-lg w-11/12 mx-auto mt-10">
            <div class="p-6">
                <div class="flex justify-between items-center mb-6">
                    <h3 id="modal-title" class="text-2xl font-bold text-gray-800 dark:text-white">
                        Tambah Karyawan
                    </h3>
                    <button onclick="closeFormModal()" class="text-gray-400 hover:text-gray-600 dark:hover:text-gray-300">
                        <i class="fas fa-times text-xl"></i>
                    </button>
                </div>

                <form id="crud-form">
                    <div class="space-y-4">
                        <div class="grid grid-cols-2 gap-4">
                            <div>
                                <label for="form-card" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    Card ID
                                </label>
                                <input type="text" id="form-card" required class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-gray-800/50 focus:outline-none focus:ring-2 focus:ring-[#0073aa]/30 focus:border-[#0073aa]">
                            </div>
                            <div>
                                <label for="form-nik" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                    NIK
                                </label>
                                <input type="text" id="form-nik" required class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-gray-800/50 focus:outline-none focus:ring-2 focus:ring-[#0073aa]/30 focus:border-[#0073aa]">
                            </div>
                        </div>

                        <div>
                            <label for="form-nama" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Nama Lengkap
                            </label>
                            <input type="text" id="form-nama" required class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-gray-800/50 focus:outline-none focus:ring-2 focus:ring-[#0073aa]/30 focus:border-[#0073aa]">
                        </div>

                        <div>
                            <label for="form-departemen" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                Departemen
                            </label>
                            <input type="text" id="form-departemen" required class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-gray-800/50 focus:outline-none focus:ring-2 focus:ring-[#0073aa]/30 focus:border-[#0073aa]">
                        </div>

                        <div class="pt-4 border-t border-gray-200 dark:border-gray-700">
                            <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                                <i class="fas fa-utensils mr-2 text-[#0073aa]"></i>
                                Periode Makan
                            </h4>
                            <div class="grid grid-cols-2 gap-4">
                                <div>
                                    <label for="form-pagi" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Pagi
                                    </label>
                                    <input type="text" id="form-pagi" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-gray-800/50" placeholder="Contoh: Kantin">
                                </div>
                                <div>
                                    <label for="form-siang" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Siang
                                    </label>
                                    <input type="text" id="form-siang" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-gray-800/50" placeholder="Contoh: Kantin">
                                </div>
                                <div>
                                    <label for="form-sore" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Sore
                                    </label>
                                    <input type="text" id="form-sore" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-gray-800/50" placeholder="Contoh: Kantin">
                                </div>
                                <div>
                                    <label for="form-malam" class="block text-sm font-medium text-gray-700 dark:text-gray-300 mb-2">
                                        Malam
                                    </label>
                                    <input type="text" id="form-malam" class="w-full px-4 py-2.5 rounded-lg border border-gray-300 dark:border-gray-600 bg-white/50 dark:bg-gray-800/50" placeholder="Contoh: Kantin">
                                </div>
                            </div>
                        </div>
                    </div>

                    <div class="flex justify-end space-x-3 mt-8 pt-6 border-t border-gray-200 dark:border-gray-700">
                        <button type="button" onclick="closeFormModal()" class="px-5 py-2.5 rounded-lg font-medium bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                            Batal
                        </button>
                        <button type="submit" id="submit-button" class="btn-primary px-5 py-2.5 rounded-lg font-medium flex items-center">
                            <i class="fas fa-save mr-2"></i>
                            Simpan Data
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Modal -->
    <div id="delete-modal" class="modal-overlay fixed inset-0 z-50 hidden">
        <div class="modal-content max-w-md w-11/12 mx-auto mt-10">
            <div class="p-6">
                <div class="text-center">
                    <div class="mx-auto flex items-center justify-center h-16 w-16 rounded-full bg-red-100 dark:bg-red-900/30 mb-4">
                        <i class="fas fa-exclamation-triangle text-red-600 dark:text-red-400 text-2xl"></i>
                    </div>
                    <h3 class="text-xl font-bold text-gray-900 dark:text-white mb-2">Konfirmasi Penghapusan</h3>
                    <p class="text-gray-600 dark:text-gray-400 mb-6">
                        Anda yakin ingin menghapus data karyawan dengan Card ID: 
                        <span id="delete-card-id" class="font-bold text-red-600 dark:text-red-400"></span>?
                    </p>
                    <div class="flex justify-center space-x-3">
                        <button type="button" onclick="closeDeleteModal()" class="px-5 py-2.5 rounded-lg font-medium bg-gray-200 dark:bg-gray-700 text-gray-700 dark:text-gray-300 hover:bg-gray-300 dark:hover:bg-gray-600 transition">
                            Batal
                        </button>
                        <button type="button" onclick="executeDelete()" class="btn-danger px-5 py-2.5 rounded-lg font-medium flex items-center">
                            <i class="fas fa-trash mr-2"></i>
                            Hapus Permanen
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Konfigurasi
        const SUPABASE_URL = 'https://ymzcvyumplerqccaplxi.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InltemN2eXVtcGxlcnFjY2FwbHhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjMwNjk3ODUsImV4cCI6MjA3ODY0NTc4NX0.XtX9NMHp3gINRP3zSA-PnC73tiI4vPVcB4D2A13c1TI';
        const GOOGLE_APPS_SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbwZ_4ycgdQYQjaL1Ihlg95BD7jgn7f8c05P2HTV4QLF1m1aXNOVGA0SdkEobfEKNgrxuw/exec';
        const TABLE_NAME = 'data_master';
        const LOG_TABLE_NAME = 'log_absen';
        const REQUIRED_HEADERS = ['Card ID', 'NIK', 'Nama', 'Departemen', 'Pagi', 'Siang', 'Sore', 'Malam'];

        const supabaseClient = supabase.createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
        
        // State Management
        let currentView = 'dashboard';
        let currentTheme = localStorage.getItem('theme') || 'light';
        let isSidebarCollapsed = localStorage.getItem('sidebarCollapsed') === 'true';
        let parsedImportData = [];
        let activeCardIds = [];
        let currentMode = 'create';
        let cardIdToDelete = null;
        let allAbsensiLogs = [];
        let currentPeriodFilter = 'all';
        let currentSettingsTab = 'umum';

        // Chart instances
        let attendanceChart = null;
        let departmentChart = null;
        let attendanceTrendChart = null;
        let statusDistributionChart = null;

        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            initApp();
        });

        // Initialize application
        function initApp() {
            initTheme();
            initSidebar();
            initCurrentDate();
            initEventListeners();
            checkAdminSession();
        }

        // Initialize theme
        function initTheme() {
            const themeToggle = document.getElementById('theme-toggle');
            
            if (currentTheme === 'dark') {
                document.body.classList.add('dark-mode');
                document.body.classList.remove('light-mode');
                themeToggle.checked = true;
            } else {
                document.body.classList.add('light-mode');
                document.body.classList.remove('dark-mode');
                themeToggle.checked = false;
            }
        }

        // Initialize sidebar state
        function initSidebar() {
            const sidebar = document.getElementById('sidebar');
            const contentWrapper = document.querySelector('.content-wrapper');
            
            if (isSidebarCollapsed) {
                sidebar.classList.add('collapsed');
                document.body.classList.add('sidebar-collapsed');
                document.body.classList.remove('sidebar-expanded');
            } else {
                sidebar.classList.remove('collapsed');
                document.body.classList.add('sidebar-expanded');
                document.body.classList.remove('sidebar-collapsed');
            }
        }

        // Initialize current date
        function initCurrentDate() {
            const now = new Date();
            const options = { 
                weekday: 'long', 
                year: 'numeric', 
                month: 'long', 
                day: 'numeric' 
            };
            document.getElementById('current-date').textContent = 
                now.toLocaleDateString('id-ID', options);
            
            // Set greeting based on time
            const hour = now.getHours();
            let greeting = 'Selamat Datang';
            if (hour < 12) greeting = 'Selamat Pagi';
            else if (hour < 15) greeting = 'Selamat Siang';
            else if (hour < 18) greeting = 'Selamat Sore';
            else greeting = 'Selamat Malam';
            
            document.getElementById('greeting-name').textContent = greeting;
        }

        // Initialize event listeners
        function initEventListeners() {
            // Form submissions
            document.getElementById('crud-form').addEventListener('submit', handleFormSubmit);
            document.getElementById('import-form').addEventListener('submit', handleImportSubmit);
            
            // Search functionality
            document.getElementById('search-card').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') applySearchFilter();
            });
            document.getElementById('search-nama').addEventListener('keypress', (e) => {
                if (e.key === 'Enter') applySearchFilter();
            });
            
            // File input change
            document.getElementById('excel-file-input').addEventListener('change', function() {
                if (this.files[0]) {
                    const fileName = document.createElement('div');
                    fileName.className = 'mt-2 p-2 bg-gray-100 dark:bg-gray-800 rounded text-sm';
                    fileName.textContent = `File: ${this.files[0].name}`;
                    
                    const stepUpload = document.getElementById('step-upload');
                    const existingFile = stepUpload.querySelector('.file-name');
                    if (existingFile) existingFile.remove();
                    
                    fileName.classList.add('file-name');
                    stepUpload.appendChild(fileName);
                }
            });
        }

        // Toggle sidebar
        function toggleSidebar() {
            const sidebar = document.getElementById('sidebar');
            const fab = document.getElementById('fab');
            
            isSidebarCollapsed = !isSidebarCollapsed;
            localStorage.setItem('sidebarCollapsed', isSidebarCollapsed);
            
            if (isSidebarCollapsed) {
                sidebar.classList.add('collapsed');
                document.body.classList.add('sidebar-collapsed');
                document.body.classList.remove('sidebar-expanded');
                fab.innerHTML = '<i class="fas fa-bars"></i>';
            } else {
                sidebar.classList.remove('collapsed');
                document.body.classList.add('sidebar-expanded');
                document.body.classList.remove('sidebar-collapsed');
                fab.innerHTML = '<i class="fas fa-times"></i>';
            }
        }

        // Toggle theme
        function toggleTheme() {
            currentTheme = currentTheme === 'light' ? 'dark' : 'light';
            localStorage.setItem('theme', currentTheme);
            initTheme();
            updateChartsTheme();
        }

        // Update charts theme
        function updateChartsTheme() {
            const isDark = currentTheme === 'dark';
            const textColor = isDark ? '#e4e6eb' : '#23282d';
            const gridColor = isDark ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)';
            
            // Update existing charts
            const charts = [attendanceChart, departmentChart, attendanceTrendChart, statusDistributionChart];
            charts.forEach(chart => {
                if (chart) {
                    chart.options.scales.x.ticks.color = textColor;
                    chart.options.scales.x.grid.color = gridColor;
                    chart.options.scales.y.ticks.color = textColor;
                    chart.options.scales.y.grid.color = gridColor;
                    chart.options.plugins.legend.labels.color = textColor;
                    chart.update();
                }
            });
        }

        // Toggle mobile menu
        function toggleMobileMenu() {
            const sidebar = document.getElementById('sidebar');
            sidebar.classList.toggle('show');
        }

        // Switch view
        function switchView(viewId) {
            // Hide all views
            document.querySelectorAll('[id$="-view"]').forEach(view => {
                view.classList.add('hidden');
            });
            
            // Remove active class from all nav items
            document.querySelectorAll('.nav-item').forEach(item => {
                item.classList.remove('active');
            });
            
            // Update breadcrumb
            document.getElementById('breadcrumb-current').textContent = 
                getViewTitle(viewId);
            
            // Show selected view
            document.getElementById(`${viewId}-view`).classList.remove('hidden');
            
            // Add active class to selected nav item
            const navItem = document.querySelector(`.nav-item[onclick*="${viewId}"]`);
            if (navItem) navItem.classList.add('active');
            
            // Load data for view
            switch(viewId) {
                case 'dashboard':
                    loadDashboard();
                    break;
                case 'karyawan':
                    loadKaryawan();
                    break;
                case 'absensi':
                    loadAbsensi();
                    break;
                case 'laporan':
                    loadLaporan();
                    break;
                case 'pengaturan':
                    // Settings view doesn't need data loading
                    break;
            }
            
            currentView = viewId;
            
            // Close mobile menu if open
            const sidebar = document.getElementById('sidebar');
            if (window.innerWidth < 768 && sidebar.classList.contains('show')) {
                sidebar.classList.remove('show');
            }
        }

        // Get view title for breadcrumb
        function getViewTitle(viewId) {
            const titles = {
                'dashboard': 'Dashboard',
                'karyawan': 'Data Karyawan',
                'absensi': 'Log Absensi',
                'laporan': 'Laporan',
                'pengaturan': 'Pengaturan'
            };
            return titles[viewId] || 'Dashboard';
        }

        // Switch settings tab
        function switchSettingsTab(tabId) {
            // Hide all settings tabs
            document.querySelectorAll('[id$="-settings"]').forEach(tab => {
                tab.classList.add('hidden');
            });
            
            // Remove active class from all tabs
            document.querySelectorAll('.settings-tab').forEach(tab => {
                tab.classList.remove('settings-tab-active');
            });
            
            // Show selected tab
            document.getElementById(`${tabId}-settings`).classList.remove('hidden');
            
            // Add active class to selected tab
            const tabElement = document.querySelector(`.settings-tab[onclick*="${tabId}"]`);
            if (tabElement) tabElement.classList.add('settings-tab-active');
            
            currentSettingsTab = tabId;
        }

        // Check admin session
        async function checkAdminSession() {
            const { data: { session }, error } = await supabaseClient.auth.getSession();
            
            if (error || !session) {
                window.location.href = './admin_login.html';
                return;
            }
            
            // Set admin name
            const adminNameEl = document.getElementById('admin-name');
            if (session.user.email) {
                adminNameEl.textContent = session.user.email.split('@')[0];
            }
            
            // Load initial view
            switchView('dashboard');
        }

        // Handle logout
        async function handleLogout() {
            const logoutBtn = document.querySelector('[onclick="handleLogout()"]');
            const originalContent = logoutBtn.innerHTML;
            
            logoutBtn.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Keluar...';
            logoutBtn.disabled = true;
            
            const { error } = await supabaseClient.auth.signOut();

            if (error) {
                console.error("Logout Error:", error);
                showGlobalMessage(`Gagal keluar: ${error.message}`, 'error');
                logoutBtn.innerHTML = originalContent;
                logoutBtn.disabled = false;
            } else {
                window.location.href = './admin_login.html';
            }
        }

        // Show global message
        function showGlobalMessage(message, type = 'success') {
            const messageEl = document.getElementById('global-message');
            const messageText = document.getElementById('message-text');
            
            messageText.textContent = message;
            messageEl.className = 'mb-6 fade-in';
            
            // Set background color based on type
            if (type === 'success') {
                messageEl.classList.add('bg-gradient-to-r', 'from-[#46b450]', 'to-[#3aa355]', 'text-white');
            } else if (type === 'error') {
                messageEl.classList.add('bg-gradient-to-r', 'from-[#dc3232]', 'to-[#c92c2c]', 'text-white');
            } else if (type === 'warning') {
                messageEl.classList.add('bg-gradient-to-r', 'from-[#ffb900]', 'to-[#e6a400]', 'text-white');
            } else {
                messageEl.classList.add('bg-gradient-to-r', 'from-[#0073aa]', 'to-[#005a87]', 'text-white');
            }
            
            messageEl.classList.remove('hidden');
            
            // Auto hide after 5 seconds
            setTimeout(hideMessage, 5000);
        }

        // Hide global message
        function hideMessage() {
            document.getElementById('global-message').classList.add('hidden');
        }

        // Load dashboard
        async function loadDashboard() {
            // Load stats
            await loadDashboardStats();
            
            // Load recent activity
            await loadRecentActivity();
            
            // Load system status
            await loadSystemStatus();
            
            // Load charts
            await loadDashboardCharts();
        }

        // Load dashboard stats
        async function loadDashboardStats() {
            const { data: employees, error: empError } = await supabaseClient
                .from(TABLE_NAME)
                .select('*');
            
            const { data: logs, error: logError } = await supabaseClient
                .from(LOG_TABLE_NAME)
                .select('*')
                .gte('created_at', getDateNDaysAgo(7));

            if (empError || logError) {
                console.error("Error loading dashboard stats:", empError || logError);
                return;
            }

            const totalEmployees = employees?.length || 0;
            const totalDepartments = [...new Set(employees?.map(emp => emp.departemen) || [])].length;
            const totalLogs = logs?.length || 0;
            const successLogs = logs?.filter(log => log.status === 'Sukses').length || 0;
            const kantinLogs = logs?.filter(log => 
                log.status === 'Sukses' && 
                log.periode && 
                ['pagi', 'siang', 'sore', 'malam'].includes(log.periode.toLowerCase())
            ).length || 0;

            const statsHtml = `
                <div class="stat-card glass-card rounded-xl p-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Total Karyawan</p>
                            <p class="text-2xl font-bold text-gray-800 dark:text-white mt-1">${totalEmployees}</p>
                        </div>
                        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-[#0073aa] to-[#00a0d2] flex items-center justify-center">
                            <i class="fas fa-users text-white"></i>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card glass-card rounded-xl p-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Departemen</p>
                            <p class="text-2xl font-bold text-gray-800 dark:text-white mt-1">${totalDepartments}</p>
                        </div>
                        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-[#46b450] to-[#3aa355] flex items-center justify-center">
                            <i class="fas fa-building text-white"></i>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card glass-card rounded-xl p-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Absensi (7 Hari)</p>
                            <p class="text-2xl font-bold text-gray-800 dark:text-white mt-1">${totalLogs}</p>
                        </div>
                        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-[#ffb900] to-[#e6a400] flex items-center justify-center">
                            <i class="fas fa-clipboard-check text-white"></i>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card glass-card rounded-xl p-5">
                    <div class="flex items-center justify-between">
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Makan di Kantin</p>
                            <p class="text-2xl font-bold text-gray-800 dark:text-white mt-1">${kantinLogs}</p>
                        </div>
                        <div class="w-12 h-12 rounded-lg bg-gradient-to-br from-[#8b5cf6] to-[#7c3aed] flex items-center justify-center">
                            <i class="fas fa-utensils text-white"></i>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('dashboard-stats').innerHTML = statsHtml;
        }

        // Load recent activity
        async function loadRecentActivity() {
            const { data: logs, error } = await supabaseClient
                .from(LOG_TABLE_NAME)
                .select('*')
                .order('created_at', { ascending: false })
                .limit(5);

            if (error) {
                console.error("Error loading recent activity:", error);
                return;
            }

            const activityHtml = logs.map(log => {
                const time = new Date(log.created_at).toLocaleTimeString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit' 
                });
                const statusClass = log.status === 'Sukses' ? 'badge-success' : 'badge-error';
                const icon = log.status === 'Sukses' ? 'fa-check-circle' : 'fa-times-circle';
                const iconColor = log.status === 'Sukses' ? 'text-[#46b450]' : 'text-[#dc3232]';
                
                return `
                    <div class="flex items-center justify-between p-3 hover:bg-gray-50 dark:hover:bg-gray-800/50 rounded-lg transition">
                        <div class="flex items-center space-x-3">
                            <div class="w-10 h-10 rounded-full bg-gray-100 dark:bg-gray-800 flex items-center justify-center">
                                <i class="fas fa-user ${iconColor}"></i>
                            </div>
                            <div>
                                <p class="text-sm font-medium text-gray-800 dark:text-white">${log.card}</p>
                                <p class="text-xs text-gray-600 dark:text-gray-400">${log.periode || 'Tidak ada periode'}</p>
                            </div>
                        </div>
                        <div class="text-right">
                            <span class="${statusClass}">${log.status}</span>
                            <p class="text-xs text-gray-500 dark:text-gray-400 mt-1">${time}</p>
                        </div>
                    </div>
                `;
            }).join('');

            document.getElementById('recent-activity').innerHTML = activityHtml || 
                '<p class="text-gray-500 dark:text-gray-400 text-center py-4">Tidak ada aktivitas terbaru</p>';
        }

        // Load system status
        async function loadSystemStatus() {
            const { data: employees } = await supabaseClient
                .from(TABLE_NAME)
                .select('card')
                .limit(1);

            const { data: logs } = await supabaseClient
                .from(LOG_TABLE_NAME)
                .select('created_at')
                .order('created_at', { ascending: false })
                .limit(1);

            const statusItems = [
                {
                    title: 'Database Connection',
                    status: 'Connected',
                    healthy: true,
                    icon: 'fa-database',
                    color: 'text-[#46b450]'
                },
                {
                    title: 'API Services',
                    status: 'Operational',
                    healthy: true,
                    icon: 'fa-server',
                    color: 'text-[#46b450]'
                },
                {
                    title: 'Employee Data',
                    status: employees?.length > 0 ? `${employees.length} records` : 'No data',
                    healthy: employees?.length > 0,
                    icon: 'fa-users',
                    color: employees?.length > 0 ? 'text-[#46b450]' : 'text-[#ffb900]'
                },
                {
                    title: 'Last Activity',
                    status: logs?.length > 0 ? 
                        new Date(logs[0].created_at).toLocaleTimeString('id-ID') : 
                        'No recent activity',
                    healthy: logs?.length > 0,
                    icon: 'fa-clock',
                    color: logs?.length > 0 ? 'text-[#46b450]' : 'text-[#dc3232]'
                }
            ];

            const statusHtml = statusItems.map(item => `
                <div class="flex items-center justify-between p-3 hover:bg-gray-50 dark:hover:bg-gray-800/50 rounded-lg transition">
                    <div class="flex items-center space-x-3">
                        <i class="fas ${item.icon} ${item.color} text-lg"></i>
                        <div>
                            <p class="text-sm font-medium text-gray-800 dark:text-white">${item.title}</p>
                            <p class="text-xs text-gray-600 dark:text-gray-400">${item.status}</p>
                        </div>
                    </div>
                    <div class="w-2 h-2 rounded-full ${item.healthy ? 'bg-[#46b450]' : 'bg-[#dc3232]'}"></div>
                </div>
            `).join('');

            document.getElementById('system-status').innerHTML = statusHtml;
        }

        // Load dashboard charts
        async function loadDashboardCharts() {
            const { data: logs } = await supabaseClient
                .from(LOG_TABLE_NAME)
                .select('*')
                .gte('created_at', getDateNDaysAgo(7));

            const { data: employees } = await supabaseClient
                .from(TABLE_NAME)
                .select('departemen');

            // Destroy existing charts
            if (attendanceChart) attendanceChart.destroy();
            if (departmentChart) departmentChart.destroy();

            // Prepare data for attendance chart
            const dailyData = {};
            if (logs) {
                logs.forEach(log => {
                    const date = new Date(log.created_at).toLocaleDateString('id-ID', { 
                        day: 'numeric', 
                        month: 'short' 
                    });
                    if (!dailyData[date]) dailyData[date] = { total: 0, success: 0 };
                    dailyData[date].total++;
                    if (log.status === 'Sukses') dailyData[date].success++;
                });
            }

            const dates = Object.keys(dailyData);
            const totalData = dates.map(date => dailyData[date].total);
            const successData = dates.map(date => dailyData[date].success);

            // Create attendance chart
            const attendanceCtx = document.getElementById('attendanceChart').getContext('2d');
            attendanceChart = new Chart(attendanceCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Total Tapping',
                            data: totalData,
                            borderColor: '#0073aa',
                            backgroundColor: 'rgba(0, 115, 170, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Sukses',
                            data: successData,
                            borderColor: '#46b450',
                            backgroundColor: 'rgba(70, 180, 80, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: currentTheme === 'dark' ? '#e4e6eb' : '#23282d'
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: currentTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: currentTheme === 'dark' ? '#94a3b8' : '#64748b'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: currentTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: currentTheme === 'dark' ? '#94a3b8' : '#64748b'
                            }
                        }
                    }
                }
            });

            // Prepare data for department chart
            const deptData = {};
            if (employees) {
                employees.forEach(emp => {
                    const dept = emp.departemen || 'Unknown';
                    deptData[dept] = (deptData[dept] || 0) + 1;
                });
            }

            const deptLabels = Object.keys(deptData);
            const deptCounts = Object.values(deptData);

            // Create department chart
            const departmentCtx = document.getElementById('departmentChart').getContext('2d');
            departmentChart = new Chart(departmentCtx, {
                type: 'doughnut',
                data: {
                    labels: deptLabels,
                    datasets: [{
                        data: deptCounts,
                        backgroundColor: [
                            '#0073aa', '#00a0d2', '#46b450', '#ffb900',
                            '#8b5cf6', '#dc3232', '#f97316', '#8b5cf6'
                        ],
                        borderWidth: 2,
                        borderColor: currentTheme === 'dark' ? '#2c3138' : '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: currentTheme === 'dark' ? '#e4e6eb' : '#23282d',
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        // Load karyawan view
        async function loadKaryawan() {
            await fetchData();
            await loadEmployeeStatsView();
        }

        // Load employee stats for karyawan view
        async function loadEmployeeStatsView() {
            const { data: employees, error } = await supabaseClient
                .from(TABLE_NAME)
                .select('*');

            if (error || !employees) return;

            const totalEmployees = employees.length;
            const departments = [...new Set(employees.map(emp => emp.departemen))];
            const withKantin = employees.filter(emp => 
                emp.pagi === 'Kantin' || 
                emp.siang === 'Kantin' || 
                emp.sore === 'Kantin' || 
                emp.malam === 'Kantin'
            ).length;

            const statsHtml = `
                <div class="stat-card glass-card rounded-xl p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#0073aa] to-[#00a0d2] flex items-center justify-center">
                            <i class="fas fa-users text-white"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Total</p>
                            <p class="text-xl font-bold text-gray-800 dark:text-white">${totalEmployees}</p>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card glass-card rounded-xl p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#46b450] to-[#3aa355] flex items-center justify-center">
                            <i class="fas fa-building text-white"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Departemen</p>
                            <p class="text-xl font-bold text-gray-800 dark:text-white">${departments.length}</p>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card glass-card rounded-xl p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#ffb900] to-[#e6a400] flex items-center justify-center">
                            <i class="fas fa-utensils text-white"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Kantin</p>
                            <p class="text-xl font-bold text-gray-800 dark:text-white">${withKantin}</p>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card glass-card rounded-xl p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#8b5cf6] to-[#7c3aed] flex items-center justify-center">
                            <i class="fas fa-percentage text-white"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">% Kantin</p>
                            <p class="text-xl font-bold text-gray-800 dark:text-white">
                                ${totalEmployees > 0 ? Math.round((withKantin / totalEmployees) * 100) : 0}%
                            </p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('employee-stats').innerHTML = statsHtml;
        }

        // Fetch employee data
        async function fetchData(cardFilter = '', nameFilter = '') {
            let query = supabaseClient.from(TABLE_NAME).select('*');

            if (cardFilter) {
                query = query.ilike('card', `%${cardFilter}%`);
            }
            if (nameFilter) {
                query = query.ilike('nama', `%${nameFilter}%`);
            }
            
            const { data, error } = await query.order('nama', { ascending: true });

            const tbody = document.getElementById('data-table-body');
            const noDataMsg = document.getElementById('no-data-message');
            tbody.innerHTML = '';

            if (error) {
                console.error("Error fetching data:", error);
                showGlobalMessage(`Gagal memuat data: ${error.message}`, 'error');
                noDataMsg.classList.remove('hidden');
                return;
            }

            if (!data || data.length === 0) {
                noDataMsg.classList.remove('hidden');
                tbody.innerHTML = '';
            } else {
                noDataMsg.classList.add('hidden');
                data.forEach(item => {
                    const row = tbody.insertRow();
                    row.className = 'hover:bg-gray-50 dark:hover:bg-gray-800/50 transition';
                    
                    const cells = [
                        `<span class="font-mono font-semibold text-gray-800 dark:text-white">${item.card}</span>`,
                        item.nik,
                        `<div class="font-medium">${item.nama}</div>`,
                        `<span class="px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded text-sm">${item.departemen}</span>`,
                        `<span class="px-2 py-1 ${item.pagi === 'Kantin' ? 'badge-success' : 'bg-gray-100 dark:bg-gray-800'} rounded text-sm">${item.pagi || '-'}</span>`,
                        `<span class="px-2 py-1 ${item.siang === 'Kantin' ? 'badge-success' : 'bg-gray-100 dark:bg-gray-800'} rounded text-sm">${item.siang || '-'}</span>`,
                        `<span class="px-2 py-1 ${item.sore === 'Kantin' ? 'badge-success' : 'bg-gray-100 dark:bg-gray-800'} rounded text-sm">${item.sore || '-'}</span>`,
                        `<span class="px-2 py-1 ${item.malam === 'Kantin' ? 'badge-success' : 'bg-gray-100 dark:bg-gray-800'} rounded text-sm">${item.malam || '-'}</span>`,
                        `<div class="flex justify-center space-x-2">
                            <button onclick="openFormModal('edit', '${item.card}')" class="w-8 h-8 rounded-lg bg-blue-100 dark:bg-blue-900/30 text-blue-600 dark:text-blue-400 hover:bg-blue-200 dark:hover:bg-blue-800/50 flex items-center justify-center transition">
                                <i class="fas fa-edit text-sm"></i>
                            </button>
                            <button onclick="openDeleteModal('${item.card}')" class="w-8 h-8 rounded-lg bg-red-100 dark:bg-red-900/30 text-red-600 dark:text-red-400 hover:bg-red-200 dark:hover:bg-red-800/50 flex items-center justify-center transition">
                                <i class="fas fa-trash text-sm"></i>
                            </button>
                        </div>`
                    ];

                    cells.forEach(cell => {
                        const td = row.insertCell();
                        td.className = 'py-4';
                        td.innerHTML = cell;
                    });
                });
            }
        }

        // Apply search filter
        function applySearchFilter() {
            const card = document.getElementById('search-card').value.trim();
            const nama = document.getElementById('search-nama').value.trim();
            fetchData(card, nama);
        }

        // Clear search filter
        function clearSearchFilter() {
            document.getElementById('search-card').value = '';
            document.getElementById('search-nama').value = '';
            fetchData();
        }

        // Load absensi view
        async function loadAbsensi() {
            await autoDeleteOldLogs();
            await loadArchivedAbsensiLog();
        }

        // Get date N days ago
        function getDateNDaysAgo(n) {
            const date = new Date();
            date.setDate(date.getDate() - n);
            return date.toISOString();
        }

        // Auto delete old logs
        async function autoDeleteOldLogs() {
            const sevenDaysAgo = getDateNDaysAgo(7);
            const deletionStatusEl = document.getElementById('deletion-status');
            deletionStatusEl.textContent = 'Memeriksa log lama...';

            const { count, error } = await supabaseClient
                .from(LOG_TABLE_NAME)
                .delete({ count: 'exact' })
                .lt('created_at', sevenDaysAgo);
            
            if (error) {
                console.error("Auto Delete Log Error:", error);
                deletionStatusEl.textContent = 'âš ï¸ Gagal menghapus log lama';
            } else {
                deletionStatusEl.textContent = count > 0 ? 
                    `âœ… ${count} log lama dihapus` : 'âœ… Log sudah bersih';
            }
        }

        // Load archived absensi log
        async function loadArchivedAbsensiLog() {
            const container = document.getElementById('log-per-tanggal-container');
            const loadingMsg = document.getElementById('loading-log-message');
            const noLogMsg = document.getElementById('no-log-message');

            container.innerHTML = '';
            loadingMsg.classList.remove('hidden');
            noLogMsg.classList.add('hidden');

            const sevenDaysAgo = getDateNDaysAgo(7);

            // Get master data
            const { data: masterData, error: masterError } = await supabaseClient
                .from(TABLE_NAME)
                .select('card, nama, departemen');

            if (masterError) {
                console.error("Error fetching master data:", masterError);
                loadingMsg.classList.add('hidden');
                return;
            }
            
            const employeeMap = new Map();
            masterData.forEach(emp => employeeMap.set(emp.card, emp));

            // Get logs
            const { data: logs, error: logError } = await supabaseClient
                .from(LOG_TABLE_NAME)
                .select('card, status, periode, created_at, nama, departemen')
                .gte('created_at', sevenDaysAgo)
                .order('created_at', { ascending: false });

            loadingMsg.classList.add('hidden');
            
            if (logError) {
                console.error("Error fetching logs:", logError);
                container.innerHTML = '<p class="text-center py-4 text-red-500">Gagal memuat data log.</p>';
                return;
            }

            // Enrich logs with master data
            const enrichedLogs = logs.map(log => {
                const isDataMissing = !log.nama || log.nama.trim() === '-' || !log.departemen || log.departemen.trim() === '-';
                
                if (log.status === 'Sukses' && isDataMissing) {
                    const employee = employeeMap.get(log.card);
                    if (employee) {
                        return {
                            ...log,
                            nama: employee.nama || 'Tidak Terdaftar',
                            departemen: employee.departemen || '-'
                        };
                    }
                }
                return log;
            });

            allAbsensiLogs = enrichedLogs;
            
            // Load attendance stats
            await loadAttendanceStatsView(enrichedLogs);
            
            // Render logs
            renderGroupedLogDetails(enrichedLogs);

            if (enrichedLogs.length === 0) {
                noLogMsg.classList.remove('hidden');
            }
        }

        // Load attendance stats for absensi view
        async function loadAttendanceStatsView(logs) {
            const totalLogs = logs.length;
            const successLogs = logs.filter(log => log.status === 'Sukses').length;
            const failedLogs = totalLogs - successLogs;
            
            // Count by period
            const periodCounts = { pagi: 0, siang: 0, sore: 0, malam: 0 };
            logs.forEach(log => {
                if (log.periode && periodCounts.hasOwnProperty(log.periode.toLowerCase())) {
                    periodCounts[log.periode.toLowerCase()]++;
                }
            });
            
            // Count kantin taps
            const kantinTaps = logs.filter(log => 
                log.status === 'Sukses' && 
                log.periode && 
                ['pagi', 'siang', 'sore', 'malam'].includes(log.periode.toLowerCase())
            ).length;

            const successRate = totalLogs > 0 ? Math.round((successLogs / totalLogs) * 100) : 0;

            const statsHtml = `
                <div class="stat-card glass-card rounded-xl p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#0073aa] to-[#00a0d2] flex items-center justify-center">
                            <i class="fas fa-fingerprint text-white"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Total</p>
                            <p class="text-xl font-bold text-gray-800 dark:text-white">${totalLogs}</p>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card glass-card rounded-xl p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#46b450] to-[#3aa355] flex items-center justify-center">
                            <i class="fas fa-check-circle text-white"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Sukses</p>
                            <p class="text-xl font-bold text-gray-800 dark:text-white">${successLogs}</p>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card glass-card rounded-xl p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#dc3232] to-[#c92c2c] flex items-center justify-center">
                            <i class="fas fa-times-circle text-white"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Gagal</p>
                            <p class="text-xl font-bold text-gray-800 dark:text-white">${failedLogs}</p>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card glass-card rounded-xl p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#ffb900] to-[#e6a400] flex items-center justify-center">
                            <i class="fas fa-utensils text-white"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Kantin</p>
                            <p class="text-xl font-bold text-gray-800 dark:text-white">${kantinTaps}</p>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card glass-card rounded-xl p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#8b5cf6] to-[#7c3aed] flex items-center justify-center">
                            <i class="fas fa-percentage text-white"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">% Sukses</p>
                            <p class="text-xl font-bold text-gray-800 dark:text-white">${successRate}%</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('attendance-stats').innerHTML = statsHtml;
        }

        // Filter logs by period
        function filterLogsByPeriod(period) {
            currentPeriodFilter = period;
            
            // Update active tab
            document.querySelectorAll('.period-tab').forEach(tab => {
                tab.classList.remove('period-tab-active', 'bg-[#0073aa]', 'text-white');
                tab.classList.add('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
            });
            
            event.target.classList.add('period-tab-active', 'bg-[#0073aa]', 'text-white');
            event.target.classList.remove('bg-gray-100', 'dark:bg-gray-800', 'text-gray-700', 'dark:text-gray-300');
            
            // Re-render logs with filter
            renderGroupedLogDetails(allAbsensiLogs);
        }

        // Render grouped log details
        function renderGroupedLogDetails(logs) {
            const container = document.getElementById('log-per-tanggal-container');
            container.innerHTML = '';

            // Filter by period if needed
            let filteredLogs = logs;
            if (currentPeriodFilter !== 'all') {
                filteredLogs = logs.filter(log => 
                    log.periode && 
                    log.periode.toLowerCase() === currentPeriodFilter
                );
            }

            // Group by date
            const logsByDate = filteredLogs.reduce((acc, log) => {
                const date = new Date(log.created_at);
                const dateKey = date.toLocaleDateString('id-ID', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                if (!acc[dateKey]) {
                    acc[dateKey] = [];
                }
                acc[dateKey].push(log);
                return acc;
            }, {});

            const sortedDates = Object.keys(logsByDate).sort((a, b) => {
                return new Date(b.split(', ')[1]) - new Date(a.split(', ')[1]);
            });

            if (sortedDates.length === 0) {
                container.innerHTML = `
                    <div class="text-center py-12">
                        <i class="fas fa-inbox text-4xl text-gray-300 dark:text-gray-600 mb-4"></i>
                        <h3 class="text-lg font-semibold text-gray-700 dark:text-gray-300 mb-2">Tidak ada data</h3>
                        <p class="text-gray-500 dark:text-gray-400">Tidak ada log absensi untuk periode yang dipilih</p>
                    </div>
                `;
                return;
            }

            sortedDates.forEach(dateKey => {
                const logsForDate = logsByDate[dateKey];
                
                // Calculate stats for this date
                const totalLogs = logsForDate.length;
                const successLogs = logsForDate.filter(log => log.status === 'Sukses').length;
                const kantinTaps = logsForDate.filter(log => 
                    log.status === 'Sukses' && 
                    log.periode && 
                    ['pagi', 'siang', 'sore', 'malam'].includes(log.periode.toLowerCase())
                ).length;

                const groupHtml = `
                    <div class="glass-card rounded-xl overflow-hidden">
                        <!-- Header -->
                        <div class="bg-gradient-to-r from-[#0073aa] to-[#00a0d2] p-4">
                            <div class="flex flex-col md:flex-row justify-between items-start md:items-center">
                                <div class="flex items-center space-x-3">
                                    <div class="w-10 h-10 rounded-lg bg-white/20 flex items-center justify-center">
                                        <i class="fas fa-calendar text-white"></i>
                                    </div>
                                    <div>
                                        <h3 class="text-lg font-bold text-white">${dateKey}</h3>
                                        <div class="flex flex-wrap gap-2 mt-1">
                                            <span class="text-xs bg-white/20 px-2 py-1 rounded">
                                                <i class="fas fa-fingerprint mr-1"></i>${totalLogs} tapping
                                            </span>
                                            <span class="text-xs bg-white/20 px-2 py-1 rounded">
                                                <i class="fas fa-check mr-1"></i>${successLogs} sukses
                                            </span>
                                            <span class="text-xs bg-white/20 px-2 py-1 rounded">
                                                <i class="fas fa-utensils mr-1"></i>${kantinTaps} kantin
                                            </span>
                                        </div>
                                    </div>
                                </div>
                                <div class="flex items-center space-x-2 mt-3 md:mt-0">
                                    <button onclick="exportSingleDayLogToExcel('${dateKey}')" class="bg-white/20 hover:bg-white/30 text-white px-3 py-1.5 rounded-lg text-sm font-medium transition flex items-center">
                                        <i class="fas fa-file-excel mr-2"></i>
                                        Export
                                    </button>
                                    <button onclick="toggleLogDetails(this, 'log-table-${dateKey.replace(/[^a-zA-Z0-9]/g, '-')}')" class="text-white hover:bg-white/10 p-2 rounded-lg transition">
                                        <i class="fas fa-chevron-down transition-transform"></i>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Details Table -->
                        <div id="log-table-${dateKey.replace(/[^a-zA-Z0-9]/g, '-')}" class="hidden">
                            <div class="p-4">
                                <div class="overflow-x-auto">
                                    <table class="w-full text-sm">
                                        <thead>
                                            <tr class="border-b border-gray-200 dark:border-gray-700">
                                                <th class="pb-2 text-left font-semibold">Waktu</th>
                                                <th class="pb-2 text-left font-semibold">Card ID</th>
                                                <th class="pb-2 text-left font-semibold">Nama</th>
                                                <th class="pb-2 text-left font-semibold">Departemen</th>
                                                <th class="pb-2 text-left font-semibold">Periode</th>
                                                <th class="pb-2 text-left font-semibold">Status</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            ${logsForDate.map(log => {
                                                const time = new Date(log.created_at).toLocaleTimeString('id-ID', { 
                                                    hour: '2-digit', 
                                                    minute: '2-digit', 
                                                    second: '2-digit' 
                                                });
                                                const statusClass = log.status === 'Sukses' ? 'badge-success' : 'badge-error';
                                                const periodClass = 'px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 rounded text-xs';
                                                
                                                return `
                                                    <tr class="border-b border-gray-100 dark:border-gray-800 last:border-0">
                                                        <td class="py-3 font-mono">${time}</td>
                                                        <td class="py-3 font-mono font-semibold">${log.card}</td>
                                                        <td class="py-3">${log.nama || 'Tidak Terdaftar'}</td>
                                                        <td class="py-3">
                                                            <span class="px-2 py-1 bg-gray-100 dark:bg-gray-800 rounded text-xs">
                                                                ${log.departemen || '-'}
                                                            </span>
                                                        </td>
                                                        <td class="py-3">
                                                            <span class="${periodClass}">${log.periode || '-'}</span>
                                                        </td>
                                                        <td class="py-3">
                                                            <span class="${statusClass}">${log.status}</span>
                                                        </td>
                                                    </tr>
                                                `;
                                            }).join('')}
                                        </tbody>
                                    </table>
                                </div>
                            </div>
                        </div>
                    </div>
                `;
                container.insertAdjacentHTML('beforeend', groupHtml);
            });
        }

        // Toggle log details
        function toggleLogDetails(button, tableId) {
            const detailElement = document.getElementById(tableId);
            const icon = button.querySelector('i');
            
            if (detailElement.classList.contains('hidden')) {
                detailElement.classList.remove('hidden');
                icon.classList.add('rotate-180');
            } else {
                detailElement.classList.add('hidden');
                icon.classList.remove('rotate-180');
            }
        }

        // Export single day log to Excel
        function exportSingleDayLogToExcel(dateKey) {
            const logsToExport = allAbsensiLogs.filter(log => {
                const logDate = new Date(log.created_at).toLocaleDateString('id-ID', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                return logDate === dateKey;
            });

            if (logsToExport.length === 0) {
                showGlobalMessage(`Tidak ada data log untuk tanggal ${dateKey}.`, 'error');
                return;
            }

            // Create worksheet data with formatted headers
            const wsData = [
                ['LAPORAN ABSENSI KARYAWAN'],
                [`Tanggal: ${dateKey}`],
                [''],
                ['No', 'Waktu', 'Card ID', 'Nama Karyawan', 'Departemen', 'Periode', 'Status', 'Keterangan']
            ];

            // Add data rows
            logsToExport.forEach((log, index) => {
                const waktu = new Date(log.created_at).toLocaleTimeString('id-ID', { 
                    hour: '2-digit', 
                    minute: '2-digit', 
                    second: '2-digit' 
                });
                const keterangan = log.status === 'Sukses' ? 'Tap Berhasil' : 'Card Tidak Terdaftar';
                
                wsData.push([
                    index + 1,
                    waktu,
                    log.card,
                    log.nama || 'Tidak Terdaftar',
                    log.departemen || '-',
                    log.periode || '-',
                    log.status,
                    keterangan
                ]);
            });

            // Add summary
            const successCount = logsToExport.filter(log => log.status === 'Sukses').length;
            const kantinCount = logsToExport.filter(log => 
                log.status === 'Sukses' && 
                log.periode && 
                ['pagi', 'siang', 'sore', 'malam'].includes(log.periode.toLowerCase())
            ).length;
            
            wsData.push(['']);
            wsData.push(['SUMMARY']);
            wsData.push(['Total Tapping', logsToExport.length]);
            wsData.push(['Sukses', successCount]);
            wsData.push(['Gagal', logsToExport.length - successCount]);
            wsData.push(['Makan di Kantin', kantinCount]);
            wsData.push(['% Sukses', logsToExport.length > 0 ? `${Math.round((successCount / logsToExport.length) * 100)}%` : '0%']);

            // Create worksheet
            const ws = XLSX.utils.aoa_to_sheet(wsData);

            // Merge title cells
            ws['!merges'] = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: 7 } },
                { s: { r: 1, c: 0 }, e: { r: 1, c: 7 } },
                { s: { r: wsData.length - 6, c: 0 }, e: { r: wsData.length - 6, c: 1 } }
            ];

            // Add column widths
            ws['!cols'] = [
                { wch: 5 },  // No
                { wch: 10 }, // Waktu
                { wch: 15 }, // Card ID
                { wch: 25 }, // Nama
                { wch: 20 }, // Departemen
                { wch: 10 }, // Periode
                { wch: 10 }, // Status
                { wch: 20 }  // Keterangan
            ];

            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, `Absensi`);
            XLSX.writeFile(wb, `Absensi_${dateKey.split(', ')[1].replace(/\s+/g, '_')}.xlsx`);

            showGlobalMessage(`Berhasil export ${logsToExport.length} data untuk ${dateKey}`, 'success');
        }

        // Export all logs to Excel
        function exportAllLogsToExcel() {
            if (allAbsensiLogs.length === 0) {
                showGlobalMessage('Tidak ada data log untuk diexport.', 'error');
                return;
            }

            const wb = XLSX.utils.book_new();
            
            // Create summary sheet
            const summaryData = [
                ['REKAPITULASI ABSENSI 7 HARI TERAKHIR'],
                [`Tanggal Generate: ${new Date().toLocaleDateString('id-ID')}`],
                [''],
                ['Tanggal', 'Total Tapping', 'Sukses', 'Gagal', 'Makan di Kantin', '% Sukses']
            ];

            // Group by date
            const logsByDate = allAbsensiLogs.reduce((acc, log) => {
                const date = new Date(log.created_at);
                const dateKey = date.toLocaleDateString('id-ID', { 
                    weekday: 'long', 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
                
                if (!acc[dateKey]) {
                    acc[dateKey] = [];
                }
                acc[dateKey].push(log);
                return acc;
            }, {});

            let grandTotal = 0;
            let grandSuccess = 0;
            let grandKantin = 0;

            Object.keys(logsByDate).sort((a, b) => {
                return new Date(b.split(', ')[1]) - new Date(a.split(', ')[1]);
            }).forEach(dateKey => {
                const logs = logsByDate[dateKey];
                const total = logs.length;
                const success = logs.filter(log => log.status === 'Sukses').length;
                const kantin = logs.filter(log => 
                    log.status === 'Sukses' && 
                    log.periode && 
                    ['pagi', 'siang', 'sore', 'malam'].includes(log.periode.toLowerCase())
                ).length;
                
                summaryData.push([
                    dateKey,
                    total,
                    success,
                    total - success,
                    kantin,
                    total > 0 ? `${Math.round((success / total) * 100)}%` : '0%'
                ]);

                grandTotal += total;
                grandSuccess += success;
                grandKantin += kantin;
            });

            // Add grand total
            summaryData.push(['']);
            summaryData.push(['TOTAL', grandTotal, grandSuccess, grandTotal - grandSuccess, grandKantin, 
                            grandTotal > 0 ? `${Math.round((grandSuccess / grandTotal) * 100)}%` : '0%']);

            const wsSummary = XLSX.utils.aoa_to_sheet(summaryData);
            
            // Merge title cell
            wsSummary['!merges'] = [
                { s: { r: 0, c: 0 }, e: { r: 0, c: 5 } },
                { s: { r: 1, c: 0 }, e: { r: 1, c: 5 } }
            ];

            // Add column widths
            wsSummary['!cols'] = [
                { wch: 30 }, { wch: 15 }, { wch: 15 },
                { wch: 15 }, { wch: 20 }, { wch: 15 }
            ];

            XLSX.utils.book_append_sheet(wb, wsSummary, 'Rekap');

            // Create detailed sheets for each day
            Object.keys(logsByDate).forEach(dateKey => {
                const logs = logsByDate[dateKey];
                const shortDate = dateKey.split(', ')[1];
                
                const wsData = [
                    ['LAPORAN DETAIL ABSENSI'],
                    [`Tanggal: ${dateKey}`],
                    [''],
                    ['No', 'Waktu', 'Card ID', 'Nama Karyawan', 'Departemen', 'Periode', 'Status', 'Keterangan']
                ];

                logs.forEach((log, index) => {
                    const waktu = new Date(log.created_at).toLocaleTimeString('id-ID', { 
                        hour: '2-digit', 
                        minute: '2-digit', 
                        second: '2-digit' 
                    });
                    const keterangan = log.status === 'Sukses' ? 'Tap Berhasil' : 'Card Tidak Terdaftar';
                    
                    wsData.push([
                        index + 1,
                        waktu,
                        log.card,
                        log.nama || 'Tidak Terdaftar',
                        log.departemen || '-',
                        log.periode || '-',
                        log.status,
                        keterangan
                    ]);
                });

                const ws = XLSX.utils.aoa_to_sheet(wsData);
                
                // Merge title cells
                ws['!merges'] = [
                    { s: { r: 0, c: 0 }, e: { r: 0, c: 7 } },
                    { s: { r: 1, c: 0 }, e: { r: 1, c: 7 } }
                ];

                // Add column widths
                ws['!cols'] = [
                    { wch: 5 }, { wch: 10 }, { wch: 15 }, { wch: 25 },
                    { wch: 20 }, { wch: 10 }, { wch: 10 }, { wch: 20 }
                ];

                XLSX.utils.book_append_sheet(wb, ws, `Absensi_${shortDate.replace(/\s+/g, '_')}`);
            });

            XLSX.writeFile(wb, `Absensi_Rekap_${new Date().toISOString().split('T')[0]}.xlsx`);
            showGlobalMessage(`Berhasil export ${allAbsensiLogs.length} data ke Excel`, 'success');
        }

        // Load laporan view
        async function loadLaporan() {
            await loadReport();
        }

        // Load report
        async function loadReport() {
            const period = document.getElementById('report-period').value;
            await loadAnalyticsStats(period);
            await loadDepartmentAnalytics(period);
            await loadLaporanCharts(period);
            await loadInsights(period);
        }

        // Load analytics stats
        async function loadAnalyticsStats(period) {
            const daysAgo = getDateNDaysAgo(parseInt(period));
            
            const { data: logs, error: logError } = await supabaseClient
                .from(LOG_TABLE_NAME)
                .select('*')
                .gte('created_at', daysAgo);

            const { data: employees, error: empError } = await supabaseClient
                .from(TABLE_NAME)
                .select('*');

            if (logError || empError) {
                console.error("Error loading analytics stats:", logError || empError);
                return;
            }

            const totalLogs = logs?.length || 0;
            const successLogs = logs?.filter(log => log.status === 'Sukses').length || 0;
            const uniqueEmployees = [...new Set(logs?.filter(log => log.status === 'Sukses').map(log => log.card) || [])].length;
            const kantinLogs = logs?.filter(log => 
                log.status === 'Sukses' && 
                log.periode && 
                ['pagi', 'siang', 'sore', 'malam'].includes(log.periode.toLowerCase())
            ).length || 0;

            const avgPerDay = Math.round(totalLogs / parseInt(period));
            const successRate = totalLogs > 0 ? Math.round((successLogs / totalLogs) * 100) : 0;

            const statsHtml = `
                <div class="stat-card glass-card rounded-xl p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#0073aa] to-[#00a0d2] flex items-center justify-center">
                            <i class="fas fa-chart-line text-white"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Total Aktivitas</p>
                            <p class="text-xl font-bold text-gray-800 dark:text-white">${totalLogs}</p>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card glass-card rounded-xl p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#46b450] to-[#3aa355] flex items-center justify-center">
                            <i class="fas fa-user-check text-white"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Karyawan Aktif</p>
                            <p class="text-xl font-bold text-gray-800 dark:text-white">${uniqueEmployees}</p>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card glass-card rounded-xl p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#ffb900] to-[#e6a400] flex items-center justify-center">
                            <i class="fas fa-calendar-day text-white"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">Rata-rata/Hari</p>
                            <p class="text-xl font-bold text-gray-800 dark:text-white">${avgPerDay}</p>
                        </div>
                    </div>
                </div>
                
                <div class="stat-card glass-card rounded-xl p-4">
                    <div class="flex items-center space-x-3">
                        <div class="w-10 h-10 rounded-lg bg-gradient-to-br from-[#8b5cf6] to-[#7c3aed] flex items-center justify-center">
                            <i class="fas fa-percentage text-white"></i>
                        </div>
                        <div>
                            <p class="text-sm text-gray-600 dark:text-gray-400">% Sukses</p>
                            <p class="text-xl font-bold text-gray-800 dark:text-white">${successRate}%</p>
                        </div>
                    </div>
                </div>
            `;

            document.getElementById('analytics-stats').innerHTML = statsHtml;
        }

        // Load department analytics
        async function loadDepartmentAnalytics(period) {
            const daysAgo = getDateNDaysAgo(parseInt(period));
            
            const { data: employees, error: empError } = await supabaseClient
                .from(TABLE_NAME)
                .select('*');

            const { data: logs, error: logError } = await supabaseClient
                .from(LOG_TABLE_NAME)
                .select('*')
                .gte('created_at', daysAgo);

            if (empError || logError) {
                console.error("Error loading department analytics:", empError || logError);
                return;
            }

            // Group employees by department
            const deptEmployees = {};
            employees.forEach(emp => {
                if (!deptEmployees[emp.departemen]) {
                    deptEmployees[emp.departemen] = [];
                }
                deptEmployees[emp.departemen].push(emp.card);
            });

            // Calculate stats per department
            const deptStats = [];
            Object.keys(deptEmployees).forEach(dept => {
                const employeeCards = deptEmployees[dept];
                const deptLogs = logs.filter(log => 
                    log.status === 'Sukses' && 
                    employeeCards.includes(log.card)
                );
                
                const uniqueDays = [...new Set(deptLogs.map(log => {
                    const date = new Date(log.created_at);
                    return date.toISOString().split('T')[0];
                }))].length;
                
                const avgPerDay = uniqueDays > 0 ? (deptLogs.length / uniqueDays).toFixed(1) : 0;
                const attendanceRate = employeeCards.length > 0 ? 
                    ((deptLogs.length / (employeeCards.length * uniqueDays)) * 100).toFixed(1) : 0;

                deptStats.push({
                    department: dept,
                    totalEmployees: employeeCards.length,
                    totalAttendance: deptLogs.length,
                    avgAttendance: avgPerDay,
                    attendanceRate: attendanceRate
                });
            });

            // Sort by attendance rate
            deptStats.sort((a, b) => b.attendanceRate - a.attendanceRate);

            // Update table
            const tbody = document.getElementById('department-analytics-body');
            tbody.innerHTML = '';

            deptStats.forEach(stat => {
                const row = tbody.insertRow();
                row.className = 'border-b border-gray-100 dark:border-gray-800 last:border-0';
                row.innerHTML = `
                    <td class="py-3">
                        <span class="font-medium">${stat.department}</span>
                    </td>
                    <td class="py-3">
                        <span class="px-2 py-1 bg-blue-100 dark:bg-blue-900/30 text-blue-800 dark:text-blue-300 rounded text-sm">
                            ${stat.totalEmployees} orang
                        </span>
                    </td>
                    <td class="py-3">
                        <span class="px-2 py-1 bg-emerald-100 dark:bg-emerald-900/30 text-emerald-800 dark:text-emerald-300 rounded text-sm">
                            ${stat.totalAttendance}
                        </span>
                    </td>
                    <td class="py-3">
                        <span class="px-2 py-1 bg-amber-100 dark:bg-amber-900/30 text-amber-800 dark:text-amber-300 rounded text-sm">
                            ${stat.avgAttendance}
                        </span>
                    </td>
                    <td class="py-3">
                        <div class="flex items-center">
                            <div class="w-24 bg-gray-200 dark:bg-gray-700 rounded-full h-2 mr-3">
                                <div class="bg-[#0073aa] h-2 rounded-full" style="width: ${Math.min(stat.attendanceRate, 100)}%"></div>
                            </div>
                            <span class="text-sm font-medium">${stat.attendanceRate}%</span>
                        </div>
                    </td>
                `;
            });
        }

        // Load laporan charts
        async function loadLaporanCharts(period) {
            const daysAgo = getDateNDaysAgo(parseInt(period));
            
            const { data: logs, error } = await supabaseClient
                .from(LOG_TABLE_NAME)
                .select('*')
                .gte('created_at', daysAgo);

            if (error) {
                console.error("Error loading laporan charts:", error);
                return;
            }

            // Destroy existing charts
            if (attendanceTrendChart) attendanceTrendChart.destroy();
            if (statusDistributionChart) statusDistributionChart.destroy();

            // Prepare data for trend chart
            const dailyData = {};
            logs.forEach(log => {
                const date = new Date(log.created_at).toLocaleDateString('id-ID', { 
                    day: 'numeric', 
                    month: 'short' 
                });
                if (!dailyData[date]) dailyData[date] = { total: 0, success: 0, kantin: 0 };
                dailyData[date].total++;
                if (log.status === 'Sukses') {
                    dailyData[date].success++;
                    if (log.periode && ['pagi', 'siang', 'sore', 'malam'].includes(log.periode.toLowerCase())) {
                        dailyData[date].kantin++;
                    }
                }
            });

            const dates = Object.keys(dailyData);
            const totalData = dates.map(date => dailyData[date].total);
            const successData = dates.map(date => dailyData[date].success);
            const kantinData = dates.map(date => dailyData[date].kantin);

            // Create trend chart
            const trendCtx = document.getElementById('attendanceTrendChart').getContext('2d');
            attendanceTrendChart = new Chart(trendCtx, {
                type: 'line',
                data: {
                    labels: dates,
                    datasets: [
                        {
                            label: 'Total Tapping',
                            data: totalData,
                            borderColor: '#0073aa',
                            backgroundColor: 'rgba(0, 115, 170, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Sukses',
                            data: successData,
                            borderColor: '#46b450',
                            backgroundColor: 'rgba(70, 180, 80, 0.1)',
                            tension: 0.4,
                            fill: true
                        },
                        {
                            label: 'Makan di Kantin',
                            data: kantinData,
                            borderColor: '#8b5cf6',
                            backgroundColor: 'rgba(139, 92, 246, 0.1)',
                            tension: 0.4,
                            fill: true
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            labels: {
                                color: currentTheme === 'dark' ? '#e4e6eb' : '#23282d'
                            }
                        }
                    },
                    scales: {
                        x: {
                            grid: {
                                color: currentTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: currentTheme === 'dark' ? '#94a3b8' : '#64748b'
                            }
                        },
                        y: {
                            beginAtZero: true,
                            grid: {
                                color: currentTheme === 'dark' ? 'rgba(255, 255, 255, 0.1)' : 'rgba(0, 0, 0, 0.1)'
                            },
                            ticks: {
                                color: currentTheme === 'dark' ? '#94a3b8' : '#64748b'
                            }
                        }
                    }
                }
            });

            // Prepare data for status distribution
            const successCount = logs.filter(log => log.status === 'Sukses').length;
            const failedCount = logs.length - successCount;

            // Create distribution chart
            const distCtx = document.getElementById('statusDistributionChart').getContext('2d');
            statusDistributionChart = new Chart(distCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Sukses', 'Gagal'],
                    datasets: [{
                        data: [successCount, failedCount],
                        backgroundColor: ['#46b450', '#dc3232'],
                        borderWidth: 2,
                        borderColor: currentTheme === 'dark' ? '#2c3138' : '#ffffff'
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: {
                            position: 'bottom',
                            labels: {
                                color: currentTheme === 'dark' ? '#e4e6eb' : '#23282d',
                                padding: 20
                            }
                        }
                    }
                }
            });
        }

        // Load insights
        async function loadInsights(period) {
            const daysAgo = getDateNDaysAgo(parseInt(period));
            
            const { data: logs, error: logError } = await supabaseClient
                .from(LOG_TABLE_NAME)
                .select('*')
                .gte('created_at', daysAgo);

            const { data: employees, error: empError } = await supabaseClient
                .from(TABLE_NAME)
                .select('*');

            if (logError || empError) {
                console.error("Error loading insights:", logError || empError);
                return;
            }

            const totalLogs = logs.length;
            const successLogs = logs.filter(log => log.status === 'Sukses').length;
            const kantinLogs = logs.filter(log => 
                log.status === 'Sukses' && 
                log.periode && 
                ['pagi', 'siang', 'sore', 'malam'].includes(log.periode.toLowerCase())
            ).length;
            
            const successRate = totalLogs > 0 ? (successLogs / totalLogs * 100).toFixed(1) : 0;
            const kantinRate = successLogs > 0 ? (kantinLogs / successLogs * 100).toFixed(1) : 0;

            // Get busiest period
            const periodCounts = { pagi: 0, siang: 0, sore: 0, malam: 0 };
            logs.forEach(log => {
                if (log.periode && periodCounts.hasOwnProperty(log.periode.toLowerCase())) {
                    periodCounts[log.periode.toLowerCase()]++;
                }
            });

            const busiestPeriod = Object.keys(periodCounts).reduce((a, b) => 
                periodCounts[a] > periodCounts[b] ? a : b
            );

            // Get average taps per day
            const uniqueDays = [...new Set(logs.map(log => {
                const date = new Date(log.created_at);
                return date.toISOString().split('T')[0];
            }))].length;
            const avgPerDay = uniqueDays > 0 ? (totalLogs / uniqueDays).toFixed(1) : 0;

            const insights = document.getElementById('insights-container');
            insights.innerHTML = `
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="p-4 bg-gradient-to-r from-blue-50 to-indigo-50 dark:from-blue-900/20 dark:to-indigo-900/20 rounded-xl border border-blue-200 dark:border-blue-800">
                        <div class="flex items-start">
                            <div class="w-10 h-10 rounded-lg bg-blue-100 dark:bg-blue-900/30 flex items-center justify-center mr-3">
                                <i class="fas fa-chart-line text-blue-600 dark:text-blue-400"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800 dark:text-white mb-1">Tren Harian</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                    Rata-rata <span class="font-bold">${avgPerDay}</span> aktivitas per hari dalam ${period} hari terakhir.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-emerald-900/20 dark:to-teal-900/20 rounded-xl border border-emerald-200 dark:border-emerald-800">
                        <div class="flex items-start">
                            <div class="w-10 h-10 rounded-lg bg-emerald-100 dark:bg-emerald-900/30 flex items-center justify-center mr-3">
                                <i class="fas fa-percentage text-emerald-600 dark:text-emerald-400"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800 dark:text-white mb-1">Tingkat Keberhasilan</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                    <span class="font-bold">${successRate}%</span> tapping berhasil dengan <span class="font-bold">${kantinRate}%</span> diantaranya makan di kantin.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gradient-to-r from-amber-50 to-orange-50 dark:from-amber-900/20 dark:to-orange-900/20 rounded-xl border border-amber-200 dark:border-amber-800">
                        <div class="flex items-start">
                            <div class="w-10 h-10 rounded-lg bg-amber-100 dark:bg-amber-900/30 flex items-center justify-center mr-3">
                                <i class="fas fa-clock text-amber-600 dark:text-amber-400"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800 dark:text-white mb-1">Waktu Sibuk</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                    Periode <span class="font-bold">${busiestPeriod}</span> memiliki aktivitas tertinggi. Pertimbangkan untuk menambah kapasitas.
                                </p>
                            </div>
                        </div>
                    </div>
                    
                    <div class="p-4 bg-gradient-to-r from-purple-50 to-pink-50 dark:from-purple-900/20 dark:to-pink-900/20 rounded-xl border border-purple-200 dark:border-purple-800">
                        <div class="flex items-start">
                            <div class="w-10 h-10 rounded-lg bg-purple-100 dark:bg-purple-900/30 flex items-center justify-center mr-3">
                                <i class="fas fa-lightbulb text-purple-600 dark:text-purple-400"></i>
                            </div>
                            <div>
                                <h4 class="font-medium text-gray-800 dark:text-white mb-1">Rekomendasi</h4>
                                <p class="text-sm text-gray-600 dark:text-gray-400">
                                    ${successRate < 90 ? 'Tingkatkan validasi data karyawan untuk mengurangi kegagalan.' : 'Sistem bekerja dengan optimal.'}
                                </p>
                            </div>
                        </div>
                    </div>
                </div>
            `;
        }

        // Generate report
        async function generateReport() {
            showGlobalMessage('Membuat laporan, harap tunggu...', 'info');
            
            // Simulate report generation
            setTimeout(() => {
                showGlobalMessage('Laporan berhasil dibuat!', 'success');
            }, 2000);
        }

        // CRUD Modal functions
        async function openFormModal(mode, cardId = null) {
            currentMode = mode;
            const modal = document.getElementById('form-modal');
            
            const formCard = document.getElementById('form-card');
            const formNik = document.getElementById('form-nik');
            const formNama = document.getElementById('form-nama');
            const formDepartemen = document.getElementById('form-departemen');
            const formPagi = document.getElementById('form-pagi');
            const formSiang = document.getElementById('form-siang');
            const formSore = document.getElementById('form-sore');
            const formMalam = document.getElementById('form-malam');

            document.getElementById('crud-form').reset();
            
            if (mode === 'create') {
                document.getElementById('modal-title').textContent = 'Tambah Karyawan Baru';
                document.getElementById('submit-button').innerHTML = '<i class="fas fa-save mr-2"></i>Simpan Data';
                formCard.disabled = false;
            } else {
                document.getElementById('modal-title').textContent = 'Edit Data Karyawan';
                document.getElementById('submit-button').innerHTML = '<i class="fas fa-save mr-2"></i>Update Data';
                formCard.value = cardId;
                formCard.disabled = true;

                const { data, error } = await supabaseClient
                    .from(TABLE_NAME)
                    .select('*')
                    .eq('card', cardId)
                    .single();

                if (error || !data) {
                    showGlobalMessage('Gagal memuat data untuk diedit.', 'error');
                    closeFormModal();
                    return;
                }

                formNik.value = data.nik;
                formNama.value = data.nama;
                formDepartemen.value = data.departemen;
                formPagi.value = data.pagi || '';
                formSiang.value = data.siang || '';
                formSore.value = data.sore || '';
                formMalam.value = data.malam || '';
            }

            modal.classList.remove('hidden');
        }

        function closeFormModal() {
            document.getElementById('form-modal').classList.add('hidden');
        }

        async function handleFormSubmit(event) {
            event.preventDefault();

            const card = document.getElementById('form-card').value.trim();
            const nik = document.getElementById('form-nik').value.trim();
            const nama = document.getElementById('form-nama').value.trim();
            const departemen = document.getElementById('form-departemen').value.trim();
            const pagi = document.getElementById('form-pagi').value.trim();
            const siang = document.getElementById('form-siang').value.trim();
            const sore = document.getElementById('form-sore').value.trim();
            const malam = document.getElementById('form-malam').value.trim();

            let error;
            let message;

            if (currentMode === 'create') {
                const payload = { card, nik, nama, departemen, pagi, siang, sore, malam };
                const result = await supabaseClient.from(TABLE_NAME).insert([payload]);
                error = result.error;
                message = 'Data karyawan berhasil ditambahkan.';
            } else {
                const updateData = { 
                    nik, nama, departemen, pagi, siang, sore, malam 
                };
                
                const result = await supabaseClient
                    .from(TABLE_NAME)
                    .update(updateData)
                    .eq('card', card);
                    
                error = result.error;
                message = 'Data karyawan berhasil diupdate.';
            }

            if (error) {
                console.error("CRUD Error:", error);
                const errorMessage = error.code === '23505' ? 'Card ID sudah terdaftar.' : error.message;
                showGlobalMessage(`Gagal: ${errorMessage}`, 'error');
            } else {
                showGlobalMessage(message, 'success');
                closeFormModal();
                fetchData();
                if (currentView === 'dashboard') {
                    loadDashboardStats();
                } else if (currentView === 'karyawan') {
                    loadEmployeeStatsView();
                }
            }
        }

        // Delete modal functions
        function openDeleteModal(cardId) {
            cardIdToDelete = cardId;
            document.getElementById('delete-card-id').textContent = cardId;
            document.getElementById('delete-modal').classList.remove('hidden');
        }

        function closeDeleteModal() {
            document.getElementById('delete-modal').classList.add('hidden');
            cardIdToDelete = null;
        }

        async function executeDelete() {
            if (!cardIdToDelete) return;
            const { error } = await supabaseClient.from(TABLE_NAME).delete().eq('card', cardIdToDelete);

            if (error) {
                console.error("Delete Error:", error);
                showGlobalMessage('Gagal menghapus data karyawan.', 'error');
            } else {
                showGlobalMessage('Data karyawan berhasil dihapus.', 'success');
                fetchData();
                if (currentView === 'dashboard') {
                    loadDashboardStats();
                } else if (currentView === 'karyawan') {
                    loadEmployeeStatsView();
                }
            }
            closeDeleteModal();
        }

        // Import modal functions
        function openImportModal() {
            document.getElementById('excel-file-input').value = '';
            const existingFile = document.querySelector('.file-name');
            if (existingFile) existingFile.remove();
            
            document.getElementById('step-upload').classList.remove('hidden');
            document.getElementById('step-review').classList.add('hidden');
            document.getElementById('review-button').classList.remove('hidden');
            document.getElementById('import-submit-button').classList.add('hidden');
            parsedImportData = [];
            activeCardIds = [];
            
            document.getElementById('import-modal').classList.remove('hidden');
        }

        function closeImportModal() {
            document.getElementById('import-modal').classList.add('hidden');
        }

        function parseExcelFile() {
            const fileInput = document.getElementById('excel-file-input');
            const file = fileInput.files[0];

            if (!file) {
                showGlobalMessage('Pilih file Excel terlebih dahulu.', 'error');
                return;
            }

            document.getElementById('review-button').disabled = true;
            document.getElementById('review-button').innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Memproses...';

            const reader = new FileReader();
            reader.onload = function(e) {
                const data = new Uint8Array(e.target.result);
                const workbook = XLSX.read(data, { type: 'array' });
                const firstSheetName = workbook.SheetNames[0];
                const worksheet = workbook.Sheets[firstSheetName];
                const excelData = XLSX.utils.sheet_to_json(worksheet, { header: 1 });
                
                processExcelData(excelData);

                document.getElementById('review-button').disabled = false;
                document.getElementById('review-button').innerHTML = '<i class="fas fa-eye mr-2"></i>Review Data';
            };

            reader.onerror = function(ex) {
                showGlobalMessage('Gagal membaca file Excel.', 'error');
                document.getElementById('review-button').disabled = false;
                document.getElementById('review-button').innerHTML = '<i class="fas fa-eye mr-2"></i>Review Data';
            };
            reader.readAsArrayBuffer(file);
        }

        function processExcelData(data) {
            parsedImportData = [];
            activeCardIds = [];
            const reviewBody = document.getElementById('step-review');
            reviewBody.innerHTML = '';
            
            if (data.length < 2) {
                showGlobalMessage('File Excel kosong atau hanya berisi header.', 'error');
                return;
            }

            const rawHeaders = data[0].map(h => String(h).trim());
            const headerMap = {};
            REQUIRED_HEADERS.forEach(requiredHeader => {
                const index = rawHeaders.findIndex(h => h.toLowerCase() === requiredHeader.toLowerCase());
                if (index !== -1) {
                    headerMap[requiredHeader.toLowerCase()] = index;
                }
            });

            const requiredFields = ['card id', 'nik', 'nama', 'departemen', 'pagi', 'siang', 'sore', 'malam'];
            const missingFields = requiredFields.filter(field => typeof headerMap[field] === 'undefined');
            
            if (missingFields.length > 0) {
                showGlobalMessage(`Kolom wajib tidak ditemukan: ${missingFields.join(', ')}`, 'error');
                return;
            }

            const cardIndex = headerMap['card id'];
            let validCount = 0;
            let skippedCount = 0;

            let tableHtml = `
                <div class="space-y-6">
                    <div class="p-6 bg-gradient-to-r from-emerald-50 to-teal-50 dark:from-emerald-900/20 dark:to-teal-900/20 rounded-xl border border-emerald-200 dark:border-emerald-800">
                        <h4 class="text-lg font-semibold text-gray-800 dark:text-white mb-4">
                            <i class="fas fa-clipboard-check mr-2 text-emerald-500"></i>
                            Review Data Import
                        </h4>
                        
                        <div class="overflow-x-auto border border-gray-200 dark:border-gray-700 rounded-lg max-h-96">
                            <table class="w-full text-sm">
                                <thead class="bg-gray-50 dark:bg-gray-800">
                                    <tr>
                                        <th class="px-4 py-3 text-left font-semibold">Card ID</th>
                                        <th class="px-4 py-3 text-left font-semibold">NIK</th>
                                        <th class="px-4 py-3 text-left font-semibold">Nama</th>
                                        <th class="px-4 py-3 text-left font-semibold">Departemen</th>
                                        <th class="px-4 py-3 text-left font-semibold">Status</th>
                                    </tr>
                                </thead>
                                <tbody class="divide-y divide-gray-200 dark:divide-gray-700">
            `;

            for (let i = 1; i < data.length; i++) {
                const row = data[i];
                let status = 'Valid';
                let cardId = String(row[cardIndex] || '').trim();

                if (!cardId) {
                    status = 'Card ID Kosong';
                    skippedCount++;
                } else if (activeCardIds.includes(cardId)) {
                    status = 'Duplikat';
                    skippedCount++;
                } else {
                    const payload = {
                        card: cardId,
                        nik: (row[headerMap['nik']] || '').toString().trim(),
                        nama: (row[headerMap['nama']] || '').toString().trim(),
                        departemen: (row[headerMap['departemen']] || '').toString().trim(),
                        pagi: (row[headerMap['pagi']] || '').toString().trim(),
                        siang: (row[headerMap['siang']] || '').toString().trim(),
                        sore: (row[headerMap['sore']] || '').toString().trim(),
                        malam: (row[headerMap['malam']] || '').toString().trim(),
                    };
                    
                    parsedImportData.push(payload);
                    activeCardIds.push(cardId);
                    validCount++;
                }

                const statusClass = status === 'Valid' ? 'badge-success' : 'badge-error';
                tableHtml += `
                    <tr>
                        <td class="px-4 py-3 font-mono">${cardId || '-'}</td>
                        <td class="px-4 py-3">${(row[headerMap['nik']] || '').toString().trim()}</td>
                        <td class="px-4 py-3">${(row[headerMap['nama']] || '').toString().trim()}</td>
                        <td class="px-4 py-3">${(row[headerMap['departemen']] || '').toString().trim()}</td>
                        <td class="px-4 py-3">
                            <span class="${statusClass}">${status}</span>
                        </td>
                    </tr>
                `;
            }

            tableHtml += `
                                </tbody>
                            </table>
                        </div>
                        
                        <div class="mt-4 p-4 bg-amber-50 dark:bg-amber-900/20 border border-amber-200 dark:border-amber-800 rounded-lg">
                            <div class="flex items-start">
                                <i class="fas fa-exclamation-circle text-amber-500 mt-1 mr-3"></i>
                                <div>
                                    <p class="text-sm font-semibold text-amber-700 dark:text-amber-400">
                                        Ditemukan ${data.length - 1} baris data. ${validCount} valid, ${skippedCount} dilewati.
                                    </p>
                                    <p class="text-xs text-amber-600 dark:text-amber-300 mt-1">
                                        Pastikan data sudah benar sebelum melanjutkan. Proses import akan mengganti semua data yang ada.
                                    </p>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            `;

            reviewBody.innerHTML = tableHtml;

            if (validCount > 0) {
                document.getElementById('step-upload').classList.add('hidden');
                document.getElementById('step-review').classList.remove('hidden');
                document.getElementById('review-button').classList.add('hidden');
                document.getElementById('import-submit-button').classList.remove('hidden');
                document.getElementById('import-submit-button').disabled = false;
            } else {
                document.getElementById('import-submit-button').disabled = true;
                showGlobalMessage('Tidak ada data valid yang ditemukan.', 'error');
            }
        }

        async function handleImportSubmit(event) {
            event.preventDefault();
            
            if (parsedImportData.length === 0) {
                showGlobalMessage('Tidak ada data valid untuk diimport.', 'error');
                return;
            }
            
            const submitButton = document.getElementById('import-submit-button');
            submitButton.disabled = true;
            submitButton.innerHTML = '<i class="fas fa-spinner fa-spin mr-2"></i>Memproses...';
            
            try {
                // First, delete all existing data
                const { error: deleteError } = await supabaseClient
                    .from(TABLE_NAME)
                    .delete()
                    .neq('card', '0');

                if (deleteError) {
                    throw new Error(`Gagal menghapus data lama: ${deleteError.message}`);
                }

                // Then insert new data
                const { error: insertError } = await supabaseClient
                    .from(TABLE_NAME)
                    .insert(parsedImportData);

                if (insertError) {
                    throw new Error(`Gagal menyimpan data baru: ${insertError.message}`);
                }

                showGlobalMessage(`Berhasil mengimport ${parsedImportData.length} data karyawan.`, 'success');
                closeImportModal();
                
                // Refresh current view
                switch(currentView) {
                    case 'dashboard':
                        loadDashboard();
                        break;
                    case 'karyawan':
                        loadKaryawan();
                        break;
                    case 'absensi':
                        loadAbsensi();
                        break;
                    case 'laporan':
                        loadLaporan();
                        break;
                }
                
            } catch (error) {
                console.error("Import Error:", error);
                showGlobalMessage(`Gagal mengimport data: ${error.message}`, 'error');
            } finally {
                submitButton.disabled = false;
                submitButton.innerHTML = '<i class="fas fa-check mr-2"></i>Proses Import';
            }
        }

        // Format time helper
        function formatTime(textValue) {
            if (!textValue) return '-';
            return String(textValue).trim() || '-';
        }

        // Format number helper
        function formatNumber(num) {
            return new Intl.NumberFormat('id-ID').format(num);
        }
    </script>
</body>
</html>
